<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>نظام البونص الاحترافي V14 - إصلاح عرض الآجلة والمرتجعات</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
    :root{--p:#2c3e50; --acc:#2980b9; --bg:#f4f6f9; --g:#27ae60; --r:#c0392b; --w:#f39c12;}
    body{font-family:'Cairo', sans-serif; background:var(--bg); padding:20px; color: var(--p);}
    .box{background:#fff;padding:0;border-radius:15px;max-width:1400px;margin:auto;box-shadow: 0 4px 20px rgba(0,0,0,0.05); overflow: hidden;}
    
    /* Tabs */
    .tabs-header {display: flex; background: var(--p); color: #fff;}
    .tab-btn {padding: 15px 25px; cursor: pointer; background: transparent; border: none; color: #ccc; font-family: 'Cairo'; font-weight: bold; font-size: 1.1em; transition: 0.3s;}
    .tab-btn:hover {color: #fff; background: rgba(255,255,255,0.1);}
    .tab-btn.active {background: #fff; color: var(--p); border-top: 4px solid var(--acc);}
    .tab-content {display: none; padding: 20px;}
    .tab-content.active {display: block;}

    /* Inputs & Buttons */
    .input-grp {margin-bottom: 10px;}
    .input-grp label {display: block; font-weight: bold; font-size: 0.85em; margin-bottom: 5px;}
    .input-grp input, .input-grp select {padding: 8px; border: 1px solid #ccc; border-radius: 5px; width: 200px; font-family: 'Cairo';}
    
    .calc-btn {background: var(--acc); color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; font-family: 'Cairo'; transition: 0.3s;}
    .calc-btn:hover {background: #1a5276;}
    .calc-btn:disabled {background: #bdc3c7; cursor: not-allowed;}

    .save-btn {background: var(--g); color: #fff; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-family: 'Cairo';}
    
    .exclude-btn {background: #fff; color: var(--r); border: 1px solid var(--r); padding: 4px 8px; font-size: 0.8em; cursor: pointer; border-radius: 4px; transition: 0.2s;}
    .exclude-btn:hover {background: var(--r); color: #fff;}
    .exclude-btn.active {background: var(--r); color: #fff;}

    .restore-btn {background: var(--g); color: #fff; border: none; padding: 4px 8px; font-size: 0.8em; cursor: pointer; border-radius: 4px;}

    /* Tables */
    table {width: 100%; border-collapse: collapse; min-width: 1000px;}
    th {background: #f8f9fa; padding: 12px; text-align: right; border-bottom: 2px solid #ddd; position: sticky; top: 0; z-index: 10;}
    td {padding: 10px 12px; border-bottom: 1px solid #eee; vertical-align: middle;}
    .table-responsive {overflow-x: auto; max-height: 600px;}

    .tbl-input {width: 80px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-family: 'Cairo';}
    
    /* Badges */
    .badge {padding: 4px 10px; border-radius: 12px; font-size: 0.8em; font-weight: bold; display: inline-block;}
    .badge-premium {background: #d4edda; color: #155724; border: 1px solid #c3e6cb;} 
    .badge-base {background: #fff3cd; color: #856404; border: 1px solid #ffeeba;} 
    .badge-low {background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;}
    .badge-pending {background: #e2e3e5; color: #383d41; border: 1px solid #d6d8db;}
    
    /* Stats Cards */
    .stats {display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;}
    .card {background: var(--p); color: #fff; padding: 20px; border-radius: 10px; flex: 1; text-align: center; min-width: 200px;}
    .card h3 {margin: 0 0 10px 0; font-size: 1em; opacity: 0.9;}
    .card-val {font-size: 1.8em; font-weight: bold;}
    
    /* Alert Box */
    .alert-box {background:#eafaf1; padding:15px; border-radius:8px; border:1px solid #abdde5; color:#2c3e50; margin-bottom: 15px; font-size: 0.95em;}
</style>
</head>
<body>

<div class="box">
    <div class="tabs-header">
        <button class="tab-btn active" onclick="switchTab('main')"><i class="fas fa-wallet"></i> البونص المستحق</button>
        <button class="tab-btn" onclick="switchTab('suspended')"><i class="fas fa-pause-circle"></i> المعلق (الآجل)</button>
        <button class="tab-btn" onclick="switchTab('returns')"><i class="fas fa-undo"></i> المرتجعات</button>
        <button class="tab-btn" onclick="switchTab('products')"><i class="fas fa-tags"></i> إعدادات الأسعار</button>
        <button class="tab-btn" onclick="switchTab('targets')"><i class="fas fa-bullseye"></i> التارجت</button>
    </div>

    <div id="tab-main" class="tab-content active">
        <div style="display:flex; gap:15px; align-items:flex-end; margin-bottom:20px; flex-wrap:wrap; background: #f8f9fa; padding: 15px; border-radius: 10px;">
            <div class="input-grp">
                <label>الشهر المستهدف</label>
                <input type="month" id="targetMonth">
            </div>
            <div class="input-grp">
                <label>تصفية بالمندوب</label>
                <select id="creatorFilter" onchange="renderMainTable()"><option value="all">الكل</option></select>
            </div>
            <button onclick="fetchAndCalculate()" class="calc-btn"><i class="fas fa-sync-alt"></i> جلب وحساب</button>
            <button onclick="exportToExcel()" class="save-btn" style="background:#27ae60"><i class="fas fa-file-excel"></i> تصدير التقرير</button>
        </div>

        <div class="stats">
            <div class="card"><h3>المبيعات المحققة</h3><div id="stat-sales" class="card-val">0</div></div>
            <div class="card" style="background:var(--acc)"><h3>صافي البونص</h3><div id="stat-bonus" class="card-val">0</div></div>
            <div class="card" style="background:#e67e22"><h3>حالة التارجت</h3><div id="stat-target" class="card-val" style="font-size:1.2em">-</div></div>
        </div>

        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>إجراء</th>
                        <th>المرجع</th>
                        <th>المندوب</th>
                        <th>المنتج</th>
                        <th>الكمية</th>
                        <th>سعر البيع</th>
                        <th>الشريحة</th>
                        <th>النسبة</th>
                        <th>البونص</th>
                    </tr>
                </thead>
                <tbody id="mainRows"><tr><td colspan="9" style="text-align:center; padding: 20px;">اختر الشهر ثم اضغط "جلب وحساب"</td></tr></tbody>
            </table>
        </div>
    </div>

    <div id="tab-suspended" class="tab-content">
        <div class="alert-box" style="background:#fff3cd; color:#856404; border-color:#ffeeba;">
            <i class="fas fa-info-circle"></i> <strong>قائمة الانتظار:</strong>
            هذه الفواتير (آجلة غير مسددة) أو (مستثناة يدوياً). لن يتم صرف البونص الخاص بها حتى تتحول حالتها إلى <b>Paid</b> أو تلغي استثنائها.
        </div>
        <div class="stats">
            <div class="card" style="background:#7f8c8d; max-width: 300px;">
                <h3>بونص تحت التحصيل</h3>
                <div id="stat-suspended-bonus" class="card-val">0.00</div>
            </div>
            <div class="card" style="background:#c0392b; max-width: 300px;">
                <h3>فواتير آجلة غير مدفوعة</h3>
                <div id="stat-delayed-count" class="card-val">0</div>
            </div>
            <div class="card" style="background:#27ae60; max-width: 300px;">
                <h3>فواتير آجلة مدفوعة</h3>
                <div id="stat-delayed-paid" class="card-val">0</div>
            </div>
        </div>

        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>تحكم</th>
                        <th>المرجع</th>
                        <th>المندوب</th>
                        <th>المنتج</th>
                        <th>سبب التعليق</th>
                        <th>البونص المتوقع</th>
                    </tr>
                </thead>
                <tbody id="suspendedRows"><tr><td colspan="6" style="text-align:center">لا توجد فواتير معلقة</td></tr></tbody>
            </table>
        </div>
    </div>

    <div id="tab-returns" class="tab-content">
        <div class="alert-box" style="background:#fff3cd; color:#856404; border-color:#ffeeba;">
            <i class="fas fa-info-circle"></i> <strong>المرتجعات:</strong>
            هذه الفواتير لها إشعارات دائن (Credit Notes) مربوطة بها. النظام يخصم المرتجعات تلقائياً من العمولات.
        </div>
        <div class="stats">
            <div class="card" style="background:#c0392b; max-width: 300px;">
                <h3>إجمالي المرتجعات</h3>
                <div id="stat-returns-amount" class="card-val">0.00 ريال</div>
            </div>
            <div class="card" style="background:#e67e22; max-width: 300px;">
                <h3>عدد الفواتير المتأثرة</h3>
                <div id="stat-returns-count" class="card-val">0</div>
            </div>
        </div>

        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>المرجع</th>
                        <th>المندوب</th>
                        <th>مبلغ الإشعار الدائن</th>
                        <th>إجمالي الفاتورة</th>
                        <th>نسبة المرتجع</th>
                        <th>تاريخ الإشعار</th>
                    </tr>
                </thead>
                <tbody id="returnsRows"><tr><td colspan="6" style="text-align:center">لا توجد مرتجعات</td></tr></tbody>
            </table>
        </div>
    </div>

    <div id="tab-products" class="tab-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; flex-wrap:wrap; gap:10px;">
            <h3><i class="fas fa-sliders-h"></i> شرائح الأسعار والكرتون</h3>
            <div style="display:flex; gap:10px;">
                <button onclick="saveProductSettings()" class="save-btn"><i class="fas fa-save"></i> حفظ الإعدادات</button>
                <button onclick="exportSettings()" class="save-btn" style="background:#e67e22"><i class="fas fa-download"></i> تصدير</button>
                <button onclick="importSettings()" class="save-btn" style="background:#8e44ad"><i class="fas fa-upload"></i> استيراد</button>
            </div>
        </div>
        <div class="alert-box">
            <i class="fas fa-lightbulb"></i> <strong>الدليل:</strong><br>
            1. <b>معامل الكرتون:</b> إذا تم جلبه من قيود سيظهر، وإلا ضعه يدوياً.<br>
            2. <b>سعر التميز:</b> السعر الذي يستحق النسبة العالية (مثلاً 73).<br>
            3. <b>السعر الأساسي:</b> أقل سعر مقبول للنسبة العادية (مثلاً 70).
        </div>
        <div class="table-responsive">
            <table id="productsTable">
                <thead>
                    <tr>
                        <th style="width:25%">المنتج</th>
                        <th style="background:#fffcf5">حبة بالكرتون</th>
                        <th style="background:#d4edda; border-bottom: 2px solid #27ae60">سعر التميز (الأعلى)</th>
                        <th>نسبة %</th>
                        <th style="background:#eee; border-bottom: 2px solid #bdc3c7">السعر الأساسي (الأقل)</th>
                        <th>نسبة %</th>
                    </tr>
                </thead>
                <tbody id="productRows"><tr><td colspan="6" style="text-align:center">انتظار البيانات...</td></tr></tbody>
            </table>
        </div>
    </div>

    <div id="tab-targets" class="tab-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <h3><i class="fas fa-users-cog"></i> أهداف المناديب</h3>
            <button onclick="saveTargetSettings()" class="save-btn"><i class="fas fa-save"></i> حفظ التارجت</button>
        </div>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>المندوب</th>
                        <th>المبيعات المعتمدة</th>
                        <th style="background:#eafaf1">هدف المبيعات</th>
                        <th style="background:#eafaf1">مكافأة إضافية</th>
                        <th style="background:#fdeaea; color:#c0392b">تفعيل الحجب؟</th>
                        <th>الحالة</th>
                    </tr>
                </thead>
                <tbody id="targetRows"><tr><td colspan="6" style="text-align:center">انتظار البيانات...</td></tr></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // --- ثوابت وإعدادات ---
    const DELAYED_SKU = "754500950512"; // كود خدمة الآجل (إذا وجد)
    const DELAYED_KEYWORD = "آجلة";     // كلمة مفتاحية للآجل
    
    // --- مخزن البيانات ---
    let rawInvoices = []; 
    let productsMap = {}; 
    let unitsMap = {}; // وحدات قيود
    let creditNotesMap = {}; // إشعارات الدائن (المرتجعات) - مفهرسة حسب invoice_id
    let computedData = [];   // الفواتير المستحقة
    let suspendedData = [];  // الفواتير المعلقة
    let creatorsList = [];   // قائمة المناديب
    
    // --- استرجاع الإعدادات المحفوظة (V8) ---
    let productRules = JSON.parse(localStorage.getItem('productRules_v8') || "{}");
    let targetRules = JSON.parse(localStorage.getItem('targetRules_v8') || "{}");
    let manualExclusions = JSON.parse(localStorage.getItem('manualExclusions_v8') || "[]");
    let invoiceTransfers = JSON.parse(localStorage.getItem('invoiceTransfers_v8') || "{}"); // التحسين المتوسط 2: نقل الفواتير

    // --- عند التحميل ---
    window.onload = () => {
        // تحديد الشهر الحالي افتراضياً
        const now = new Date();
        const monthStr = now.toISOString().slice(0, 7); // YYYY-MM
        document.getElementById('targetMonth').value = monthStr;
        
        // محاولة رسم الجداول إذا كانت البيانات موجودة في الذاكرة (اختياري)
        if(Object.keys(productRules).length > 0) renderProductSettings();
    }

    // --- التنقل بين التبويبات ---
    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + id).classList.add('active');
        document.querySelector(`button[onclick="switchTab('${id}')"]`).classList.add('active');
    }

    // --- 1. جلب البيانات من السيرفر ---
    async function fetchAndCalculate() {
        const btn = document.querySelector('.calc-btn');
        const monthInput = document.getElementById('targetMonth').value;

        if (!monthInput) {
            alert("الرجاء اختيار الشهر أولاً!");
            return;
        }

        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الاتصال...'; 
        btn.disabled = true;

        try {
            // طلب البيانات مع تحديد الشهر
            const res = await fetch(`/api/get-data?month=${monthInput}`);
            
            if(!res.ok) {
                const errData = await res.json();
                throw new Error(errData.error || `خطأ سيرفر: ${res.status}`);
            }
            
            const data = await res.json();
            
            rawInvoices = data.invoices || [];
            productsMap = data.productsMap || {};
            
            // تخزين وحدات قيود
            if(data.product_units) {
                 data.product_units.forEach(u => {
                     // نحاول أخذ معامل التحويل، أحياناً يكون اسمه conversion_factor أو representation
                     unitsMap[u.id] = parseFloat(u.conversion_factor || u.representation || 1);
                 });
            }
            
            // معالجة إشعارات الدائن (المرتجعات) من allocations
            // سنجلب تفاصيل Credit Notes عند الحاجة بناءً على allocations في الفاتورة
            creditNotesMap = {}; // سيتم ملؤه لاحقاً من الفواتير

            // تحديث قائمة المناديب
            creatorsList = [...new Set(rawInvoices.map(i => i.created_by).filter(Boolean))];
            updateCreatorsDropdown();
            
            // بدء العمليات الحسابية
            calculateAll();
            renderProductSettings();
            renderTargetSettings();
            
            btn.innerHTML = `<i class="fas fa-check"></i> تم (${rawInvoices.length} فاتورة)`;

        } catch(e) { 
            console.error(e);
            alert("فشل العملية: " + e.message); 
            btn.innerHTML = '<i class="fas fa-sync-alt"></i> إعادة المحاولة'; 
        } finally { 
            btn.disabled = false; 
        }
    }

    // --- 2. المحرك الحسابي الرئيسي ---
    function calculateAll() {
        computedData = [];
        suspendedData = [];
        const tDate = document.getElementById('targetMonth').value;
        const [tYear, tMonth] = tDate.split('-').map(Number);

        rawInvoices.forEach(inv => {
            if(!inv.line_items) return;

            // أ) التحقق من الآجل
            // هل تحتوي الفاتورة على بند "خدمة آجل"؟
            let isSystemDelayed = inv.line_items.some(i => i.sku === DELAYED_SKU || (i.product_name && i.product_name.includes(DELAYED_KEYWORD)));
            // هل قام المستخدم باستثنائها يدوياً؟
            let isManualExcluded = manualExclusions.includes(inv.id);
            
            let isDelayed = isSystemDelayed || isManualExcluded;

            // ب) التحقق من الاستحقاق (Eligibility) وتاريخ السداد الفعلي
            let isEligible = false;
            let checkDate = new Date(inv.issue_date); // الافتراضي
            
            // استخراج تاريخ آخر دفعة من payments[] - التحسين المتوسط 1
            if (inv.status === 'Paid' && inv.payments && inv.payments.length > 0) {
                const sortedPayments = inv.payments.sort((a, b) => new Date(b.date) - new Date(a.date));
                checkDate = new Date(sortedPayments[0].date); // أحدث دفعة
            }

            if (!isDelayed) {
                // فاتورة كاش عادية -> مستحقة فوراً
                isEligible = true;
            } else {
                // فاتورة آجلة/مستثناة
                if (inv.status === 'Paid') {
                    // إذا دُفعت -> تصبح مستحقة بتاريخ السداد
                    // الاستثناء اليدوي يمنع البونص حتى لو دفعت
                    if (isManualExcluded) {
                        isEligible = false;
                    } else {
                        isEligible = true;
                    }
                } else {
                    // لم تدفع -> معلقة
                    isEligible = false;
                }
            }

            // فلترة الشهر
            // الفواتير المستحقة (Eligible): يجب أن يكون تاريخ السداد في الشهر المختار
            // الفواتير المعلقة (!Eligible): تظهر دائماً في "المعلق" بغض النظر عن التاريخ
            if (isEligible) {
                // فاتورة مستحقة: يجب أن يكون تاريخ السداد في الشهر المختار
                if (checkDate.getMonth() + 1 !== tMonth || checkDate.getFullYear() !== tYear) return;
            }
            // الفواتير المعلقة: لا تحتاج فلترة تاريخية (تظهر دائماً)

            // ج) حساب البونص لكل سطر (مع خصم المرتجعات)
            
            // حساب المرتجعات لهذه الفاتورة من allocations
            const returnedQtyMap = {}; // {product_id: total_returned_qty}
            
            // فحص allocations لمعرفة إذا كان هناك إشعارات دائن مربوطة
            if(inv.allocations && inv.allocations.length > 0) {
                inv.allocations.forEach(alloc => {
                    // فقط إشعارات الدائن (Credit Notes)
                    if(alloc.source_type === 'CreditNote') {
                        // ملاحظة: allocations تحتوي فقط على المبلغ وليس التفاصيل
                        // لذلك سنفترض أن المبلغ يمثل قيمة المرتجعات
                        // وسنحسب الكمية المرجعة بناءً على نسبة المبلغ
                        const creditAmount = parseFloat(alloc.amount || 0);
                        const invoiceTotal = parseFloat(inv.total || 0);
                        
                        if(invoiceTotal > 0) {
                            const returnRatio = creditAmount / invoiceTotal; // نسبة المرتجع
                            
                            // تطبيق النسبة على كل منتج في الفاتورة
                            inv.line_items.forEach(item => {
                                const pid = item.product_id;
                                const itemQty = parseFloat(item.quantity || 0);
                                const returnedQty = itemQty * returnRatio;
                                returnedQtyMap[pid] = (returnedQtyMap[pid] || 0) + returnedQty;
                            });
                        }
                    }
                });
            }
            
            inv.line_items.forEach(item => {
                // تجاهل سطر "خدمة الآجل" نفسه
                if(item.sku === DELAYED_SKU || (item.product_name && item.product_name.includes(DELAYED_KEYWORD))) return;
                
                const pid = item.product_id;
                const pInfo = productsMap[pid] || { purchase_price: 0, name: item.product_name };
                const rule = productRules[pid] || {};

                // 1. تحديد المعامل (الكرتون)
                let factor = 1;
                // الأولوية: وحدة قيود > إعداد يدوي > 1
                if(item.unit_type && unitsMap[item.unit_type]) factor = unitsMap[item.unit_type];
                else if(rule.factor && parseFloat(rule.factor) !== 1) factor = parseFloat(rule.factor);

                // 2. قراءة إعدادات الشرائح
                const pp = rule.premiumPrice ? parseFloat(rule.premiumPrice) : 0; // سعر التميز
                const bp = rule.basePrice ? parseFloat(rule.basePrice) : 0;       // السعر الأساسي
                const ppct = rule.premiumPct !== undefined ? rule.premiumPct : 2; // نسبة التميز
                const bpct = rule.basePct !== undefined ? rule.basePct : 1;       // نسبة الأساسي

                const sell = parseFloat(item.unit_price);
                let qty = parseFloat(item.quantity);
                
                // خصم الكمية المرجعة من هذا المنتج
                const returnedQty = returnedQtyMap[pid] || 0;
                qty = qty - returnedQty;
                
                // إذا كانت الكمية الصافية صفر أو سالبة، تجاهل هذا السطر
                if(qty <= 0) return;
                
                // إضافة الضريبة (15% VAT) - الإصلاح الحرج 2
                const taxPercent = parseFloat(item.tax_percent || 0);
                const sellWithTax = sell * (1 + taxPercent / 100);
                
                // تحويل سعر البيع إلى سعر الكرتون - الإصلاح الحرج 3
                const sellPerCarton = sellWithTax * factor;
                
                const total = sellWithTax * qty;
                const unitCost = parseFloat(pInfo.purchase_price) * factor; // تكلفة الوحدة المباعة

                // 3. تصنيف السعر (بعد إضافة الضريبة والتحويل)
                let appliedPct = 0;
                let typeClass = "أقل من الحد";
                let badgeClass = "badge-low";

                // مقارنة السعر بعد التحويل للكرتون
                if (pp > 0 && sellPerCarton >= pp) {
                    appliedPct = ppct;
                    typeClass = "تميز (Premium)";
                    badgeClass = "badge-premium";
                } else if (bp > 0 && sellPerCarton >= bp) {
                    appliedPct = bpct;
                    typeClass = "أساسي (Base)";
                    badgeClass = "badge-base";
                } else if (pp === 0 && bp === 0 && sellPerCarton > unitCost) {
                    // حالة افتراضية: ربح بسيط
                    appliedPct = bpct; 
                    typeClass = "تلقائي"; 
                    badgeClass = "badge-base";
                }
                
                const bonusVal = total * (appliedPct/100);

                const record = {
                    invId: inv.id, 
                    ref: inv.reference, 
                    creator: invoiceTransfers[inv.id] || inv.created_by, // التحسين المتوسط 2: نقل الفواتير
                    originalCreator: inv.created_by, // حفظ المندوب الأصلي
                    status: inv.status,
                    prod: item.product_name, 
                    qty: qty, // الكمية بعد خصم المرتجعات
                    originalQty: parseFloat(item.quantity), // الكمية الأصلية
                    returnedQty: returnedQty, // الكمية المرجعة
                    sell: sellWithTax, class: typeClass, badge: badgeClass,
                    pct: appliedPct, bonus: bonusVal, total: total, isManual: isManualExcluded,
                    factor: factor, taxPercent: taxPercent // للعرض والتدقيق
                };

                if (isEligible) {
                    computedData.push(record);
                } else {
                    suspendedData.push(record);
                }
            });
        });
        
        renderMainTable();
        renderSuspendedTable();
        renderReturnsTable(); // عرض المرتجعات
    }

    // --- 3. رسم الجدول الرئيسي ---
    function renderMainTable() {
        const tbody = document.getElementById('mainRows');
        tbody.innerHTML = '';
        const filter = document.getElementById('creatorFilter').value;
        
        const filtered = computedData.filter(d => filter === 'all' || d.creator === filter);

        // تجميعات
        let totalSales = filtered.reduce((a,b)=>a+b.total,0);
        let totalBonus = filtered.reduce((a,b)=>a+b.bonus,0);
        let targetMsg = "لم يحدد";
        let isBlocked = false;

        // منطق التارجت
        if(filter !== 'all') {
            const tr = targetRules[filter] || {amount:0, reward:0, block:false};
            if(tr.amount > 0) {
                if(totalSales >= tr.amount) {
                    totalBonus += tr.reward;
                    targetMsg = `✅ حقق (+${tr.reward})`;
                } else {
                    const diff = tr.amount - totalSales;
                    targetMsg = `❌ باقي ${diff.toLocaleString()}`;
                    if(tr.block) {
                        isBlocked = true;
                        totalBonus = 0; // تصفير البونص
                        targetMsg += " (محجوب)";
                    }
                }
            }
        }

        document.getElementById('stat-sales').innerText = totalSales.toLocaleString();
        document.getElementById('stat-bonus').innerText = totalBonus.toLocaleString();
        document.getElementById('stat-target').innerText = targetMsg;

        if(filtered.length === 0) { tbody.innerHTML='<tr><td colspan="9" style="text-align:center">لا توجد بيانات مستحقة لهذا الشهر</td></tr>'; return; }

        filtered.forEach(r => {
            let exBtn = `<button class="exclude-btn" onclick="toggleExclusion(${r.invId})"><i class="fas fa-ban"></i> استثناء</button>`;
            let transferBtn = `<button class="save-btn" style="font-size:0.75em; padding:3px 8px; margin-top:3px" onclick="transferInvoice(${r.invId}, '${r.creator}')"><i class="fas fa-exchange-alt"></i> نقل</button>`;
            let transferIndicator = r.originalCreator !== r.creator ? `<span style="font-size:0.75em; color:#e67e22"><br>← ${r.originalCreator}</span>` : '';
            let bonusTxt = isBlocked ? `<span style="text-decoration:line-through; color:red">${r.bonus.toFixed(2)}</span>` : r.bonus.toFixed(2);
            
            // عرض المرتجعات إذا وجدت
            let qtyDisplay = r.qty;
            if(r.returnedQty && r.returnedQty > 0) {
                qtyDisplay = `<span title="الكمية الأصلية: ${r.originalQty}">${r.qty} <span style="color:#e74c3c; font-size:0.8em">(-${r.returnedQty})</span></span>`;
            }
            
            tbody.innerHTML += `<tr>
                <td>${exBtn}<br>${transferBtn}</td>
                <td>${r.ref}</td>
                <td>${r.creator}${transferIndicator}</td>
                <td style="font-size:0.9em">${r.prod}</td>
                <td>${qtyDisplay}</td>
                <td><b>${r.sell.toFixed(2)}</b></td>
                <td><span class="badge ${r.badge}">${r.class}</span></td>
                <td>${r.pct}%</td>
                <td style="font-weight:bold; color:var(--acc)">${bonusTxt}</td>
            </tr>`;
        });
    }    // --- 4. رسم جدول المعلق ---
    function renderSuspendedTable() {
        const tbody = document.getElementById('suspendedRows');
        tbody.innerHTML = '';
        const filtered = suspendedData;
        
        console.log('=== renderSuspendedTable ===');
        console.log('عدد الفواتير المعلقة:', filtered.length);
        if(filtered.length > 0) {
            console.log('عينة من الفواتير المعلقة:', filtered.slice(0, 3));
        }
        
        let totalSuspended = filtered.reduce((a,b)=>a+b.bonus,0);
        document.getElementById('stat-suspended-bonus').innerText = totalSuspended.toLocaleString();
        
        // حساب عدد الفواتير الآجلة (غير مدفوعة ومدفوعة)
        const delayedUnpaid = filtered.filter(r => !r.isManual && r.status === 'Approved').length;
        const delayedPaid = filtered.filter(r => !r.isManual && r.status === 'Paid').length;
        document.getElementById('stat-delayed-count').innerText = delayedUnpaid;
        document.getElementById('stat-delayed-paid').innerText = delayedPaid;

        if(filtered.length === 0) { tbody.innerHTML='<tr><td colspan="6" style="text-align:center">لا توجد فواتير معلقة</td></tr>'; return; }

        filtered.forEach(r => {
            let actionBtn = "";
            let reason = "";
            let reasonBadge = "badge-pending";
            
            if (r.isManual) {
                actionBtn = `<button class="restore-btn" onclick="toggleExclusion(${r.invId})"><i class="fas fa-undo"></i> إعادة للحساب</button>`;
                reason = "مستثنى يدوياً";
                reasonBadge = "badge-low";
            } else {
                // فاتورة آجلة
                if (r.status === 'Paid') {
                    actionBtn = `<span style="color:#27ae60"><i class="fas fa-check-circle"></i> مدفوعة</span>`;
                    reason = "مدفوعة (ستدخل البونص في شهر السداد)";
                    reasonBadge = "badge-base";
                } else if (r.status === 'Approved') {
                    actionBtn = `<span style="color:#e74c3c"><i class="fas fa-clock"></i> آجلة</span>`;
                    reason = "آجلة - غير مدفوعة (لن تدخل البونص حتى السداد)";
                    reasonBadge = "badge-pending";
                } else {
                    // حالات أخرى (Draft, Cancelled, etc.)
                    actionBtn = `<span style="color:#95a5a6"><i class="fas fa-question-circle"></i> ${r.status}</span>`;
                    reason = `حالة: ${r.status}`;
                    reasonBadge = "badge-pending";
                }
            }

            tbody.innerHTML += `<tr>
                <td>${actionBtn}</td>
                <td>${r.ref}</td><td>${r.creator}</td>
                <td style="font-size:0.9em">${r.prod}</td>
                <td><span class="badge ${reasonBadge}">${reason}</span></td>
                <td style="font-weight:bold; color:#7f8c8d">${r.bonus.toFixed(2)}</td>
            </tr>`;
        });
    }

    // --- عرض المرتجعات ---
    function renderReturnsTable() {
        const tbody = document.getElementById('returnsRows');
        tbody.innerHTML = '';
        
        let totalReturnsAmount = 0;
        let affectedInvoicesCount = 0;
        
        console.log('=== renderReturnsTable ===');
        console.log('عدد الفواتير المجلوبة:', rawInvoices.length);
        
        // فحص جميع الفواتير للبحث عن allocations من نوع CreditNote
        rawInvoices.forEach(inv => {
            if(inv.allocations && inv.allocations.length > 0) {
                inv.allocations.forEach(alloc => {
                    if(alloc.source_type === 'CreditNote') {
                        console.log('وجدت مرتجع:', inv.reference, alloc);
                        affectedInvoicesCount++;
                        const creditAmount = parseFloat(alloc.amount || 0);
                        const invoiceTotal = parseFloat(inv.total || 0);
                        const returnRatio = invoiceTotal > 0 ? (creditAmount / invoiceTotal * 100) : 0;
                        
                        totalReturnsAmount += creditAmount;
                        
                        // الحصول على اسم المندوب
                        let creator = inv.created_by || 'غير محدد';
                        if(invoiceTransfers[inv.id]) creator = invoiceTransfers[inv.id];
                        
                        tbody.innerHTML += `<tr>
                            <td>${inv.reference || inv.id}</td>
                            <td>${creator}</td>
                            <td style="color:#c0392b; font-weight:bold">${creditAmount.toFixed(2)} ريال</td>
                            <td>${invoiceTotal.toFixed(2)} ريال</td>
                            <td><span class="badge badge-pending">${returnRatio.toFixed(1)}%</span></td>
                            <td>${alloc.date || '-'}</td>
                        </tr>`;
                    }
                });
            }
        });
        
        if(affectedInvoicesCount === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">لا توجد مرتجعات في الفترة المختارة</td></tr>';
        }
        
        // تحديث الإحصائيات
        document.getElementById('stat-returns-amount').innerText = totalReturnsAmount.toFixed(2) + ' ريال';
        document.getElementById('stat-returns-count').innerText = affectedInvoicesCount;
    }

    // --- إدارة الاستثناء اليدوي ---
    function toggleExclusion(id) {
        if(manualExclusions.includes(id)) manualExclusions = manualExclusions.filter(x=>x!==id);
        else manualExclusions.push(id);
        localStorage.setItem('manualExclusions_v8', JSON.stringify(manualExclusions));
        calculateAll();
    }
    
    // --- نقل الفواتير بين المناديب (التحسين المتوسط 2) ---
    function transferInvoice(invId, currentCreator) {
        const newCreator = prompt(`نقل الفاتورة #${invId} من "${currentCreator}" إلى:`, "");
        if (newCreator && newCreator.trim() !== "") {
            invoiceTransfers[invId] = newCreator.trim();
            localStorage.setItem('invoiceTransfers_v8', JSON.stringify(invoiceTransfers));
            alert(`تم نقل الفاتورة #${invId} إلى "${newCreator.trim()}" بنجاح`);
            calculateAll();
        }
    }
    
    // --- حذف نقل فاتورة (إعادة للمندوب الأصلي) ---
    function resetTransfer(invId) {
        if(invoiceTransfers[invId]) {
            delete invoiceTransfers[invId];
            localStorage.setItem('invoiceTransfers_v8', JSON.stringify(invoiceTransfers));
            alert(`تم إعادة الفاتورة #${invId} للمندوب الأصلي`);
            calculateAll();
        }
    }

    // --- إدارة إعدادات المنتجات ---
    function renderProductSettings() {
        const tbody = document.getElementById('productRows');
        tbody.innerHTML = '';
        Object.keys(productsMap).forEach(pid => {
            const p = productsMap[pid];
            const r = productRules[pid] || {};
            const factor = r.factor || 1;
            const pp = r.premiumPrice || 0;
            const bp = r.basePrice || 0;
            const ppct = r.premiumPct !== undefined ? r.premiumPct : 2;
            const bpct = r.basePct !== undefined ? r.basePct : 1;
            
            tbody.innerHTML += `<tr>
                <td style="text-align:right; font-size:0.9em;">${p.name}</td>
                <td><input type="number" class="tbl-input" id="f_${pid}" value="${factor}" step="1" style="background:#fffcf5"></td>
                <td><input type="number" class="tbl-input" id="pp_${pid}" value="${pp}" style="border:2px solid #27ae60"></td>
                <td><input type="number" class="tbl-input" id="pct1_${pid}" value="${ppct}"></td>
                <td><input type="number" class="tbl-input" id="bp_${pid}" value="${bp}" style="background:#eee"></td>
                <td><input type="number" class="tbl-input" id="pct2_${pid}" value="${bpct}"></td>
            </tr>`;
        });
    }

    function saveProductSettings() {
        Object.keys(productsMap).forEach(pid => {
            productRules[pid] = {
                factor: parseFloat(document.getElementById(`f_${pid}`).value)||1,
                premiumPrice: parseFloat(document.getElementById(`pp_${pid}`).value)||0,
                basePrice: parseFloat(document.getElementById(`bp_${pid}`).value)||0,
                premiumPct: parseFloat(document.getElementById(`pct1_${pid}`).value)||0,
                basePct: parseFloat(document.getElementById(`pct2_${pid}`).value)||0
            };
        });
        localStorage.setItem('productRules_v8', JSON.stringify(productRules));
        alert('تم حفظ إعدادات الأسعار والنسب');
        calculateAll();
    }

    // --- إدارة التارجت ---
    function renderTargetSettings() {
        const tbody = document.getElementById('targetRows');
        tbody.innerHTML = '';
        creatorsList.forEach(c => {
            const r = targetRules[c] || {amount:0, reward:0, block:false};
            const sales = computedData.filter(d => d.creator === c).reduce((a,b)=>a+b.total,0);
            let status = (r.amount>0 && sales>=r.amount) ? '✅' : '❌';
            tbody.innerHTML += `<tr>
                <td><b>${c}</b></td>
                <td>${sales.toLocaleString()}</td>
                <td><input type="number" class="tbl-input" id="ta_${c}" value="${r.amount}"></td>
                <td><input type="number" class="tbl-input" id="tr_${c}" value="${r.reward}"></td>
                <td style="text-align:center"><input type="checkbox" id="tb_${c}" ${r.block?'checked':''}></td>
                <td>${status}</td>
            </tr>`;
        });
    }

    function saveTargetSettings() {
        creatorsList.forEach(c => {
            targetRules[c] = {
                amount: parseFloat(document.getElementById(`ta_${c}`).value)||0,
                reward: parseFloat(document.getElementById(`tr_${c}`).value)||0,
                block: document.getElementById(`tb_${c}`).checked
            };
        });
        localStorage.setItem('targetRules_v8', JSON.stringify(targetRules));
        alert('تم حفظ أهداف المناديب');
        calculateAll();
    }

    function updateCreatorsDropdown() {
        const s = document.getElementById('creatorFilter');
        const v = s.value;
        s.innerHTML = '<option value="all">الكل</option>';
        creatorsList.forEach(c => s.innerHTML += `<option value="${c}">${c}</option>`);
        s.value = v;
    }

    // --- تصدير للإكسل ---
    async function exportToExcel() {
        const wb = new ExcelJS.Workbook();
        
        // شيت 1: البونص المستحق
        const ws = wb.addWorksheet('البونص المستحق');
        ws.addRow(['المرجع','المندوب','المنتج','الكمية','سعر البيع','التصنيف','النسبة','البونص']);
        computedData.forEach(d => ws.addRow([d.ref, d.creator, d.prod, d.qty, d.sell, d.class, d.pct+'%', d.bonus]));
        
        // شيت 2: المعلق
        const ws2 = wb.addWorksheet('الفواتير المعلقة');
        ws2.addRow(['المرجع','المندوب','المنتج','الحالة','البونص المتوقع']);
        suspendedData.forEach(d => ws2.addRow([d.ref, d.creator, d.prod, d.status === 'Paid' ? 'مدفوعة (آجل)' : 'غير مدفوعة', d.bonus]));

        const buf = await wb.xlsx.writeBuffer();
        saveAs(new Blob([buf]), 'Bonus_Report_V8.xlsx');
    }
    
    // --- تصدير الإعدادات (التحسين التكميلي) ---
    function exportSettings() {
        const settings = {
            productRules: productRules,
            targetRules: targetRules,
            invoiceTransfers: invoiceTransfers,
            version: "v8",
            exportDate: new Date().toISOString(),
            description: "نظام إدارة العمولات - نسخة احتياطية"
        };
        
        const jsonStr = JSON.stringify(settings, null, 2);
        const blob = new Blob([jsonStr], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `bonus-settings-${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        alert('تم تصدير الإعدادات بنجاح!');
    }
    
    // --- استيراد الإعدادات (التحسين التكميلي) ---
    function importSettings() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'application/json';
        input.onchange = e => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = event => {
                try {
                    const settings = JSON.parse(event.target.result);
                    
                    // التحقق من صحة الملف
                    if (!settings.version || settings.version !== "v8") {
                        throw new Error('صيغة الملف غير متوافقة أو إصدار قديم');
                    }
                    
                    // استيراد الإعدادات
                    if (settings.productRules) {
                        productRules = settings.productRules;
                        localStorage.setItem('productRules_v8', JSON.stringify(productRules));
                    }
                    if (settings.targetRules) {
                        targetRules = settings.targetRules;
                        localStorage.setItem('targetRules_v8', JSON.stringify(targetRules));
                    }
                    if (settings.invoiceTransfers) {
                        invoiceTransfers = settings.invoiceTransfers;
                        localStorage.setItem('invoiceTransfers_v8', JSON.stringify(invoiceTransfers));
                    }
                    
                    alert('تم استيراد الإعدادات بنجاح!\n\nتاريخ التصدير: ' + (settings.exportDate ? new Date(settings.exportDate).toLocaleString('ar-SA') : 'غير محدد'));
                    
                    // إعادة رسم الجداول
                    renderProductSettings();
                    renderTargetSettings();
                    calculateAll();
                    
                } catch(err) {
                    alert('خطأ في قراءة الملف: ' + err.message);
                    console.error(err);
                }
            };
            reader.readAsText(file);
        };
        input.click();
    }
</script>
</body>
</html>
