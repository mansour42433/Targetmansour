<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>نظام البونص الاحترافي</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        /* نفس ألوان وتصميم الكود المرفق */
        :root{--p:#2980b9;--d:#2c3e50;--r:#c0392b;--g:#27ae60;--o:#f39c12;--bg:#f4f6f9; --pending:#8e44ad;}
        body{font-family:'Cairo', sans-serif; background:var(--bg); padding:20px; color: var(--d);}
        
        .container { max-width: 1600px; margin: auto; }
        
        /* البطاقات العلوية */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-right: 5px solid var(--p); display: flex; align-items: center; justify-content: space-between; }
        .stat-info h3 { font-size: 0.9rem; color: #7f8c8d; margin-bottom: 5px; }
        .stat-info p { font-size: 1.8rem; font-weight: bold; color: var(--d); margin: 0; }
        .stat-icon { font-size: 2.5rem; opacity: 0.2; }

        /* شريط الأدوات */
        .toolbar { background: #fff; padding: 20px; border-radius: 12px; display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.9rem; }
        .form-control { padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: 'Cairo'; width: 200px; }
        
        .btn { padding: 10px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-family: 'Cairo'; color: #fff; transition: 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--p); } .btn-primary:hover { background: #2471a3; }
        .btn-success { background: var(--g); }
        .btn-dark { background: var(--d); }

        /* شريط التقدم */
        .progress-container { display: none; margin-bottom: 20px; background: #fff; padding: 20px; border-radius: 12px; text-align: center; }
        .progress-steps { display: flex; justify-content: space-between; margin-bottom: 10px; position: relative; }
        .step { flex: 1; text-align: center; font-size: 0.9rem; color: #ccc; position: relative; z-index: 1; }
        .step.active { color: var(--p); font-weight: bold; }
        .step i { display: block; font-size: 1.5rem; margin-bottom: 5px; }
        .loading-text { font-weight: bold; color: var(--p); margin-top: 10px; }

        /* الجداول */
        .box { background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .box-header { background: var(--d); color: #fff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; color: var(--d); padding: 15px; text-align: right; font-weight: bold; border-bottom: 2px solid #eee; }
        td { padding: 12px 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
        tr:hover { background: #fbfbfb; }

        /* تفاصيل المنتج */
        .product-row { cursor: pointer; background: #fff; }
        .product-row:hover { background: #f1faff !important; }
        .details-row { display: none; background: #f8f9fa; }
        .details-content { padding: 20px; box-shadow: inset 0 0 10px rgba(0,0,0,0.05); }
        .sub-table th { background: var(--p); color: #fff; padding: 10px; font-size: 0.9rem; }
        .sub-table td { background: #fff; padding: 8px; font-size: 0.9rem; }

        /* بادجات */
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        .bg-gold { background: #f1c40f; color: #fff; }
        .bg-silver { background: #bdc3c7; color: #fff; }

        /* التبويبات */
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav-btn { background: #e0e0e0; color: #555; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-family: 'Cairo'; font-weight: bold; }
        .nav-btn.active { background: var(--p); color: #fff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>

<div class="container">
    
    <div class="stats-grid">
        <div class="stat-card" style="border-color: var(--p);">
            <div class="stat-info"><h3>إجمالي البونص</h3><p id="totalBonus">0.00</p></div>
            <i class="fas fa-coins stat-icon" style="color:var(--p)"></i>
        </div>
        <div class="stat-card" style="border-color: var(--g);">
            <div class="stat-info"><h3>المبيعات المحققة</h3><p id="totalSales">0.00</p></div>
            <i class="fas fa-chart-line stat-icon" style="color:var(--g)"></i>
        </div>
        <div class="stat-card" style="border-color: var(--r);">
            <div class="stat-info"><h3>عدد الفواتير</h3><p id="invCount">0</p></div>
            <i class="fas fa-file-invoice stat-icon" style="color:var(--r)"></i>
        </div>
    </div>

    <div class="toolbar">
        <div class="form-group">
            <label>شهر التحصيل (تاريخ الدفع)</label>
            <input type="month" id="targetMonth" class="form-control">
        </div>
        <div class="form-group">
            <label>المندوب</label>
            <select id="repFilter" class="form-control" onchange="renderReport()"><option value="all">الكل</option></select>
        </div>
        <button class="btn btn-primary" onclick="startFetching()"><i class="fas fa-sync-alt"></i> جلب البيانات</button>
        <button class="btn btn-success" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> تصدير التقرير</button>
    </div>

    <div class="progress-container" id="progressBox">
        <div class="progress-steps">
            <div class="step" id="step1"><i class="fas fa-box"></i>المنتجات</div>
            <div class="step" id="step2"><i class="fas fa-ruler"></i>الوحدات</div>
            <div class="step" id="step3"><i class="fas fa-file-invoice"></i>الفواتير</div>
            <div class="step" id="step4"><i class="fas fa-calculator"></i>المعالجة</div>
        </div>
        <div class="loading-text" id="loadingText">جاري الاتصال...</div>
    </div>

    <div class="nav-tabs">
        <button class="nav-btn active" onclick="switchTab('report')">تقرير البونص</button>
        <button class="nav-btn" onclick="switchTab('settings')">إعدادات المنتجات والتحويل</button>
    </div>

    <div id="report" class="tab-content active">
        <div class="box">
            <div class="box-header">
                <h3><i class="fas fa-list"></i> تفاصيل المبيعات (اضغط على المنتج لرؤية الفواتير)</h3>
            </div>
            <div id="reportContainer">
                <div style="padding:40px; text-align:center; color:#999;">اضغط "جلب البيانات" للبدء</div>
            </div>
        </div>
    </div>

    <div id="settings" class="tab-content">
        <div class="box">
            <div class="box-header" style="background:var(--d);">
                <h3><i class="fas fa-cogs"></i> إعدادات البونص والتحويل</h3>
                <button class="btn btn-success" style="padding:5px 15px; font-size:0.9rem;" onclick="saveSettings()">حفظ التعديلات</button>
            </div>
            <div style="padding:20px;">
                <table class="sub-table" style="width:100%">
                    <thead>
                        <tr>
                            <th>المنتج</th>
                            <th>هدف البونص 2% (سعر)</th>
                            <th>معامل التحويل</th>
                            <th>طريقة التحويل</th>
                        </tr>
                    </thead>
                    <tbody id="settingsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<script>
let DB = { products: [], invoices: [], units: {}, returns: {} };
let ReportData = [];
let Settings = JSON.parse(localStorage.getItem('BonusConfig_V2') || '{}');

document.getElementById('targetMonth').value = new Date().toISOString().slice(0, 7);

function switchTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    // تفعيل زر التبويب المقابل (يمكن تحسينه بالكود)
    event.target.classList.add('active');
}

// 1. نظام الجلب المرحلي
async function startFetching() {
    const pBox = document.getElementById('progressBox');
    const lText = document.getElementById('loadingText');
    pBox.style.display = 'block';

    try {
        // المرحلة 1: المنتجات
        updateStep(1, "جاري جلب المنتجات...");
        const pRes = await fetch('/api/data.js?type=products');
        const pData = await pRes.json();
        DB.products = pData.data || [];
        
        // المرحلة 2: الوحدات
        updateStep(2, "جاري جلب تعريفات الوحدات...");
        const uRes = await fetch('/api/data.js?type=units');
        const uData = await uRes.json();
        (uData.data || []).forEach(u => DB.units[u.id] = u.name_ar || u.name_en);

        // المرحلة 3: الفواتير (الأثقل)
        updateStep(3, "جاري جلب الفواتير (قد يستغرق وقتاً)...");
        const iRes = await fetch('/api/data.js?type=invoices');
        const iData = await iRes.json();
        DB.invoices = iData.data || [];
        
        // جلب المرتجعات في الخلفية
        const rRes = await fetch('/api/data.js?type=returns');
        const rData = await rRes.json();
        (rData.data || []).forEach(cn => {
            if(cn.invoice_reference) {
                if(!DB.returns[cn.invoice_reference]) DB.returns[cn.invoice_reference] = [];
                DB.returns[cn.invoice_reference].push(cn);
            }
        });

        // المرحلة 4: المعالجة
        updateStep(4, "جاري الحساب وبناء التقرير...");
        renderSettingsTable(); // تحديث جدول الإعدادات
        processData(); // المعالجة الأساسية
        
        setTimeout(() => { pBox.style.display = 'none'; }, 1000);

    } catch (e) {
        lText.innerHTML = `<span style="color:red">خطأ: ${e.message}</span>`;
    }
}

function updateStep(num, text) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById(`step${num}`).classList.add('active');
    document.getElementById('loadingText').innerText = text;
}

// 2. منطق المعالجة (المنتج أولاً)
function processData() {
    ReportData = [];
    const targetMonth = document.getElementById('targetMonth').value;
    const [tYear, tMon] = targetMonth.split('-');

    // تكرار على كل منتج في النظام
    DB.products.forEach(prod => {
        const conf = Settings[prod.id] || { threshold: 0, factor: 1, mode: 'none' };
        let prodTotalSales = 0;
        let prodTotalBonus = 0;
        let prodInvoices = [];

        // البحث في جميع الفواتير
        DB.invoices.forEach(inv => {
            if (inv.status !== 'Paid' || !inv.payment_date) return;
            const [pYear, pMon] = inv.payment_date.split('-');
            if (pYear !== tYear || pMon !== tMon) return;

            const items = inv.line_items || inv.inventory_items || inv.invoice_items || [];
            
            // هل هذا المنتج موجود في الفاتورة؟
            items.forEach(item => {
                if(String(item.product_id) === String(prod.id)) {
                    let qty = parseFloat(item.quantity) || 0;
                    
                    // خصم المرتجعات
                    if(DB.returns[inv.reference]) {
                        DB.returns[inv.reference].forEach(cn => {
                            const cnItems = cn.line_items || cn.inventory_items || [];
                            cnItems.forEach(ci => {
                                if(String(ci.product_id) === String(prod.id)) qty -= parseFloat(ci.quantity) || 0;
                            });
                        });
                    }

                    if (qty <= 0) return;

                    // منطق التحويل
                    let finalQty = qty;
                    let unitName = DB.units[item.unit_type] || "-";

                    if (conf.mode === 'div' && conf.factor > 0) finalQty = qty / conf.factor;
                    else if (conf.mode === 'mul') finalQty = qty * conf.factor;

                    let price = parseFloat(item.unit_price) || 0;
                    // تعديل السعر ليتناسب مع الوحدة المحولة (اختياري، هنا نركز على الإجمالي)
                    if (conf.mode === 'div' && conf.factor > 0) price = price * conf.factor;
                    
                    let total = finalQty * price;

                    // حساب البونص
                    let rate = 1; 
                    let badge = "أساسي";
                    if (conf.threshold > 0 && price >= conf.threshold) { rate = 2; badge = "ممتاز"; }
                    
                    let bonus = (total * rate) / 100;

                    prodInvoices.push({
                        invRef: inv.reference,
                        date: inv.payment_date,
                        rep: inv.creator,
                        qty: finalQty,
                        unit: unitName,
                        price: price,
                        total: total,
                        rate: rate,
                        badge: badge,
                        bonus: bonus
                    });

                    prodTotalSales += total;
                    prodTotalBonus += bonus;
                }
            });
        });

        if (prodInvoices.length > 0) {
            ReportData.push({
                id: prod.id,
                name: prod.name_ar || prod.name_en,
                totalSales: prodTotalSales,
                totalBonus: prodTotalBonus,
                invoices: prodInvoices
            });
        }
    });

    renderReport();
}

// 3. العرض (واجهة جميلة)
function renderReport() {
    const container = document.getElementById('reportContainer');
    const filterRep = document.getElementById('repFilter').value;
    
    // تحديث فلتر المناديب
    let allReps = new Set();
    ReportData.forEach(p => p.invoices.forEach(i => allReps.add(i.rep)));
    const sel = document.getElementById('repFilter');
    if(sel.options.length === 1) {
        [...allReps].sort().forEach(r => sel.innerHTML += `<option value="${r}">${r}</option>`);
    }

    let html = `<table><thead><tr><th>المنتج</th><th>عدد الفواتير</th><th>إجمالي المبيعات</th><th>إجمالي البونص</th></tr></thead><tbody>`;
    
    let grandBonus = 0;
    let grandSales = 0;
    let grandInv = 0;

    ReportData.forEach(prod => {
        // تصفية الفواتير حسب المندوب
        let validInvs = filterRep === 'all' ? prod.invoices : prod.invoices.filter(i => i.rep === filterRep);
        
        if (validInvs.length === 0) return;

        let sales = validInvs.reduce((a,b) => a + b.total, 0);
        let bonus = validInvs.reduce((a,b) => a + b.bonus, 0);

        grandSales += sales;
        grandBonus += bonus;
        grandInv += validInvs.length;

        html += `
            <tr class="product-row" onclick="toggleDetails(${prod.id})">
                <td style="font-weight:bold; color:var(--p);"><i class="fas fa-plus-circle" id="icon_${prod.id}"></i> ${prod.name}</td>
                <td>${validInvs.length}</td>
                <td>${sales.toLocaleString()}</td>
                <td style="color:var(--g); font-weight:bold;">${bonus.toLocaleString()}</td>
            </tr>
            <tr id="details_${prod.id}" class="details-row">
                <td colspan="4" class="details-content">
                    <table class="sub-table">
                        <thead><tr><th>رقم الفاتورة</th><th>المندوب</th><th>التاريخ</th><th>الكمية المحولة</th><th>سعر الوحدة</th><th>الإجمالي</th><th>الفئة</th><th>البونص</th></tr></thead>
                        <tbody>
                            ${validInvs.map(inv => `
                                <tr>
                                    <td>${inv.invRef}</td>
                                    <td>${inv.rep}</td>
                                    <td>${inv.date}</td>
                                    <td>${inv.qty.toFixed(2)}</td>
                                    <td>${inv.price.toFixed(2)}</td>
                                    <td>${inv.total.toFixed(2)}</td>
                                    <td><span class="badge ${inv.rate===2?'bg-gold':'bg-silver'}">${inv.badge}</span></td>
                                    <td>${inv.bonus.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </td>
            </tr>
        `;
    });

    html += `</tbody></table>`;
    container.innerHTML = html;

    // تحديث البطاقات العلوية
    document.getElementById('totalBonus').innerText = grandBonus.toLocaleString();
    document.getElementById('totalSales').innerText = grandSales.toLocaleString();
    document.getElementById('invCount').innerText = grandInv;
}

function toggleDetails(id) {
    const row = document.getElementById(`details_${id}`);
    const icon = document.getElementById(`icon_${id}`);
    if (row.style.display === 'table-row') {
        row.style.display = 'none';
        icon.classList.remove('fa-minus-circle');
        icon.classList.add('fa-plus-circle');
    } else {
        row.style.display = 'table-row';
        icon.classList.remove('fa-plus-circle');
        icon.classList.add('fa-minus-circle');
    }
}

// 4. الإعدادات والتحويل
function renderSettingsTable() {
    const tbody = document.getElementById('settingsTableBody');
    tbody.innerHTML = '';
    
    DB.products.sort((a,b) => (a.name_ar||"").localeCompare(b.name_ar||"")).forEach(p => {
        const conf = Settings[p.id] || { threshold: 0, factor: 0, mode: 'none' };
        tbody.innerHTML += `
            <tr>
                <td>${p.name_ar || p.name_en}</td>
                <td><input type="number" id="thr_${p.id}" value="${conf.threshold}" class="form-control" style="width:100px"></td>
                <td><input type="number" id="fac_${p.id}" value="${conf.factor}" class="form-control" style="width:100px"></td>
                <td>
                    <select id="mod_${p.id}" class="form-control" style="width:120px">
                        <option value="none" ${conf.mode==='none'?'selected':''}>بدون تحويل</option>
                        <option value="div" ${conf.mode==='div'?'selected':''}>قسمة (حبة->كرتون)</option>
                        <option value="mul" ${conf.mode==='mul'?'selected':''}>ضرب (كرتون->حبة)</option>
                    </select>
                </td>
            </tr>
        `;
    });
}

function saveSettings() {
    DB.products.forEach(p => {
        const t = document.getElementById(`thr_${p.id}`);
        if(t) {
            Settings[p.id] = {
                threshold: parseFloat(t.value) || 0,
                factor: parseFloat(document.getElementById(`fac_${p.id}`).value) || 0,
                mode: document.getElementById(`mod_${p.id}`).value
            };
        }
    });
    localStorage.setItem('BonusConfig_V2', JSON.stringify(Settings));
    alert("تم حفظ الإعدادات! سيتم إعادة حساب التقرير...");
    processData();
}

async function exportToExcel() {
    if(ReportData.length === 0) return alert("لا توجد بيانات للتصدير");
    const wb = new ExcelJS.Workbook();
    const ws = wb.addWorksheet('تفاصيل البونص');
    
    ws.columns = [
        { header: 'المنتج', key: 'prod', width: 30 },
        { header: 'الفاتورة', key: 'inv', width: 15 },
        { header: 'المندوب', key: 'rep', width: 20 },
        { header: 'التاريخ', key: 'date', width: 15 },
        { header: 'الكمية المحولة', key: 'qty', width: 15 },
        { header: 'السعر', key: 'price', width: 15 },
        { header: 'البونص', key: 'bonus', width: 15 }
    ];

    // إضافة البيانات
    const filterRep = document.getElementById('repFilter').value;
    ReportData.forEach(prod => {
        let validInvs = filterRep === 'all' ? prod.invoices : prod.invoices.filter(i => i.rep === filterRep);
        validInvs.forEach(inv => {
            ws.addRow({
                prod: prod.name,
                inv: inv.invRef,
                rep: inv.rep,
                date: inv.date,
                qty: inv.qty,
                price: inv.price,
                bonus: inv.bonus
            });
        });
    });

    const buf = await wb.xlsx.writeBuffer();
    saveAs(new Blob([buf]), 'Bonus_Report_Full.xlsx');
}
</script>

</body>
</html>
