<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>نظام البونص والعمولات - النسخة النهائية</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root { --p: #2980b9; --d: #2c3e50; --r: #c0392b; --g: #27ae60; --o: #f39c12; --bg: #f4f6f9; }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); padding: 20px; color: var(--d); }
        .container { max-width: 1600px; margin: auto; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-right: 5px solid var(--p); display: flex; align-items: center; justify-content: space-between; }
        .stat-info h3 { font-size: 0.9rem; color: #7f8c8d; margin-bottom: 5px; }
        .stat-info p { font-size: 1.8rem; font-weight: bold; margin: 0; }
        .stat-icon { font-size: 2.5rem; opacity: 0.2; }

        .toolbar { background: #fff; padding: 20px; border-radius: 12px; display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.9rem; }
        .form-control { padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: 'Cairo'; width: 200px; }
        
        .btn { padding: 10px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-family: 'Cairo'; color: #fff; display: inline-flex; align-items: center; gap: 8px; transition: 0.3s; }
        .btn-primary { background: var(--p); }
        .btn-success { background: var(--g); }

        .progress-container { display: none; margin-bottom: 25px; background: #fff; padding: 25px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .progress-steps { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .step { flex: 1; text-align: center; color: #ccc; font-size: 0.85rem; }
        .step.active { color: var(--p); font-weight: bold; }
        .step i { display: block; font-size: 1.5rem; margin-bottom: 5px; }

        .box { background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .box-header { background: var(--d); color: #fff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; color: var(--d); padding: 15px; text-align: right; border-bottom: 2px solid #eee; }
        td { padding: 12px 15px; border-bottom: 1px solid #eee; }
        .product-row { cursor: pointer; }
        .product-row:hover { background: #f1faff; }
        .details-row { display: none; background: #fcfcfc; }
        .sub-table th { background: #eee; font-size: 0.85rem; color: #555; }

        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav-btn { background: #e0e0e0; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-family: 'Cairo'; font-weight: bold; }
        .nav-btn.active { background: var(--p); color: #fff; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; color: #fff; }
        .bg-gold { background: var(--o); }
        .bg-silver { background: #bdc3c7; }
    </style>
</head>
<body>

<div class="container">
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-info"><h3>إجمالي البونص</h3><p id="totalBonus">0.00</p></div>
            <i class="fas fa-coins stat-icon" style="color:var(--p)"></i>
        </div>
        <div class="stat-card" style="border-color: var(--g);">
            <div class="stat-info"><h3>المبيعات المحققة</h3><p id="totalSales">0.00</p></div>
            <i class="fas fa-chart-line stat-icon" style="color:var(--g)"></i>
        </div>
        <div class="stat-card" style="border-color: var(--r);">
            <div class="stat-info"><h3>عدد الفواتير</h3><p id="invCount">0</p></div>
            <i class="fas fa-file-invoice stat-icon" style="color:var(--r)"></i>
        </div>
    </div>

    <div class="toolbar">
        <div class="form-group">
            <label>شهر السداد (الحساب)</label>
            <input type="month" id="targetMonth" class="form-control">
        </div>
        <div class="form-group">
            <label>المندوب</label>
            <select id="repFilter" class="form-control" onchange="renderReport()"><option value="all">الكل</option></select>
        </div>
        <button class="btn btn-primary" onclick="startFetching()"><i class="fas fa-sync-alt"></i> جلب ومسح البيانات</button>
        <button class="btn btn-success" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> تصدير إكسل</button>
    </div>

    <div class="progress-container" id="progressBox">
        <div class="progress-steps">
            <div class="step" id="step1"><i class="fas fa-box"></i>المنتجات</div>
            <div class="step" id="step2"><i class="fas fa-ruler"></i>الوحدات</div>
            <div class="step" id="step3"><i class="fas fa-file-invoice"></i>الفواتير (3 أشهر)</div>
            <div class="step" id="step4"><i class="fas fa-calculator"></i>المعالجة</div>
        </div>
        <div id="loadingText" style="font-weight: bold; color: var(--p);">بانتظار البدء...</div>
    </div>

    <div class="nav-tabs">
        <button class="nav-btn active" onclick="switchTab('report', this)">تقرير البونص</button>
        <button class="nav-btn" onclick="switchTab('settings', this)">إعدادات الأهداف والتحويل</button>
    </div>

    <div id="report" class="tab-content">
        <div class="box">
            <div class="box-header"><h3><i class="fas fa-list"></i> تفاصيل المبيعات (اضغط على المنتج لرؤية الفواتير)</h3></div>
            <div id="reportContainer" style="padding: 40px; text-align: center; color: #999;">ابدأ جلب البيانات لعرض النتائج</div>
        </div>
    </div>

    <div id="settings" class="tab-content" style="display:none;">
        <div class="box">
            <div class="box-header">
                <h3><i class="fas fa-cogs"></i> تخصيص القواعد والتحويل</h3>
                <button class="btn btn-success" style="padding: 5px 15px;" onclick="saveSettings()">حفظ الإعدادات</button>
            </div>
            <div style="padding: 20px;">
                <table>
                    <thead><tr><th>المنتج</th><th>هدف بونص 2% (سعر)</th><th>المعامل</th><th>نوع التحويل</th></tr></thead>
                    <tbody id="settingsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
let DB = { products: [], invoices: [], units: {}, returns: {} };
let ReportData = [];
let Settings = JSON.parse(localStorage.getItem('Bonus_Rules_V3') || '{}');

document.getElementById('targetMonth').value = new Date().toISOString().slice(0, 7);

function switchTab(id, btn) {
    document.querySelectorAll('.tab-content').forEach(d => d.style.display = 'none');
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(id).style.display = 'block';
    btn.classList.add('active');
}

async function startFetching() {
    const pBox = document.getElementById('progressBox');
    const lText = document.getElementById('loadingText');
    pBox.style.display = 'block';

    try {
        updateStep(1, "جاري جلب المنتجات...");
        const pRes = await fetch('/api/data.js?type=products');
        const pData = await pRes.json(); DB.products = pData.data || [];

        updateStep(2, "جاري جلب الوحدات...");
        const uRes = await fetch('/api/data.js?type=units');
        const uData = await uRes.json(); (uData.data || []).forEach(u => DB.units[u.id] = u.name_ar || u.name_en);

        updateStep(3, "جاري مسح فواتير آخر 3 أشهر...");
        const iRes = await fetch('/api/data.js?type=invoices');
        const iData = await iRes.json(); DB.invoices = iData.data || [];

        const rRes = await fetch('/api/data.js?type=returns');
        const rData = await rRes.json(); (rData.data || []).forEach(cn => {
            if(cn.invoice_reference) {
                if(!DB.returns[cn.invoice_reference]) DB.returns[cn.invoice_reference] = [];
                DB.returns[cn.invoice_reference].push(cn);
            }
        });

        updateStep(4, "جاري المعالجة والمطابقة...");
        renderSettingsTable();
        processData();
        pBox.style.display = 'none';
    } catch (e) { lText.innerHTML = `<span style="color:red">خطأ: ${e.message}</span>`; }
}

function updateStep(n, t) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById(`step${n}`).classList.add('active');
    document.getElementById('loadingText').innerText = t;
}

function processData() {
    ReportData = [];
    const tMonth = document.getElementById('targetMonth').value;
    const [tY, tM] = tMonth.split('-');

    DB.products.forEach(prod => {
        const conf = Settings[prod.id] || { threshold: 0, factor: 1, mode: 'none' };
        let pSales = 0, pBonus = 0, pInvs = [];

        DB.invoices.forEach(inv => {
            if (inv.status !== 'Paid' || !inv.payment_date) return;
            const [pY, pM] = inv.payment_date.split('-');
            if (pY !== tY || pM !== tM) return;

            const items = inv.line_items || inv.inventory_items || inv.invoice_items || [];
            items.forEach(item => {
                if (String(item.product_id) === String(prod.id)) {
                    let qty = parseFloat(item.quantity) || 0;
                    if (DB.returns[inv.reference]) {
                        DB.returns[inv.reference].forEach(cn => {
                            (cn.line_items || cn.inventory_items || []).forEach(ci => {
                                if (String(ci.product_id) === String(prod.id)) qty -= parseFloat(ci.quantity) || 0;
                            });
                        });
                    }
                    if (qty <= 0) return;

                    let fQty = qty;
                    if (conf.mode === 'div' && conf.factor > 0) fQty = qty / conf.factor;
                    else if (conf.mode === 'mul') fQty = qty * conf.factor;

                    let price = parseFloat(item.unit_price) || 0;
                    if (conf.mode === 'div' && conf.factor > 0) price *= conf.factor;

                    let total = fQty * price;
                    let rate = (conf.threshold > 0 && price >= conf.threshold) ? 2 : 1;
                    let bonus = (total * rate) / 100;

                    pInvs.push({ ref: inv.reference, rep: inv.creator, date: inv.payment_date, qty: fQty, price, total, rate, bonus });
                    pSales += total; pBonus += bonus;
                }
            });
        });

        if (pInvs.length > 0) {
            ReportData.push({ id: prod.id, name: prod.name_ar || prod.name_en, sales: pSales, bonus: pBonus, invs: pInvs });
        }
    });
    renderReport();
}

function renderReport() {
    const cont = document.getElementById('reportContainer');
    const repF = document.getElementById('repFilter').value;
    
    let allReps = new Set();
    ReportData.forEach(p => p.invs.forEach(i => allReps.add(i.rep)));
    const sel = document.getElementById('repFilter');
    if(sel.options.length === 1) [...allReps].sort().forEach(r => sel.innerHTML += `<option value="${r}">${r}</option>`);

    let html = `<table><thead><tr><th>المنتج</th><th>عدد الفواتير</th><th>إجمالي المبيعات</th><th>إجمالي البونص</th></tr></thead><tbody>`;
    let gSales = 0, gBonus = 0, gInv = 0;

    ReportData.forEach(p => {
        let vInvs = repF === 'all' ? p.invs : p.invs.filter(i => i.rep === repF);
        if (vInvs.length === 0) return;

        let s = vInvs.reduce((a,b) => a + b.total, 0), b = vInvs.reduce((a,b) => a + b.bonus, 0);
        gSales += s; gBonus += b; gInv += vInvs.length;

        html += `<tr class="product-row" onclick="toggleDetails(${p.id})">
            <td style="font-weight:bold; color:var(--p);"><i class="fas fa-plus-circle" id="icon_${p.id}"></i> ${p.name}</td>
            <td>${vInvs.length}</td><td>${s.toLocaleString()}</td><td style="color:var(--g); font-weight:bold;">${b.toLocaleString()}</td>
        </tr>
        <tr id="details_${p.id}" class="details-row"><td colspan="4"><table class="sub-table">
            <thead><tr><th>الفاتورة</th><th>المندوب</th><th>تاريخ الدفع</th><th>الكمية</th><th>السعر</th><th>الإجمالي</th><th>بونص</th></tr></thead>
            <tbody>${vInvs.map(i => `<tr><td>${i.ref}</td><td>${i.rep}</td><td>${i.date}</td><td>${i.qty.toFixed(2)}</td><td>${i.price.toFixed(2)}</td><td>${i.total.toFixed(2)}</td><td><span class="badge ${i.rate===2?'bg-gold':'bg-silver'}">${i.bonus.toFixed(2)}</span></td></tr>`).join('')}</tbody>
        </table></td></tr>`;
    });

    cont.innerHTML = html + `</tbody></table>`;
    document.getElementById('totalSales').innerText = gSales.toLocaleString();
    document.getElementById('totalBonus').innerText = gBonus.toLocaleString();
    document.getElementById('invCount').innerText = gInv;
}

function toggleDetails(id) {
    const row = document.getElementById(`details_${id}`);
    const icon = document.getElementById(`icon_${id}`);
    const isVisible = row.style.display === 'table-row';
    row.style.display = isVisible ? 'none' : 'table-row';
    icon.className = isVisible ? 'fas fa-plus-circle' : 'fas fa-minus-circle';
}

function renderSettingsTable() {
    const body = document.getElementById('settingsTableBody'); body.innerHTML = '';
    DB.products.sort((a,b) => (a.name_ar||"").localeCompare(b.name_ar||"")).forEach(p => {
        const c = Settings[p.id] || { threshold: 0, factor: 1, mode: 'none' };
        body.innerHTML += `<tr>
            <td>${p.name_ar || p.name_en}</td>
            <td><input type="number" id="thr_${p.id}" value="${c.threshold}" class="form-control" style="width:80px"></td>
            <td><input type="number" id="fac_${p.id}" value="${c.factor}" class="form-control" style="width:80px"></td>
            <td><select id="mod_${p.id}" class="form-control" style="width:110px">
                <option value="none" ${c.mode==='none'?'selected':''}>بدون</option>
                <option value="div" ${c.mode==='div'?'selected':''}>قسمة (حبة->ك)</option>
                <option value="mul" ${c.mode==='mul'?'selected':''}>ضرب (ك->حبة)</option>
            </select></td>
        </tr>`;
    });
}

function saveSettings() {
    DB.products.forEach(p => {
        const t = document.getElementById(`thr_${p.id}`);
        if(t) Settings[p.id] = { threshold: parseFloat(t.value) || 0, factor: parseFloat(document.getElementById(`fac_${p.id}`).value) || 1, mode: document.getElementById(`mod_${p.id}`).value };
    });
    localStorage.setItem('Bonus_Rules_V3', JSON.stringify(Settings)); alert("تم الحفظ."); processData();
}

async function exportToExcel() {
    if(ReportData.length === 0) return alert("لا توجد بيانات");
    const wb = new ExcelJS.Workbook(); const ws = wb.addWorksheet('تقرير البونص');
    ws.columns = [
        {header:'المنتج',key:'p',width:30}, {header:'المندوب',key:'m',width:20}, {header:'الفاتورة',key:'r',width:15},
        {header:'التاريخ',key:'d',width:15}, {header:'الكمية',key:'q',width:10}, {header:'الإجمالي',key:'t',width:15}, {header:'البونص',key:'b',width:15}
    ];
    ws.getRow(1).font = {bold:true};
    ReportData.forEach(p => p.invs.forEach(i => ws.addRow({p:p.name, m:i.rep, r:i.ref, d:i.date, q:i.qty, t:i.total, b:i.bonus})));
    const buf = await wb.xlsx.writeBuffer(); saveAs(new Blob([buf]), 'Bonus_Report.xlsx');
}
</script>
</body>
</html>
