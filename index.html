<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>نظام العمولات الذكي V23 (قاموس الأسعار الكامل)</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root{--p:#2c3e50; --acc:#2980b9; --bg:#f4f6f9; --g:#27ae60; --r:#c0392b;}
        body{font-family:'Cairo', sans-serif; background:var(--bg); padding:20px; color:var(--p);}
        .box{background:#fff; border-radius:15px; max-width:1550px; margin:auto; box-shadow:0 4px 25px rgba(0,0,0,0.1); overflow:hidden;}
        .tabs-header{display:flex; background:var(--p); color:#fff;}
        .tab-btn{padding:15px 25px; cursor:pointer; background:transparent; border:none; color:#ccc; font-weight:bold; font-family:'Cairo'; transition:0.3s;}
        .tab-btn.active{background:#fff; color:var(--p); border-top:4px solid var(--acc);}
        .tab-content{display:none; padding:20px;}
        .tab-content.active{display:block;}
        .stats{display:flex; gap:15px; margin-bottom:20px; flex-wrap:wrap;}
        .card{flex:1; background:var(--p); color:#fff; padding:15px; border-radius:10px; text-align:center; min-width:200px;}
        .card-val{font-size:1.6em; font-weight:bold;}
        table{width:100%; border-collapse:collapse; margin-top:10px;}
        th{background:#f8f9fa; padding:12px; text-align:right; border-bottom:2px solid #ddd; position:sticky; top:0; z-index:10;}
        td{padding:10px; border-bottom:1px solid #eee; vertical-align:middle;}
        .badge{padding:4px 10px; border-radius:12px; font-size:0.85em; font-weight:bold;}
        .badge-p{background:#d4edda; color:#155724; border:1px solid #c3e6cb;}
        .badge-b{background:#fff3cd; color:#856404; border:1px solid #ffeeba;}
        .badge-r{background:#f8d7da; color:#721c24; border:1px solid #f5c6cb;}
        .rep-select{padding:5px; border-radius:4px; border:1px solid #ddd; font-family:'Cairo'; width:100%;}
        .btn{padding:10px 18px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; font-family:'Cairo'; transition:0.3s;}
        .btn-acc{background:var(--acc); color:#fff;}
        .btn-g{background:var(--g); color:#fff;}
        .btn-r{background:var(--r); color:#fff;}
        .tbl-input{width:70px; text-align:center; padding:5px; border:1px solid #ccc; border-radius:4px;}
        .auto-tag {font-size: 0.7em; background: #e1f5fe; color: #0277bd; padding: 2px 5px; border-radius: 4px; margin-right: 5px;}
    </style>
</head>
<body>

<div class="box">
    <div class="tabs-header">
        <button class="tab-btn active" onclick="switchTab('main')"><i class="fas fa-money-bill-wave"></i> البونص المستحق</button>
        <button class="tab-btn" onclick="switchTab('suspended')"><i class="fas fa-clock"></i> المعلق</button>
        <button class="tab-btn" onclick="switchTab('products')"><i class="fas fa-magic"></i> الأسعار (الذكية)</button>
        <button class="tab-btn" onclick="switchTab('targets')"><i class="fas fa-bullseye"></i> التارجت</button>
        <button class="tab-btn" onclick="switchTab('backup')"><i class="fas fa-database"></i> النسخ الاحتياطي</button>
    </div>

    <div id="tab-main" class="tab-content active">
        <div style="display:flex; gap:15px; align-items:flex-end; margin-bottom:20px; background:#f8f9fa; padding:15px; border-radius:10px;">
            <div><label>الشهر</label><br><input type="month" id="targetMonth" style="padding:8px; border-radius:5px; border:1px solid #ccc;"></div>
            <div><label>المندوب</label><br><select id="creatorFilter" onchange="renderUI()" class="rep-select" style="width:200px;"></select></div>
            <button class="btn btn-acc" onclick="fetchData()"><i class="fas fa-sync"></i> جلب وحساب (تلقائي)</button>
            <button class="btn btn-g" onclick="exportExcel()"><i class="fas fa-file-excel"></i> تصدير</button>
        </div>
        <div class="stats">
            <div class="card"><h3>المبيعات (الصافي)</h3><div id="stat-sales" class="card-val">0</div></div>
            <div class="card" style="background:var(--acc)"><h3>البونص المستحق</h3><div id="stat-bonus" class="card-val">0</div></div>
            <div class="card" style="background:#e67e22"><h3>التارجت</h3><div id="stat-target" class="card-val">-</div></div>
        </div>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>المرجع</th><th>المندوب</th><th>المنتج</th><th>الكمية</th><th>سعر الكرتون</th><th>الحالة</th><th>النسبة</th><th>البونص</th><th>تحكم</th>
                    </tr>
                </thead>
                <tbody id="mainRows"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-suspended" class="tab-content">
        <div class="card" style="max-width:300px; background:#7f8c8d; margin-bottom:20px;">
            <h3>بونص متوقع (تحت التحصيل)</h3><div id="stat-susp-bonus" class="card-val">0</div>
        </div>
        <table>
            <thead><tr><th>المرجع</th><th>المندوب</th><th>المنتج</th><th>تاريخ الفاتورة</th><th>البونص المتوقع</th><th>إعادة</th></tr></thead>
            <tbody id="suspRows"></tbody>
        </table>
    </div>

    <div id="tab-products" class="tab-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <h3><i class="fas fa-robot"></i> إعدادات الأسعار (ضبط تلقائي حسب القائمة)</h3>
            <div>
                <button class="btn btn-acc" onclick="applySmartRules(true)"><i class="fas fa-redo"></i> إعادة ضبط تلقائي</button>
                <button class="btn btn-g" onclick="saveProductRules()"><i class="fas fa-save"></i> حفظ التعديلات</button>
            </div>
        </div>
        <table>
            <thead><tr><th>المنتج</th><th>معامل الكرتون</th><th>سعر التميز (>=)</th><th>نسبة %</th><th>السعر الأساسي (>=)</th><th>نسبة %</th></tr></thead>
            <tbody id="prodRows"></tbody>
        </table>
    </div>

    <div id="tab-targets" class="tab-content">
        <button class="btn btn-g" onclick="saveTargetRules()" style="float:left;">حفظ التارجت</button>
        <h3>أهداف المناديب</h3>
        <table>
            <thead><tr><th>المندوب</th><th>المبيعات</th><th>الهدف</th><th>المكافأة</th><th>حجب؟</th><th>الحالة</th></tr></thead>
            <tbody id="targetRows"></tbody>
        </table>
    </div>

    <div id="tab-backup" class="tab-content">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:30px; padding:30px;">
            <div style="border:2px dashed #ccc; padding:30px; text-align:center; border-radius:15px;">
                <i class="fas fa-file-export fa-3x" style="color:var(--acc)"></i>
                <h3>تصدير</h3>
                <button class="btn btn-acc" onclick="exportBackup()"><i class="fas fa-download"></i> تحميل JSON</button>
            </div>
            <div style="border:2px dashed #ccc; padding:30px; text-align:center; border-radius:15px;">
                <i class="fas fa-file-import fa-3x" style="color:var(--g)"></i>
                <h3>استيراد</h3>
                <input type="file" id="importFile" style="display:none" onchange="importBackup(event)">
                <button class="btn btn-g" onclick="document.getElementById('importFile').click()"><i class="fas fa-upload"></i> رفع</button>
            </div>
        </div>
    </div>
</div>

<script>
    const DEFERRED_SKU = "754500950512";
    let rawInvoices = [], productsMap = {}, unitsMap = {}, creators = [];
    let creditNotesMap = {}; 
    let computed = [], suspended = [];

    let productRules = JSON.parse(localStorage.getItem('pRules_v23') || "{}");
    let targetRules = JSON.parse(localStorage.getItem('tRules_v23') || "{}");
    let repOverrides = JSON.parse(localStorage.getItem('repOverrides_v23') || "{}");
    let manualDeferred = JSON.parse(localStorage.getItem('manualDef_v23') || "[]");

    // --- القاموس الذكي الشامل (V23) ---
    // تم تفريغ بياناتك هنا بدقة لربط الاسم بالسعر
    const AUTO_RULES = [
        // 1. الورق (أسعار الـ PDF)
        { keys: ["ورق الكاشير", "80*70", "8070"], pp: 69, bp: 68 },
        { keys: ["A4"], pp: 58, bp: 57 },
        { keys: ["ورق الشبكة", "40*57", "57*40"], pp: 57, bp: 56 },
        { keys: ["ورق التاريخ", "رول تاريخ"], pp: 75, bp: 74 },
        { keys: ["رول التسعيرة", "رول تسعير"], pp: 126, bp: 125 },

        // 2. الباركود (أسعار الـ PDF)
        { keys: ["40*60", "60*40"], pp: 221, bp: 220 },
        { keys: ["25*50", "50*25"], pp: 241, bp: 240 },
        { keys: ["38*28", "28*38"], pp: 241, bp: 240 },
        { keys: ["40*22", "22*40"], pp: 241, bp: 240 },
        { keys: ["100*150", "150*100"], pp: 331, bp: 330 },
        { keys: ["38*15"], pp: 241, bp: 240 }, // افتراض نفس السعر للرول الصغير أو يتم تعديله

        // 3. الأحبار والطابعات (2% ثابتة)
        { 
            keys: [
                "حبر", "طابعة", "مكينة", "قارئ", "DRUM", "toner", "ink", 
                "ezpos", "zpos", "GT53", "GT52", "TN", "XEROX", "17A", "103A", "305", "A44", "A150", "283A", "83A", "A106"
            ], 
            pp: 1, ppct: 2, bp: 0, bpct: 0 // تميز 2% لأي سعر فوق 1 ريال
        },

        // 4. المتنوعات (تحتاج تحديد سعر إذا لم تكن في الملف، سأضعها لتسهيل البحث)
        { keys: ["ملف اسود", "ملف شفاف"], pp: 0, bp: 0 }, // سيتعرف عليها لكن ينتظر سعرك
        { keys: ["تيب"], pp: 0, bp: 0 }
    ];

    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + id).classList.add('active');
    }

    async function fetchData() {
        const month = document.getElementById('targetMonth').value;
        const btn = document.querySelector('.btn-acc');
        if(!month) return alert("حدد الشهر!");
        
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الذكاء...';
        try {
            const res = await fetch(`/api/get-data?month=${month}`);
            const data = await res.json();
            
            rawInvoices = data.invoices || [];
            productsMap = data.productsMap || {};
            
            unitsMap = {};
            if(data.product_units) {
                data.product_units.forEach(u => {
                    unitsMap[u.id] = parseFloat(u.conversion_factor || u.representation || 1);
                });
            }
            
            creditNotesMap = {};
            if(data.credit_notes) data.credit_notes.forEach(cn => creditNotesMap[cn.id] = cn);
            
            creators = [...new Set(rawInvoices.map(i => i.created_by).filter(Boolean))];
            updateFilterDropdown();

            // تطبيق الذكاء التلقائي
            applySmartRules(); 
            
            processLogic();
            btn.innerHTML = '<i class="fas fa-check"></i> تم التحديث';
        } catch (e) { console.error(e); alert("خطأ اتصال"); btn.innerHTML = 'خطأ'; }
    }

    function applySmartRules(force = false) {
        let updatedCount = 0;
        Object.keys(productsMap).forEach(id => {
            // لا نغير ما تم ضبطه يدوياً إلا إذا أجبرنا النظام (force)
            if (!force && productRules[id] && (productRules[id].premiumPrice > 0 || productRules[id].premiumPct > 0)) return;

            const prodName = productsMap[id].name.toLowerCase();
            
            for (let rule of AUTO_RULES) {
                const match = rule.keys.some(k => prodName.includes(k.toLowerCase()));
                if (match) {
                    productRules[id] = {
                        factor: productRules[id]?.factor || 0,
                        premiumPrice: rule.pp,
                        premiumPct: rule.ppct !== undefined ? rule.ppct : 2,
                        basePrice: rule.bp,
                        basePct: rule.bpct !== undefined ? rule.bpct : 1
                    };
                    updatedCount++;
                    break;
                }
            }
        });
        if (updatedCount > 0) {
            localStorage.setItem('pRules_v23', JSON.stringify(productRules));
            if(force) alert(`تم ضبط أسعار ${updatedCount} صنف تلقائياً!`);
        } else if (force) {
            alert("لم يتم العثور على منتجات جديدة لمطابقتها.");
        }
    }

    function updateFilterDropdown() {
        const select = document.getElementById('creatorFilter');
        const currentVal = select.value || 'all';
        select.innerHTML = '<option value="all">كل المناديب</option>';
        creators.forEach(c => select.innerHTML += `<option value="${c}">${c}</option>`);
        select.value = currentVal;
    }

    function processLogic() {
        computed = []; suspended = [];
        const tMonthStr = document.getElementById('targetMonth').value;
        const [tYear, tMonth] = tMonthStr.split('-').map(Number);

        rawInvoices.forEach(inv => {
            const isManualDef = manualDeferred.includes(inv.id);
            const status = inv.status;
            const payDate = new Date(inv.updated_at || inv.issue_date);
            const isCurrentMonth = (payDate.getMonth() + 1 === tMonth && payDate.getFullYear() === tYear);
            const currentRep = repOverrides[inv.id] || inv.created_by;

            // المرتجعات
            let specificReturns = {};
            let generalReturnRatio = 0;
            if(inv.allocations) {
                inv.allocations.forEach(alloc => {
                    if(alloc.source_type === 'CreditNote') {
                        const cn = creditNotesMap[alloc.source_id];
                        if(cn && cn.line_items) {
                            cn.line_items.forEach(cnItem => {
                                specificReturns[cnItem.product_id] = (specificReturns[cnItem.product_id] || 0) + parseFloat(cnItem.quantity);
                            });
                        } else {
                            generalReturnRatio += parseFloat(alloc.amount || 0);
                        }
                    }
                });
            }
            const fallbackRatio = generalReturnRatio / (parseFloat(inv.total) || 1);

            inv.line_items.forEach(item => {
                if(item.sku === DEFERRED_SKU) return;
                
                const pid = item.product_id;
                const rule = productRules[pid] || {};
                
                let apiFactor = unitsMap[item.unit_type];
                let manualFactor = parseFloat(rule.factor);
                let finalFactor = apiFactor || (manualFactor > 1 ? manualFactor : 1);
                
                const originalQty = parseFloat(item.quantity);
                let netQty = originalQty;
                let returnQtyDisplay = 0;

                if (specificReturns[pid]) {
                    netQty = Math.max(0, originalQty - specificReturns[pid]);
                    returnQtyDisplay = specificReturns[pid];
                } else if (fallbackRatio > 0) {
                    const deduction = originalQty * fallbackRatio;
                    netQty = Math.max(0, originalQty - deduction);
                    returnQtyDisplay = deduction;
                }
                
                if(netQty <= 0.01) return;

                const sellPriceVAT = parseFloat(item.unit_price) * 1.15;
                const cartonPriceVAT = sellPriceVAT * finalFactor; 
                const totalRowVAT = sellPriceVAT * netQty;

                // Waterfall Logic
                let pct = 0; let tier = "أقل من الحد"; let badge = "badge-r";
                const pPrice = parseFloat(rule.premiumPrice || 0);
                const bPrice = parseFloat(rule.basePrice || 0);

                if (pPrice > 0 && cartonPriceVAT >= pPrice) {
                    pct = rule.premiumPct || 2; tier = "تميز"; badge = "badge-p";
                } else if (bPrice > 0 && cartonPriceVAT >= bPrice) {
                    pct = rule.basePct || 1; tier = "أساسي"; badge = "badge-b";
                } else if (rule.premiumPct > 0 && pPrice <= 1) { 
                    // حالة خاصة للأحبار (سعر الهدف صغير جداً)
                    pct = rule.premiumPct; tier = "تلقائي"; badge = "badge-p";
                }

                const bonus = totalRowVAT * (pct / 100);
                const qtyText = returnQtyDisplay > 0 ? `${originalQty} <span style='color:red;font-size:0.8em'>(-${returnQtyDisplay.toFixed(1)})</span>` : `${netQty.toFixed(1)}`;

                const record = { 
                    invId: inv.id, ref: inv.reference, rep: currentRep, 
                    prod: item.product_name, date: inv.issue_date, 
                    sellCarton: cartonPriceVAT, tier, badge, pct, bonus, total: totalRowVAT,
                    qtyDisplay: qtyText
                };

                if(status === 'Paid' && isCurrentMonth && !isManualDef) {
                    computed.push(record);
                } else {
                    suspended.push(record);
                }
            });
        });
        renderUI();
    }

    function renderUI() {
        const rows = document.getElementById('mainRows'); rows.innerHTML = '';
        const filter = document.getElementById('creatorFilter').value;
        const filtered = computed.filter(d => filter === 'all' || d.rep === filter);
        let totalS = 0, totalB = 0;
        filtered.forEach(r => {
            totalS += r.total; totalB += r.bonus;
            rows.innerHTML += `<tr>
                <td>${r.ref}</td><td>${r.rep}</td>
                <td style="font-size:0.9em">${r.prod}</td>
                <td>${r.qtyDisplay}</td><td>${r.sellCarton.toFixed(2)}</td>
                <td><span class="badge ${r.badge}">${r.tier}</span></td><td>${r.pct}%</td>
                <td style="font-weight:bold">${r.bonus.toFixed(2)}</td>
                <td><button onclick="moveToDef(${r.invId})" class="btn-r" style="padding:2px 5px">آجل</button></td>
            </tr>`;
        });
        document.getElementById('stat-sales').innerText = totalS.toLocaleString();
        document.getElementById('stat-bonus').innerText = totalB.toLocaleString();
        renderSuspended(); renderProductRules(); renderTargetTable();
    }

    function renderSuspended() {
        const rows = document.getElementById('suspRows'); rows.innerHTML = '';
        const filter = document.getElementById('creatorFilter').value;
        const filteredSusp = suspended.filter(d => filter === 'all' || d.rep === filter);
        let sBonus = 0;
        filteredSusp.forEach(r => {
            sBonus += r.bonus;
            rows.innerHTML += `<tr><td>${r.ref}</td><td>${r.rep}</td><td>${r.prod}</td><td>${r.date}</td><td>${r.bonus.toFixed(2)}</td><td><button class="btn-g" style="padding:2px 5px" onclick="restoreDef(${r.invId})">إعادة</button></td></tr>`;
        });
        document.getElementById('stat-susp-bonus').innerText = sBonus.toLocaleString();
    }

    function changeRep(id, name) { repOverrides[id] = name; localStorage.setItem('repOverrides_v23', JSON.stringify(repOverrides)); processLogic(); }
    function moveToDef(id) { if(!manualDeferred.includes(id)) manualDeferred.push(id); localStorage.setItem('manualDef_v23', JSON.stringify(manualDeferred)); processLogic(); }
    function restoreDef(id) { manualDeferred = manualDeferred.filter(x => x !== id); localStorage.setItem('manualDef_v23', JSON.stringify(manualDeferred)); processLogic(); }
    
    function renderProductRules() {
        const rows = document.getElementById('prodRows'); rows.innerHTML = '';
        Object.keys(productsMap).forEach(id => {
            const p = productsMap[id]; const r = productRules[id] || {};
            const isAuto = AUTO_RULES.some(rule => rule.keys.some(k => p.name.includes(k))); 
            const nameHtml = isAuto ? `<span class="auto-tag">T</span> ${p.name}` : p.name;

            rows.innerHTML += `<tr>
                <td style="font-size:0.9em">${nameHtml}</td>
                <td><input type="number" class="tbl-input" id="f_${id}" value="${r.factor || 0}" placeholder="تلقائي"></td>
                <td><input type="number" class="tbl-input" id="pp_${id}" value="${r.premiumPrice || 0}"></td>
                <td><input type="number" class="tbl-input" id="ppct_${id}" value="${r.premiumPct || 2}"></td>
                <td><input type="number" class="tbl-input" id="bp_${id}" value="${r.basePrice || 0}"></td>
                <td><input type="number" class="tbl-input" id="bpct_${id}" value="${r.basePct || 1}"></td>
            </tr>`;
        });
    }

    function saveProductRules() {
        Object.keys(productsMap).forEach(id => {
            productRules[id] = {
                factor: parseFloat(document.getElementById(`f_${id}`).value) || 0,
                premiumPrice: parseFloat(document.getElementById(`pp_${id}`).value) || 0,
                premiumPct: parseFloat(document.getElementById(`ppct_${id}`).value) || 0,
                basePrice: parseFloat(document.getElementById(`bp_${id}`).value) || 0,
                basePct: parseFloat(document.getElementById(`bpct_${id}`).value) || 0
            };
        });
        localStorage.setItem('pRules_v23', JSON.stringify(productRules)); alert("تم الحفظ."); processLogic();
    }

    function renderTargetTable() { 
        const rows = document.getElementById('targetRows'); rows.innerHTML = '';
        creators.forEach(c => {
            const r = targetRules[c] || {amt:0, rwd:0, blk:false};
            const sales = computed.filter(d => d.rep === c).reduce((a,b)=>a+b.total, 0);
            rows.innerHTML += `<tr><td><b>${c}</b></td><td>${sales.toLocaleString()}</td><td><input type="number" class="tbl-input" id="ta_${c}" value="${r.amt}"></td><td><input type="number" class="tbl-input" id="tr_${c}" value="${r.rwd}"></td><td><input type="checkbox" id="tk_${c}" ${r.blk?'checked':''}></td><td>${sales >= r.amt ? '✅' : '❌'}</td></tr>`;
        });
    }
    function saveTargetRules() {
        creators.forEach(c => {
            targetRules[c] = {
                amt: parseFloat(document.getElementById(`ta_${c}`).value) || 0,
                rwd: parseFloat(document.getElementById(`tr_${c}`).value) || 0,
                blk: document.getElementById(`tk_${c}`).checked
            };
        });
        localStorage.setItem('tRules_v23', JSON.stringify(targetRules)); alert("تم الحفظ."); processLogic();
    }
    function exportBackup() {
        const data = { pRules: productRules, tRules: targetRules, rep: repOverrides };
        const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "Bonus_Backup_V23.json"; a.click();
    }
    function importBackup(e) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const data = JSON.parse(ev.target.result);
            productRules = data.pRules || {}; targetRules = data.tRules || {}; repOverrides = data.rep || {};
            localStorage.setItem('pRules_v23', JSON.stringify(productRules));
            localStorage.setItem('tRules_v23', JSON.stringify(targetRules));
            localStorage.setItem('repOverrides_v23', JSON.stringify(repOverrides));
            processLogic(); alert("تم الاستيراد بنجاح!");
        };
        reader.readAsText(e.target.files[0]);
    }
</script>
</body>
</html>
