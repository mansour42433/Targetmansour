<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>نظام العمولات V47</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root{--p:#2c3e50; --acc:#2980b9; --bg:#f4f6f9; --g:#27ae60; --r:#c0392b;}
        body{font-family:'Cairo', sans-serif; background:var(--bg); padding:20px; color:var(--p);}
        .box{background:#fff; border-radius:15px; max-width:1600px; margin:auto; box-shadow:0 4px 25px rgba(0,0,0,0.1); overflow:hidden;}
        .tabs-header{display:flex; background:var(--p); color:#fff;}
        .tab-btn{padding:15px 25px; cursor:pointer; background:transparent; border:none; color:#ccc; font-weight:bold; font-family:'Cairo'; transition:0.3s; flex:1;}
        .tab-btn.active{background:#fff; color:var(--p); border-top:4px solid var(--acc);}
        .tab-content{display:none; padding:25px;}
        .tab-content.active{display:block;}
        .stats{display:flex; gap:15px; margin-bottom:20px; flex-wrap:wrap;}
        .card{flex:1; background:var(--p); color:#fff; padding:20px; border-radius:12px; text-align:center; min-width:200px;}
        .card-val{font-size:1.8em; font-weight:bold; margin-top:5px;}
        table{width:100%; border-collapse:collapse; margin-top:15px;}
        th{background:#f8f9fa; padding:12px; text-align:right; border-bottom:2px solid #ddd; position:sticky; top:0; z-index:10;}
        td{padding:10px; border-bottom:1px solid #eee; vertical-align:middle;}
        .badge{padding:4px 10px; border-radius:15px; font-size:0.85em; font-weight:bold;}
        .ok{background:#d4edda; color:#155724;} .mid{background:#fff3cd; color:#856404;} .no{background:#f8d7da; color:#721c24;}
        .btn{padding:10px 18px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; font-family:'Cairo'; margin-left:5px;}
        .btn-acc{background:var(--acc); color:#fff;} .btn-g{background:var(--g); color:#fff;}
    </style>
</head>
<body>

<div class="box">
    <div class="tabs-header">
        <button class="tab-btn active" onclick="switchTab('bonus')"><i class="fas fa-coins"></i> البونص المستحق</button>
        <button class="tab-btn" onclick="switchTab('excluded')"><i class="fas fa-ban"></i> المستبعدة</button>
        <button class="tab-btn" onclick="switchTab('products')"><i class="fas fa-box"></i> المنتجات</button>
        <button class="tab-btn" onclick="switchTab('targets')"><i class="fas fa-bullseye"></i> التارجت</button>
        <button class="tab-btn" onclick="switchTab('settings')"><i class="fas fa-cog"></i> الإعدادات</button>
    </div>

    <div style="padding:20px; background:#f8f9fa; display:flex; gap:15px; align-items:flex-end;">
        <div><label>شهر الحساب</label><br><input type="month" id="targetMonth" style="padding:8px; border-radius:5px; border:1px solid #ccc;"></div>
        <div><label>المندوب</label><br><select id="creatorFilter" onchange="renderUI()" style="padding:8px; width:200px; border-radius:5px;"></select></div>
        <button class="btn btn-acc" onclick="fetchData()">جلب البيانات (أحدث 2500)</button>
        <button class="btn btn-g" onclick="exportExcel()">تصدير إكسيل</button>
    </div>

    <div id="tab-bonus" class="tab-content active">
        <div class="stats">
            <div class="card"><h3>إجمالي المبيعات المحسوبة</h3><div id="st_sales" class="card-val">0</div></div>
            <div class="card" style="background:var(--acc)"><h3>إجمالي البونص</h3><div id="st_bonus" class="card-val">0</div></div>
            <div class="card" style="background:#e67e22"><h3>مكافآت التارجت</h3><div id="st_target_reward" class="card-val">0</div></div>
        </div>
        <table>
            <thead><tr><th>المرجع</th><th>المندوب</th><th>المنتج</th><th>الكمية</th><th>سعر الكرتون</th><th>النوع</th><th>%</th><th>البونص</th><th>تاريخ السداد</th></tr></thead>
            <tbody id="bonusRows"></tbody>
        </table>
    </div>

    <div id="tab-excluded" class="tab-content">
        <h3>الفواتير المستبعدة</h3>
        <table><thead><tr><th>المرجع</th><th>المندوب</th><th>الحالة</th><th>تاريخ الفاتورة</th><th>سبب الاستبعاد</th></tr></thead><tbody id="excludedRows"></tbody></table>
    </div>

    <div id="tab-products" class="tab-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <h3>إعدادات الأسعار</h3>
            <div><button class="btn btn-acc" onclick="applySmartRules(true)">ضبط تلقائي</button> <button class="btn btn-g" onclick="saveProductRules()">حفظ التعديلات</button></div>
        </div>
        <table><thead><tr><th>المنتج</th><th>معامل الكرتون</th><th>سعر التميز (>=)</th><th>%</th><th>سعر الأساسي (<=)</th><th>%</th></tr></thead><tbody id="productRows"></tbody></table>
    </div>

    <div id="tab-targets" class="tab-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <h3>أهداف المبيعات</h3>
            <button class="btn btn-g" onclick="saveTargetRules()">حفظ التارجت</button>
        </div>
        <table><thead><tr><th>المندوب</th><th>المبيعات المحققة</th><th>الهدف المطلوب</th><th>مكافأة التحقيق</th><th>الحالة</th></tr></thead><tbody id="targetRows"></tbody></table>
    </div>

    <div id="tab-settings" class="tab-content">
        <h3>النسخ الاحتياطي</h3>
        <button class="btn btn-acc" onclick="exportBackup()">تصدير الإعدادات</button>
        <input type="file" onchange="importBackup(event)" style="margin-right:10px;">
    </div>
</div>

<script>
    let rawInvoices=[], productsMap={}, unitsMapFactor={}, creditNotesMap={}, creators=[];
    let computed=[], excludedInvoices=[];
    
    let productRules = JSON.parse(localStorage.getItem('pRules_v47') || "{}");
    let targetRules = JSON.parse(localStorage.getItem('tRules_v47') || "{}");

    const AUTO_RULES = [
        { keys: ["ورق كاشير", "80*70"], pp: 69, bp: 68 },
        { keys: ["A4"], pp: 58, bp: 57 },
        { keys: ["رول تاريخ"], pp: 75, bp: 74 }
    ];

    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + id).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    async function fetchData() {
        const m = document.getElementById('targetMonth').value;
        if (!m) return alert("حدد الشهر أولاً");
        
        const btn = document.querySelector('.btn-acc');
        const oldTxt = btn.innerHTML;
        btn.innerHTML = 'جاري الاتصال...';
        btn.disabled = true;
        
        try {
            const res = await fetch(`/api/get-data?month=${m}`);
            const data = await res.json();

            // إذا كان هناك خطأ قادم من السيرفر، نعرضه بوضوح
            if (data.error) throw new Error(data.error);

            rawInvoices = data.invoices || [];
            productsMap = data.productsMap || {};
            
            unitsMapFactor = {};
            (data.product_units || []).forEach(u => unitsMapFactor[u.id] = parseFloat(u.conversion_factor || u.representation || 1));

            creditNotesMap = {};
            (data.credit_notes || []).forEach(cn => creditNotesMap[cn.id] = cn);
            
            creators = [...new Set(rawInvoices.map(i => i.created_by).filter(Boolean))];
            updateFilterDropdown();
            
            applySmartRules(); 
            processLogic();
            
            btn.innerHTML = 'تم الجلب';
            alert(`تم جلب ${rawInvoices.length} فاتورة بنجاح.`);

        } catch(e) {
            console.error(e); 
            alert("فشل الجلب:\n" + e.message); 
            btn.innerHTML = 'فشل';
        } finally {
            btn.disabled = false;
            setTimeout(() => { if(btn.innerHTML !== oldTxt) btn.innerHTML = oldTxt; }, 2000);
        }
    }

    function processLogic() {
        computed = [];
        excludedInvoices = [];
        const [tYear, tMonth] = document.getElementById("targetMonth").value.split("-").map(Number);

        rawInvoices.forEach(inv => {
            const baseInfo = { reference: inv.reference, rep: inv.created_by, status: inv.status, issue_date: inv.issue_date, total: inv.total };

            if (inv.status !== "Paid") {
                excludedInvoices.push({ ...baseInfo, reason: "غير مدفوعة (Paid Only)" });
                return;
            }

            const payments = inv.payments || [];
            const total = parseFloat(inv.total || 0);
            const totalPaid = payments.reduce((s, p) => s + parseFloat(p.amount || 0), 0);

            if (Math.abs(totalPaid - total) > 0.01) {
                excludedInvoices.push({ ...baseInfo, reason: "دفع جزئي" });
                return;
            }

            let isDeferred = false;
            let lastPaymentDate = inv.issue_date;
            if (payments.length > 0) {
                payments.forEach(p => {
                    if (p.date !== inv.issue_date) isDeferred = true;
                    if (new Date(p.date) > new Date(lastPaymentDate)) lastPaymentDate = p.date;
                });
            }

            const refDate = isDeferred ? lastPaymentDate : inv.issue_date;
            const d = new Date(refDate);

            // التحقق من الشهر المختار
            if (d.getFullYear() !== tYear || (d.getMonth() + 1) !== tMonth) {
                // الفواتير التي خارج الشهر لا تعتبر خطأ، لكن لا تحسب
                return;
            }

            let returns = {};
            (inv.allocations || []).forEach(a => {
                if (a.source_type === "CreditNote") {
                    const cn = creditNotesMap[a.source_id];
                    (cn?.line_items || []).forEach(li => returns[li.product_id] = (returns[li.product_id] || 0) + parseFloat(li.quantity || 0));
                }
            });

            let hasValidItems = false;
            inv.line_items.forEach(item => {
                const pid = item.product_id;
                const rule = productRules[pid] || {}; 
                const priceInclTax = parseFloat(item.unit_price || 0) * (1 + (parseFloat(item.tax_percent || 0) / 100));

                let mult = 1;
                const isCarton = (item.unit_type_name || "").includes("كرتون");
                
                if (!isCarton) {
                    if (parseFloat(rule.factor) > 0) mult = parseFloat(rule.factor);
                    else mult = unitsMapFactor[item.unit_type] || 1;
                }

                const cartonPrice = priceInclTax * mult;
                const netQty = Math.max(0, parseFloat(item.quantity || 0) - (returns[pid] || 0));

                if (netQty <= 0) return;

                let pct = 0; let tier = "أقل";
                const pPrice = parseFloat(rule.premiumPrice) || 70;
                const bPrice = parseFloat(rule.basePrice) || 0;

                if (cartonPrice >= pPrice) { pct = rule.premiumPct || 2; tier = "تميز"; }
                else if (cartonPrice > bPrice) { pct = rule.basePct || 1; tier = "أساسي"; }

                if (pct === 0) return;

                hasValidItems = true;
                computed.push({
                    ref: inv.reference, rep: inv.created_by, prod: productsMap[pid]?.name || item.product_name,
                    qty: netQty.toFixed(1), cartonPrice: cartonPrice, pct, bonus: (priceInclTax * netQty * (pct / 100)),
                    tier, date: refDate
                });
            });
            
            if (!hasValidItems) excludedInvoices.push({ ...baseInfo, reason: "لا توجد منتجات مستحقة" });
        });
        renderUI();
    }

    function renderUI() {
        const rows = document.getElementById('bonusRows'); rows.innerHTML = '';
        const f = document.getElementById('creatorFilter').value;
        const filtered = computed.filter(d => f === '' || f === 'all' || d.rep === f);
        
        let sT=0, bT=0;
        filtered.forEach(r => {
            sT += (r.cartonPrice * r.qty); bT += r.bonus;
            rows.innerHTML += `<tr><td>${r.ref}</td><td>${r.rep}</td><td>${r.prod}</td><td>${r.qty}</td><td>${r.cartonPrice.toFixed(2)}</td><td><span class="badge ${r.pct===2?'ok':'mid'}">${r.tier}</span></td><td>${r.pct}%</td><td><b>${r.bonus.toFixed(2)}</b></td><td>${r.date}</td></tr>`;
        });
        document.getElementById('st_sales').innerText = sT.toLocaleString();
        document.getElementById('st_bonus').innerText = bT.toLocaleString();

        const exRows = document.getElementById('excludedRows'); exRows.innerHTML = '';
        excludedInvoices.filter(d => f === '' || f === 'all' || d.rep === f).forEach(r => {
            exRows.innerHTML += `<tr><td>${r.reference}</td><td>${r.rep}</td><td>${r.status}</td><td>${r.date}</td><td><span class="badge no">${r.reason}</span></td></tr>`;
        });

        renderProductRules(); renderTargetTable();
    }

    function renderProductRules() { 
        const r = document.getElementById('productRows'); r.innerHTML = ''; 
        Object.keys(productsMap).forEach(k => { 
            const rule = productRules[k] || {}; 
            r.innerHTML += `<tr><td>${productsMap[k].name}</td><td><input type="number" class="tbl-input" id="f_${k}" value="${rule.factor||0}"></td><td><input type="number" class="tbl-input" id="pp_${k}" value="${rule.premiumPrice||0}"></td><td><input type="number" class="tbl-input" id="ppct_${k}" value="${rule.premiumPct||2}"></td><td><input type="number" class="tbl-input" id="bp_${k}" value="${rule.basePrice||0}"></td><td><input type="number" class="tbl-input" id="bpct_${k}" value="${rule.basePct||1}"></td></tr>`; 
        }); 
    }
    
    function renderTargetTable() { 
        const r = document.getElementById('targetRows'); r.innerHTML = ''; 
        let tR = 0;
        creators.forEach(c => { 
            const tr = targetRules[c] || {}; 
            const sales = computed.filter(d => d.rep === c).reduce((a, b) => a + (b.cartonPrice * b.qty), 0); 
            const achieved = sales >= (tr.amt || 9999999);
            if(achieved) tR += (tr.rwd || 0);
            r.innerHTML += `<tr><td>${c}</td><td>${sales.toLocaleString()}</td><td><input type="number" class="tbl-input" id="ta_${c}" value="${tr.amt||0}"></td><td><input type="number" class="tbl-input" id="tr_${c}" value="${tr.rwd||0}"></td><td>${achieved ? '<span class="badge ok">متحقق</span>' : '<span class="badge no">غير</span>'}</td></tr>`; 
        }); 
        document.getElementById('st_target_reward').innerText = tR.toLocaleString();
    }

    function saveProductRules() { Object.keys(productsMap).forEach(k => { productRules[k] = { factor: parseFloat(document.getElementById(`f_${k}`).value), premiumPrice: parseFloat(document.getElementById(`pp_${k}`).value), premiumPct: parseFloat(document.getElementById(`ppct_${k}`).value), basePrice: parseFloat(document.getElementById(`bp_${k}`).value), basePct: parseFloat(document.getElementById(`bpct_${k}`).value) }; }); localStorage.setItem('pRules_v47', JSON.stringify(productRules)); processLogic(); alert('تم الحفظ'); }
    function saveTargetRules() { creators.forEach(c => { targetRules[c] = { amt: parseFloat(document.getElementById(`ta_${c}`).value), rwd: parseFloat(document.getElementById(`tr_${c}`).value) }; }); localStorage.setItem('tRules_v47', JSON.stringify(targetRules)); processLogic(); alert('تم الحفظ'); }
    function applySmartRules(force=false) { let cnt=0; Object.keys(productsMap).forEach(k=>{ if(!force&&productRules[k]?.premiumPrice>0)return; const n=productsMap[k].name.toLowerCase(); for(let r of AUTO_RULES) if(r.keys.some(x=>n.includes(x.toLowerCase()))){ productRules[k]={factor:productRules[k]?.factor||0, premiumPrice:r.pp, premiumPct:r.ppct||2, basePrice:r.bp, basePct:r.basePct||1}; cnt++; break; } }); if(cnt>0) localStorage.setItem('pRules_v47', JSON.stringify(productRules)); renderProductRules(); }
    
    function exportBackup() { const b=new Blob([JSON.stringify({pRules:productRules, tRules:targetRules})],{type:'application/json'}); saveAs(b, "Backup_Config.json"); }
    function importBackup(e) { const r=new FileReader(); r.onload=x=>{ const d=JSON.parse(x.target.result); productRules=d.pRules||{}; targetRules=d.tRules||{}; localStorage.setItem('pRules_v47',JSON.stringify(productRules)); localStorage.setItem('tRules_v47',JSON.stringify(targetRules)); processLogic(); alert('تم الاستيراد'); }; r.readAsText(e.target.files[0]); }

    async function exportExcel() {
        if (!computed.length) return alert("لا توجد بيانات");
        const workbook = new ExcelJS.Workbook();
        const sheet = workbook.addWorksheet('تقرير البونص');
        sheet.columns = [
            { header: 'المندوب', key: 'rep', width: 20 }, { header: 'المرجع', key: 'ref', width: 15 }, { header: 'المنتج', key: 'prod', width: 35 },
            { header: 'الكمية', key: 'qty', width: 10 }, { header: 'سعر الكرتون', key: 'price', width: 15 }, { header: 'الفئة', key: 'tier', width: 10 },
            { header: 'البونص', key: 'bonus', width: 15 }, { header: 'التاريخ', key: 'date', width: 15 }
        ];
        sheet.getRow(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };
        sheet.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2C3E50' } };

        const groups = {}; computed.forEach(i => { if(!groups[i.rep]) groups[i.rep] = []; groups[i.rep].push(i); });
        
        Object.keys(groups).forEach(rep => {
            let t = 0;
            groups[rep].forEach(d => { t += d.bonus; sheet.addRow({ rep: d.rep, ref: d.ref, prod: d.prod, qty: d.qty, price: d.cartonPrice.toFixed(2), tier: d.tier, bonus: d.bonus.toFixed(2), date: d.date }); });
            const r = sheet.addRow({ prod: `إجمالي المندوب: ${rep}`, bonus: t.toFixed(2) });
            r.font = { bold: true }; r.getCell('prod').fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE8F0F2' } }; r.getCell('bonus').fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD4EDDA' } };
            sheet.addRow([]);
        });
        const buffer = await workbook.xlsx.writeBuffer();
        saveAs(new Blob([buffer]), 'Bonus_Full_Report.xlsx');
    }

    function updateFilterDropdown() { const s=document.getElementById('creatorFilter'); s.innerHTML='<option value="all">الكل</option>'; creators.forEach(c=>s.innerHTML+=`<option value="${c}">${c}</option>`); }
</script>
</body>
</html>
