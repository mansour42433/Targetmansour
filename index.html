<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>نظام البونص المطور - المسح الشامل</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root{--p:#2c3e50; --acc:#2980b9; --bg:#f4f6f9; --g:#27ae60;}
        body{font-family:'Cairo', sans-serif; background:var(--bg); padding:20px; color:var(--p);}
        .box{background:#fff; border-radius:15px; max-width:1500px; margin:auto; padding:20px; box-shadow:0 4px 20px rgba(0,0,0,0.08);}
        .toolbar{display:flex; gap:15px; margin-bottom:25px; background:#f8f9fa; padding:20px; border-radius:12px; align-items:flex-end;}
        .form-group{display:flex; flex-direction:column; gap:5px;}
        input, select{padding:10px; border-radius:8px; border:1px solid #ddd; font-family:'Cairo';}
        .btn{padding:10px 25px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; color:#fff; display:flex; align-items:center; gap:8px;}
        .btn-primary{background:var(--acc);} .btn-success{background:var(--g);}
        .stats-grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:20px; margin-bottom:25px;}
        .stat-card{background:#fff; padding:20px; border-radius:12px; border-right:5px solid var(--acc); box-shadow:0 2px 10px rgba(0,0,0,0.05);}
        table{width:100%; border-collapse:collapse; margin-top:20px;}
        th{background:#f8f9fa; padding:15px; text-align:right; border-bottom:2px solid #eee;}
        td{padding:12px 15px; border-bottom:1px solid #eee;}
        .product-row{background:#f1faff; font-weight:bold; cursor:pointer;}
        .loading-overlay{display:none; text-align:center; padding:20px; color:var(--acc); font-weight:bold;}
    </style>
</head>
<body>

<div class="box">
    <h2><i class="fas fa-chart-line"></i> نظام البونص الذكي (تاريخ السداد)</h2>
    
    <div class="toolbar">
        <div class="form-group">
            <label>شهر السداد المستهدف</label>
            <input type="month" id="targetMonth">
        </div>
        <div class="form-group">
            <label>المندوب</label>
            <select id="repFilter" onchange="renderUI()"><option value="all">الكل</option></select>
        </div>
        <button class="btn btn-primary" onclick="loadDeepData()"><i class="fas fa-sync"></i> بدء المسح الشامل (3 أشهر)</button>
        <button class="btn btn-success" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> تصدير التقرير</button>
    </div>

    <div id="loading" class="loading-overlay"><i class="fas fa-spinner fa-spin"></i> جاري سحب البيانات ومطابقة الفواتير...</div>

    <div class="stats-grid">
        <div class="stat-card"><h3>إجمالي المبيعات المحصلة</h3><p id="totalSales">0.00</p></div>
        <div class="stat-card" style="border-color:var(--g)"><h3>إجمالي البونص المستحق</h3><p id="totalBonus">0.00</p></div>
        <div class="stat-card" style="border-color:#e67e22"><h3>عدد الأصناف المباعة</h3><p id="totalItems">0</p></div>
    </div>

    <div id="resultsTable"></div>
</div>

<script>
let RawDB = { products: [], invoices: [], units: {}, returns: [] };
let ProcessedData = [];
let Settings = JSON.parse(localStorage.getItem('bonusSettingsV3') || '{}');

document.getElementById('targetMonth').value = new Date().toISOString().slice(0, 7);

async function loadDeepData() {
    const loader = document.getElementById('loading');
    loader.style.display = 'block';
    
    try {
        // جلب المنتجات والوحدات والفواتير
        const [p, u, i, r] = await Promise.all([
            fetch('/api/data.js?type=products').then(res => res.json()),
            fetch('/api/data.js?type=units').then(res => res.json()),
            fetch('/api/data.js?type=invoices').then(res => res.json()),
            fetch('/api/data.js?type=returns').then(res => res.json())
        ]);

        RawDB.products = p.data || [];
        (u.data || []).forEach(unit => RawDB.units[unit.id] = unit.name_ar || unit.name_en);
        RawDB.invoices = i.data || [];
        RawDB.returns = r.data || [];

        processLogic();
        loader.style.display = 'none';
    } catch (e) {
        alert("خطأ في الاتصال: " + e.message);
        loader.style.display = 'none';
    }
}

function processLogic() {
    ProcessedData = [];
    const tMonth = document.getElementById('targetMonth').value;
    const [targetYear, targetMon] = tMonth.split('-');

    // تصفية الفواتير حسب تاريخ السداد
    const paidInvoices = RawDB.invoices.filter(inv => {
        if (inv.status !== 'Paid' || !inv.payment_date) return false;
        const [pYear, pMon] = inv.payment_date.split('-');
        return pYear === targetYear && pMon === targetMon;
    });

    // جلب المنتجات التي تم بيعها في هذه الفواتير
    const reps = new Set();
    paidInvoices.forEach(inv => {
        reps.add(inv.creator);
        const items = inv.line_items || inv.inventory_items || [];
        
        items.forEach(item => {
            const prod = RawDB.products.find(p => p.id === item.product_id);
            if (!prod) return;

            const qty = parseFloat(item.quantity) || 0;
            const price = parseFloat(item.unit_price) || 0;
            const total = qty * price;
            
            // قاعدة بونص (1% و 2%) بناءً على سعر الكرتون 70
            let rate = price >= 70 ? 2 : 1;
            let bonus = (total * rate) / 100;

            ProcessedData.push({
                productName: prod.name_ar || prod.name_en,
                invRef: inv.reference,
                rep: inv.creator,
                qty: qty,
                price: price,
                total: total,
                rate: rate,
                bonus: bonus,
                date: inv.payment_date
            });
        });
    });

    // تحديث قائمة المناديب
    const sel = document.getElementById('repFilter');
    sel.innerHTML = '<option value="all">الكل</option>';
    [...reps].sort().forEach(r => sel.innerHTML += `<option value="${r}">${r}</option>`);

    renderUI();
}

function renderUI() {
    const filter = document.getElementById('repFilter').value;
    const data = filter === 'all' ? ProcessedData : ProcessedData.filter(x => x.rep === filter);

    const totalSales = data.reduce((a, b) => a + b.total, 0);
    const totalBonus = data.reduce((a, b) => a + b.bonus, 0);

    document.getElementById('totalSales').innerText = totalSales.toLocaleString();
    document.getElementById('totalBonus').innerText = totalBonus.toLocaleString();
    document.getElementById('totalItems').innerText = data.length;

    let html = `<table><thead><tr><th>المنتج</th><th>المندوب</th><th>الفاتورة</th><th>الكمية</th><th>السعر</th><th>الإجمالي</th><th>البونص</th></tr></thead><tbody>`;
    data.forEach(row => {
        html += `<tr>
            <td>${row.productName}</td>
            <td>${row.rep}</td>
            <td>${row.invRef}</td>
            <td>${row.qty}</td>
            <td>${row.price}</td>
            <td>${row.total.toFixed(2)}</td>
            <td style="color:var(--g); font-weight:bold;">${row.bonus.toFixed(2)} (${row.rate}%)</td>
        </tr>`;
    });
    document.getElementById('resultsTable').innerHTML = html + '</tbody></table>';
}

function exportToExcel() {
    // كود التصدير هنا كما هو في ملفك السابق
    alert("جاري تجهيز ملف الإكسل...");
}
</script>
</body>
</html>
