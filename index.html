<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>نظام حساب البونص - النسخة المتقدمة</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root{--p:#2c3e50; --acc:#2980b9; --bg:#f4f6f9; --g:#27ae60; --r:#c0392b; --orange:#e67e22;}
        *{margin:0; padding:0; box-sizing:border-box;}
        body{font-family:'Cairo', sans-serif; background:var(--bg); padding:20px; color:var(--p); line-height:1.6;}
        .container{background:#fff; border-radius:15px; max-width:1800px; margin:auto; box-shadow:0 4px 25px rgba(0,0,0,0.1); overflow:hidden;}
        
        .tabs{display:flex; background:var(--p); color:#fff; flex-wrap:wrap;}
        .tab{padding:15px 20px; cursor:pointer; background:transparent; border:none; color:#ccc; font-weight:bold; font-size:0.95em; transition:0.3s; flex:1; text-align:center;}
        .tab.active{background:#fff; color:var(--p); border-top:4px solid var(--acc);}
        .tab:hover:not(.active){background:rgba(255,255,255,0.1);}
        
        .content{display:none; padding:25px;}
        .content.active{display:block;}
        
        .toolbar{display:flex; gap:15px; margin-bottom:25px; background:#f8f9fa; padding:20px; border-radius:12px; flex-wrap:wrap; align-items:flex-end;}
        .toolbar label{display:block; margin-bottom:5px; font-weight:600;}
        .toolbar input, .toolbar select{padding:10px; border-radius:6px; border:1px solid #ccc; font-family:'Cairo';}
        
        .stats{display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:25px;}
        .stat-card{background:#34495e; color:#fff; padding:20px; border-radius:12px; text-align:center;}
        .stat-card.accent{background:var(--acc);}
        .stat-card.success{background:var(--g);}
        .stat-card.warning{background:var(--orange);}
        .stat-val{font-size:1.8em; font-weight:bold; margin-top:5px;}
        
        .btn{padding:10px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; font-family:'Cairo'; color:#fff; display:inline-flex; align-items:center; gap:8px;}
        .btn-primary{background:var(--acc);}
        .btn-success{background:var(--g);}
        
        table{width:100%; border-collapse:collapse; background:#fff; font-size:0.92em;}
        th{background:#f8f9fa; padding:12px; text-align:right; border-bottom:2px solid #ddd; font-weight:bold;}
        td{padding:12px; border-bottom:1px solid #eee;}
        tr:hover{background:#f8f9fa;}
        
        .badge-premium{background:#d4edda; color:#155724; padding:4px 8px; border-radius:12px; font-weight:bold; font-size:0.85em;}
        .badge-base{background:#fff3cd; color:#856404; padding:4px 8px; border-radius:12px; font-weight:bold; font-size:0.85em;}
        .badge-danger{background:#f8d7da; color:#721c24; padding:4px 8px; border-radius:12px; font-weight:bold; font-size:0.85em;}
        
        .input-table{width:90px; text-align:center; padding:6px; border:1px solid #ccc; border-radius:5px;}
        
        #loadingStatus{display:none; margin-bottom:20px; background:#e8f4f8; padding:15px; border-radius:8px; text-align:center; color:var(--acc); font-weight:bold;}
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab active" onclick="switchTab(0)"><i class="fas fa-check-circle"></i> الفواتير المدفوعة (البونص)</button>
        <button class="tab" onclick="switchTab(1)"><i class="fas fa-times-circle"></i> الفواتير المستبعدة</button>
        <button class="tab" onclick="switchTab(2)"><i class="fas fa-cog"></i> إعدادات الأسعار (شرط 2%)</button>
    </div>

    <div class="content active">
        <div class="toolbar">
            <div>
                <label>شهر التحصيل (تاريخ الدفع)</label>
                <input type="month" id="targetMonth">
            </div>
            <div>
                <label>تصفية بالمندوب</label>
                <select id="repFilter" onchange="filterData()">
                    <option value="all">كل المناديب</option>
                </select>
            </div>
            <div style="margin-bottom:2px;">
                <button class="btn btn-primary" onclick="loadData()"><i class="fas fa-sync"></i> جلب البيانات (4 أشهر)</button>
                <button class="btn btn-success" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> تصدير البونص</button>
            </div>
        </div>
        
        <div id="loadingStatus"><i class="fas fa-spinner fa-spin"></i> <span id="statusText">جاري التحضير...</span></div>

        <div class="stats">
            <div class="stat-card"><h3>الفواتير</h3><div class="stat-val" id="stat-invoices">0</div></div>
            <div class="stat-card accent"><h3>المبيعات</h3><div class="stat-val" id="stat-sales">0</div></div>
            <div class="stat-card success"><h3>إجمالي البونص</h3><div class="stat-val" id="stat-bonus">0</div></div>
        </div>

        <div id="bonusTable"></div>
    </div>

    <div class="content">
        <div style="margin-bottom:15px; color:#c0392b; font-weight:bold;">
            <i class="fas fa-info-circle"></i> تشمل: الفواتير الآجلة غير المدفوعة، والفواتير التي دُفعت في شهر غير الشهر المحدد.
        </div>
        <div class="stats">
            <div class="stat-card warning"><h3>فواتير مستبعدة</h3><div class="stat-val" id="stat-excluded">0</div></div>
            <div class="stat-card warning"><h3>مبيعات معلقة</h3><div class="stat-val" id="stat-potential">0</div></div>
        </div>
        <div id="excludedTable"></div>
    </div>

    <div class="content">
        <div style="margin-bottom:15px; color:#2980b9; font-weight:bold;">
            <i class="fas fa-lightbulb"></i> إذا كان السعر أكبر من أو يساوي (السعر المستهدف) يحسب بونص 2%، وإلا يحسب 1%.
        </div>
        <button class="btn btn-success" onclick="saveSettings()" style="margin-bottom:20px;"><i class="fas fa-save"></i> حفظ الإعدادات</button>
        <div id="settingsTable"></div>
    </div>
</div>

<script>
let allData = [];
let excludedData = [];
let reps = new Set();
let products = {};
// تخزين إعدادات التحويل والسعر المستهدف في المتصفح
let settings = JSON.parse(localStorage.getItem('bonusSettings') || '{}');

document.getElementById('targetMonth').value = new Date().toISOString().slice(0, 7);

function switchTab(index) {
    document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === index));
    document.querySelectorAll('.content').forEach((c, i) => c.classList.toggle('active', i === index));
}

async function loadData() {
    const targetMonth = document.getElementById('targetMonth').value;
    if (!targetMonth) return alert('يرجى اختيار شهر التحصيل');

    const statusDiv = document.getElementById('loadingStatus');
    const statusText = document.getElementById('statusText');
    statusDiv.style.display = 'block';

    try {
        statusText.innerText = "جاري جلب المنتجات... (1/4)";
        const prodRes = await fetch(`/api/data.js?type=products`);
        const productsList = (await prodRes.json()).data;
        products = {};
        productsList.forEach(p => products[p.id] = { name: p.name_ar || p.name_en, id: p.id });

        statusText.innerText = "جاري جلب الوحدات... (2/4)";
        const unitsRes = await fetch(`/api/data.js?type=units`);
        const unitsList = (await unitsRes.json()).data;

        statusText.innerText = "جاري جلب فواتير آخر 4 أشهر... (3/4)";
        const invRes = await fetch(`/api/data.js?type=invoices`);
        const invoicesList = (await invRes.json()).data;

        statusText.innerText = "جاري جلب المرتجعات... (4/4)";
        const retRes = await fetch(`/api/data.js?type=returns`);
        const returnsList = (await retRes.json()).data;

        processData({ productsMap: products, product_units: unitsList, invoices: invoicesList, credit_notes: returnsList }, targetMonth);
        renderAll();
        setTimeout(() => statusDiv.style.display = 'none', 2000);
    } catch (error) {
        statusText.innerHTML = `<span style="color:red;">حدث خطأ: ${error.message}</span>`;
    }
}

function processData(data, targetMonth) {
    allData = [];
    excludedData = [];
    reps = new Set();
    const [targetYear, targetMon] = targetMonth.split('-');

    const units = {};
    (data.product_units || []).forEach(u => units[u.id] = u.name_ar || u.name_en);
    
    const returns = {};
    (data.credit_notes || []).forEach(cn => {
        const ref = cn.invoice_reference;
        if (!ref) return;
        returns[ref] = returns[ref] || [];
        returns[ref].push(cn);
    });

    (data.invoices || []).forEach(inv => {
        const rep = inv.creator || 'غير محدد';
        reps.add(rep);

        (inv.inventory_items || []).forEach(item => {
            const pid = item.product_id;
            if (!products[pid]) return;

            let qty = parseFloat(item.quantity) || 0;
            const unitPrice = parseFloat(item.unit_price) || 0;

            // خصم المرتجعات
            (returns[inv.reference || inv.id] || []).forEach(cn => {
                (cn.inventory_items || []).forEach(ci => {
                    if (ci.product_id === pid) qty -= parseFloat(ci.quantity) || 0;
                });
            });

            if (qty <= 0) return;

            // معالجة الكرتون
            const unitName = units[item.unit_type] || '';
            const isCarton = unitName.includes('كرتون') || unitName.includes('carton');
            let cartonQty = qty;
            let cartonPrice = unitPrice;

            if (!isCarton) {
                const factor = settings[pid]?.factor || 0;
                if (factor > 0) {
                    cartonQty = qty / factor;
                    cartonPrice = unitPrice * factor;
                }
            }

            // تطبيق قاعدة البونص (1% و 2%)
            // إذا لم يتم تحديد سعر مستهدف (الافتراضي 0)، يتم احتساب 1% كحد أدنى أو حسب رغبتك
            const targetPrice = settings[pid]?.threshold || 0;
            let bonusRate = 1; // السعر الافتراضي 1%
            let tierName = 'أساسي 1%';

            if (targetPrice > 0 && cartonPrice >= targetPrice) {
                bonusRate = 2;
                tierName = 'ممتاز 2%';
            }

            const totalSales = cartonPrice * cartonQty;
            const bonus = (totalSales * bonusRate) / 100;

            const record = {
                rep,
                invRef: inv.reference,
                productName: products[pid].name,
                cartonQty: cartonQty.toFixed(2),
                cartonPrice: cartonPrice.toFixed(2),
                totalSales: totalSales.toFixed(2),
                bonusRate,
                tierName,
                bonus: bonus.toFixed(2),
                paymentDate: inv.payment_date || 'غير مدفوعة',
                issueDate: inv.issue_date
            };

            // فرز بناءً على تاريخ الدفع
            if (inv.status === 'Paid' && inv.payment_date) {
                const [payYear, payMon] = inv.payment_date.split('-');
                if (payYear === targetYear && payMon === targetMon) {
                    allData.push(record); // الفواتير المستحقة
                } else {
                    excludedData.push({...record, reason: 'مدفوعة في شهر آخر'});
                }
            } else {
                excludedData.push({...record, reason: 'آجلة / غير مدفوعة'});
            }
        });
    });
}

function filterData() {
    renderBonusTable();
    renderExcludedTable();
    updateStats();
}

function renderAll() {
    const select = document.getElementById('repFilter');
    const current = select.value;
    select.innerHTML = '<option value="all">كل المناديب</option>';
    Array.from(reps).sort().forEach(r => select.innerHTML += `<option value="${r}">${r}</option>`);
    select.value = current;

    renderBonusTable();
    renderExcludedTable();
    renderSettings();
    updateStats();
}

function renderBonusTable() {
    const filter = document.getElementById('repFilter').value;
    const data = filter === 'all' ? allData : allData.filter(d => d.rep === filter);
    
    let html = `<table><tr><th>المندوب</th><th>الفاتورة</th><th>المنتج</th><th>الكمية (كرتون)</th><th>السعر</th><th>المبيعات</th><th>نسبة البونص</th><th>البونص</th><th>تاريخ الدفع</th></tr>`;
    data.forEach(r => {
        const badge = r.bonusRate === 2 ? 'badge-premium' : 'badge-base';
        html += `<tr>
            <td>${r.rep}</td><td>${r.invRef}</td><td>${r.productName}</td><td>${r.cartonQty}</td>
            <td>${r.cartonPrice}</td><td><strong>${r.totalSales}</strong></td>
            <td><span class="${badge}">${r.tierName}</span></td>
            <td style="color:green; font-weight:bold;">${r.bonus}</td><td>${r.paymentDate}</td>
        </tr>`;
    });
    document.getElementById('bonusTable').innerHTML = html + '</table>';
}

function renderExcludedTable() {
    const filter = document.getElementById('repFilter').value;
    const data = filter === 'all' ? excludedData : excludedData.filter(d => d.rep === filter);
    
    let html = `<table><tr><th>المندوب</th><th>الفاتورة</th><th>المنتج</th><th>المبيعات</th><th>السبب</th><th>تاريخ الإنشاء</th></tr>`;
    data.forEach(r => {
        html += `<tr>
            <td>${r.rep}</td><td>${r.invRef}</td><td>${r.productName}</td><td>${r.totalSales}</td>
            <td><span class="badge-danger">${r.reason}</span></td><td>${r.issueDate}</td>
        </tr>`;
    });
    document.getElementById('excludedTable').innerHTML = html + '</table>';
}

function renderSettings() {
    let html = `<table><tr><th>المنتج</th><th>معامل التحويل (للكرتون)</th><th>السعر المستهدف لـ 2%</th></tr>`;
    Object.keys(products).forEach(pid => {
        const s = settings[pid] || {factor:0, threshold:0};
        html += `<tr>
            <td>${products[pid].name}</td>
            <td><input type="number" id="f_${pid}" class="input-table" value="${s.factor}"></td>
            <td><input type="number" id="t_${pid}" class="input-table" value="${s.threshold}"></td>
        </tr>`;
    });
    document.getElementById('settingsTable').innerHTML = html + '</table>';
}

function updateStats() {
    const filter = document.getElementById('repFilter').value;
    const d1 = filter === 'all' ? allData : allData.filter(d => d.rep === filter);
    const d2 = filter === 'all' ? excludedData : excludedData.filter(d => d.rep === filter);

    document.getElementById('stat-invoices').innerText = [...new Set(d1.map(d=>d.invRef))].length;
    document.getElementById('stat-sales').innerText = d1.reduce((s, d) => s + parseFloat(d.totalSales), 0).toFixed(2);
    document.getElementById('stat-bonus').innerText = d1.reduce((s, d) => s + parseFloat(d.bonus), 0).toFixed(2);
    
    document.getElementById('stat-excluded').innerText = [...new Set(d2.map(d=>d.invRef))].length;
    document.getElementById('stat-potential').innerText = d2.reduce((s, d) => s + parseFloat(d.totalSales), 0).toFixed(2);
}

function saveSettings() {
    Object.keys(products).forEach(pid => {
        settings[pid] = {
            factor: parseFloat(document.getElementById(`f_${pid}`).value) || 0,
            threshold: parseFloat(document.getElementById(`t_${pid}`).value) || 0
        };
    });
    localStorage.setItem('bonusSettings', JSON.stringify(settings));
    alert('✅ تم الحفظ. اضغط جلب البيانات لتطبيق الأسعار الجديدة.');
}

async function exportToExcel() {
    const filter = document.getElementById('repFilter').value;
    const data = filter === 'all' ? allData : allData.filter(d => d.rep === filter);
    if (!data.length) return alert('لا توجد بيانات للتصدير');

    const wb = new ExcelJS.Workbook();
    const sheet = wb.addWorksheet('تقرير البونص');

    sheet.columns = [
        { header: 'المندوب', key: 'rep', width: 20 },
        { header: 'الفاتورة', key: 'invRef', width: 15 },
        { header: 'المنتج', key: 'productName', width: 30 },
        { header: 'الكمية', key: 'cartonQty', width: 10 },
        { header: 'السعر', key: 'cartonPrice', width: 10 },
        { header: 'المبيعات', key: 'totalSales', width: 15 },
        { header: 'نسبة البونص', key: 'tierName', width: 15 },
        { header: 'البونص', key: 'bonus', width: 12 },
        { header: 'تاريخ الدفع', key: 'paymentDate', width: 15 }
    ];

    sheet.getRow(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };
    sheet.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2C3E50' } };

    let currentRep = '';
    let repTotal = 0;

    const exportData = filter === 'all' ? [...data].sort((a,b) => a.rep.localeCompare(b.rep)) : data;

    exportData.forEach(r => {
        if (filter === 'all' && currentRep !== '' && currentRep !== r.rep) {
            const tr = sheet.addRow({ productName: `إجمالي ${currentRep}`, bonus: repTotal.toFixed(2) });
            tr.font = { bold: true }; tr.getCell('bonus').fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD4EDDA' } };
            sheet.addRow([]);
            repTotal = 0;
        }
        currentRep = r.rep;
        repTotal += parseFloat(r.bonus);

        const row = sheet.addRow(r);
        row.getCell('tierName').fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: r.bonusRate === 2 ? 'FFD4EDDA' : 'FFFFF3CD' } };
    });

    if (filter === 'all' && currentRep !== '') {
        const tr = sheet.addRow({ productName: `إجمالي ${currentRep}`, bonus: repTotal.toFixed(2) });
        tr.font = { bold: true }; tr.getCell('bonus').fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD4EDDA' } };
    } else if (filter !== 'all') {
        const tr = sheet.addRow({ productName: `الإجمالي الكلي`, bonus: repTotal.toFixed(2) });
        tr.font = { bold: true }; tr.getCell('bonus').fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD4EDDA' } };
    }

    const buffer = await wb.xlsx.writeBuffer();
    saveAs(new Blob([buffer]), `تقرير_البونص_${document.getElementById('targetMonth').value}.xlsx`);
}
</script>
</body>
</html>
