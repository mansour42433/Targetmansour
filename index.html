<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ V36 - Ù…Ø±Ø¨Ø¹Ø§Øª Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ù…Ø­Ø³Ù‘Ù†Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root{--p:#2c3e50; --acc:#2980b9; --bg:#f4f6f9; --g:#27ae60; --r:#c0392b;}
        body{font-family:'Cairo', sans-serif; background:var(--bg); padding:20px; color:var(--p); line-height:1.6;}
        .box{background:#fff; border-radius:15px; max-width:1600px; margin:auto; box-shadow:0 4px 25px rgba(0,0,0,0.1); overflow:hidden;}
        .tabs-header{display:flex; background:var(--p); color:#fff; flex-wrap:wrap;}
        .tab-btn{padding:15px 25px; cursor:pointer; background:transparent; border:none; color:#ccc; font-weight:bold; font-family:'Cairo'; transition:0.3s; flex:1; text-align:center;}
        .tab-btn.active{background:#fff; color:var(--p); border-top:4px solid var(--acc);}
        .tab-content{display:none; padding:25px;}
        .tab-content.active{display:block;}
        .stats{display:flex; gap:15px; margin-bottom:20px; flex-wrap:wrap;}
        .card{flex:1; background:var(--p); color:#fff; padding:20px; border-radius:12px; text-align:center; min-width:220px;}
        .card-val{font-size:1.8em; font-weight:bold; margin-top:5px;}
        table{width:100%; border-collapse:collapse; margin-top:15px; background:#fff;}
        th{background:#f8f9fa; padding:15px; text-align:right; border-bottom:2px solid #ddd; position:sticky; top:0; z-index:10;}
        td{padding:12px 15px; border-bottom:1px solid #eee; vertical-align:middle;}
        .badge{padding:5px 12px; border-radius:20px; font-size:0.85em; font-weight:bold; display:inline-block;}
        .badge-p{background:#d4edda; color:#155724; border:1px solid #c3e6cb;}
        .badge-b{background:#fff3cd; color:#856404; border:1px solid #ffeeba;}
        .badge-r{background:#f8d7da; color:#721c24; border:1px solid #f5c6cb;}
        .btn{padding:12px 22px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; font-family:'Cairo'; transition:0.3s; display:inline-flex; align-items:center; gap:8px;}
        .btn-acc{background:var(--acc); color:#fff;}
        .btn-g{background:var(--g); color:#fff;}
        .tbl-input{width:80px; text-align:center; padding:6px; border:1px solid #ccc; border-radius:5px;}
        .debug-bar{background:#ebf5fb; padding:10px 20px; font-size:0.85em; border-bottom:1px solid #d6eaf8; color:#2e86c1;}
    </style>
</head>
<body>

<div class="box">
    <div class="tabs-header">
        <button class="tab-btn active" onclick="switchTab('main')"><i class="fas fa-money-bill-wave"></i> Ø§Ù„Ø¨ÙˆÙ†Øµ Ø§Ù„Ù…Ø³ØªØ­Ù‚</button>
        <button class="tab-btn" onclick="switchTab('suspended')"><i class="fas fa-clock"></i> Ø§Ù„Ù…Ø¹Ù„Ù‚ (ØªØ­Øª Ø§Ù„ØªØ­ØµÙŠÙ„)</button>
        <button class="tab-btn" onclick="switchTab('products')"><i class="fas fa-magic"></i> Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„ÙˆØ­Ø¯Ø§Øª</button>
        <button class="tab-btn" onclick="switchTab('targets')"><i class="fas fa-bullseye"></i> Ø§Ù„Ø£Ù‡Ø¯Ø§Ù ÙˆØ§Ù„ØªØ§Ø±Ø¬Øª</button>
        <button class="tab-btn" onclick="switchTab('backup')"><i class="fas fa-database"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </div>

    <div id="debug-info" class="debug-bar" style="display:none;"></div>

    <div id="tab-main" class="tab-content active">
        <div style="display:flex; gap:15px; align-items:flex-end; margin-bottom:25px; background:#f8f9fa; padding:20px; border-radius:12px;">
            <div><label>Ø´Ù‡Ø± Ø§Ù„ØªØ­ØµÙŠÙ„</label><br><input type="month" id="targetMonth" style="padding:10px; border-radius:6px; border:1px solid #ccc; width:180px;"></div>
            <div><label>ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</label><br><select id="creatorFilter" onchange="renderUI()" style="padding:10px; border-radius:6px; border:1px solid #ccc; width:220px;"></select></div>
            <button class="btn btn-acc" onclick="fetchData()"><i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ« ÙˆØ¬Ù„Ø¨</button>
            <button class="btn btn-g" onclick="exportExcel()"><i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³ÙŠÙ„ Ù…Ù„ÙˆÙ†</button>
        </div>

        <div class="stats">
            <div class="card"><h3>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø­ØµÙ„Ø©</h3><div id="stat-sales" class="card-val">0</div></div>
            <div class="card" style="background:#f39c12"><h3>Ù…Ø¨ÙŠØ¹Ø§Øª 1% (Ø£Ø³Ø§Ø³ÙŠ)</h3><div id="stat-sales-1pct" class="card-val">0</div></div>
            <div class="card" style="background:#27ae60"><h3>Ù…Ø¨ÙŠØ¹Ø§Øª 2% (ØªÙ…ÙŠØ²)</h3><div id="stat-sales-2pct" class="card-val">0</div></div>
            <div class="card" style="background:var(--acc)"><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙˆÙ†Øµ</h3><div id="stat-bonus" class="card-val">0</div></div>
            <div class="card" style="background:#e67e22"><h3>Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© (Ø§Ù„ØªØ§Ø±Ø¬Øª)</h3><div id="stat-target-reward" class="card-val">0</div></div>
        </div>

        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr><th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th><th>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th><th>Ø§Ù„Ù…Ù†ØªØ¬ (Ù…ÙˆØ­Ø¯)</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙƒØ±ØªÙˆÙ†</th><th>Ø§Ù„ÙØ¦Ø©</th><th>Ø§Ù„Ù†Ø³Ø¨Ø©</th><th>Ø§Ù„Ø¨ÙˆÙ†Øµ</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø¯Ø§Ø¯</th></tr>
                </thead>
                <tbody id="mainRows"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-suspended" class="tab-content">
        <div class="stats">
            <div class="card" style="background:#7f8c8d; max-width:400px;"><h3>Ø¨ÙˆÙ†Øµ Ù…ØªÙˆÙ‚Ø¹ (ØºÙŠØ± Ù…Ø­ØµÙ„)</h3><div id="stat-susp-bonus" class="card-val">0</div></div>
        </div>
        <table>
            <thead><tr><th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th><th>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ØµØ§ÙÙŠØ©</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th><th>Ø§Ù„Ø¨ÙˆÙ†Øµ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</th></tr></thead>
            <tbody id="suspRows"></tbody>
        </table>
    </div>

    <div id="tab-products" class="tab-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
            <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªØ³Ø¹ÙŠØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆÙ…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„</h3>
            <div><button class="btn btn-acc" onclick="applySmartRules(true)">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠ</button> <button class="btn btn-g" onclick="saveProductRules()">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button></div>
        </div>
        <table>
            <thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ)</th><th>Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„ÙƒØ±ØªÙˆÙ† Ø§Ù„ÙŠØ¯ÙˆÙŠ</th><th>Ø³Ø¹Ø± Ø§Ù„ØªÙ…ÙŠØ² (>=)</th><th>Ù†Ø³Ø¨Ø© %</th><th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (<=)</th><th>Ù†Ø³Ø¨Ø© %</th></tr></thead>
            <tbody id="prodRows"></tbody>
        </table>
    </div>

    <div id="tab-targets" class="tab-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h3>Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</h3>
            <button class="btn btn-g" onclick="saveTargetRules()">Ø­ÙØ¸ Ø§Ù„ØªØ§Ø±Ø¬Øª</button>
        </div>
        <table>
            <thead><tr><th>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th><th>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</th><th>Ù‡Ø¯Ù Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th><th>Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹Ø©</th><th>Ø­Ø¬Ø¨ Ø§Ù„Ø¨ÙˆÙ†ØµØŸ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
            <tbody id="targetRows"></tbody>
        </table>
    </div>

    <div id="tab-backup" class="tab-content">
        <h3>Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆÙ†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
        <p>Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù†Ù‚Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„Ø£Ù‡Ø¯Ø§Ù Ù…Ù† Ø¬Ù‡Ø§Ø² Ù„Ø¢Ø®Ø±.</p>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-acc" onclick="exportBackup()">ØªØµØ¯ÙŠØ± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (JSON)</button>
            <div style="position:relative; overflow:hidden; display:inline-block;">
                <button class="btn btn-g">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                <input type="file" id="importFile" onchange="importBackup(event)" style="position:absolute; left:0; top:0; opacity:0; cursor:pointer;">
            </div>
        </div>
    </div>
</div>

<script>
const DEFERRED_SKU = "754500950512";
let rawInvoices = [], productsMap = {}, unitsMap = {}, creators = [], creditNotesMap = {};
let computed = [], suspended = [];

// Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
let productRules = JSON.parse(localStorage.getItem('pRules_v35') || "{}");
let targetRules = JSON.parse(localStorage.getItem('tRules_v35') || "{}");

function switchTab(id) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-' + id).classList.add('active');
    event.currentTarget.classList.add('active');
}

// âœ… Ø¯Ø§Ù„Ø© Ø¥ØµÙ„Ø§Ø­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨
function updateFilterDropdown() {
    const sel = document.getElementById('creatorFilter');
    if(!sel) return;
    const current = sel.value;
    sel.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</option>';
    creators.sort().forEach(rep => {
        const opt = document.createElement('option');
        opt.value = rep;
        opt.textContent = rep;
        sel.appendChild(opt);
    });
    sel.value = current || '';
}

async function fetchData() {
    const month = document.getElementById('targetMonth').value;
    if(!month) return alert("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù Ø£ÙˆÙ„Ø§Ù‹!");
    const btn = document.querySelector('.btn-acc');
    const dbg = document.getElementById('debug-info');
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
    dbg.style.display = 'block'; dbg.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ API Ù‚ÙŠÙˆØ¯ ÙˆØ¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';

    try {
        const res = await fetch(`/api/get-data?month=${month}`);
        const data = await res.json();
        
        rawInvoices = data.invoices || [];
        productsMap = data.productsMap || {};
        
        unitsMap = {};
        if(data.product_units) data.product_units.forEach(u => unitsMap[u.id] = parseFloat(u.conversion_factor || 1));
        
        creditNotesMap = {};
        if(data.credit_notes) data.credit_notes.forEach(cn => creditNotesMap[cn.id] = cn);
        
        creators = [...new Set(rawInvoices.map(i => i.created_by).filter(Boolean))];
        
        updateFilterDropdown();
        applySmartRules(); 
        processLogic();
        
        btn.innerHTML = '<i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
        dbg.innerHTML = `ØªÙ… Ø¬Ù„Ø¨ ${rawInvoices.length} ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­.`;
    } catch (e) {
        console.error(e); alert("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + e.message);
        btn.innerHTML = 'ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«';
    }
}

// ğŸ”¹ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© processLogic() Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
function processLogic() {
    computed = [];
    suspended = [];

    rawInvoices.forEach(inv => {

        if (inv.status !== 'Paid') return;

        const totalPaid = (inv.payments || [])
            .reduce((s, p) => s + parseFloat(p.amount || 0), 0);

        if (Math.abs(totalPaid - parseFloat(inv.total)) > 0.01) return;

        let invoiceReturns = {};
        if (inv.allocations) {
            inv.allocations.forEach(alloc => {
                if (alloc.source_type === 'CreditNote') {
                    const cn = creditNotesMap[alloc.source_id];
                    if (cn && cn.line_items) {
                        cn.line_items.forEach(li => {
                            invoiceReturns[li.product_id] =
                                (invoiceReturns[li.product_id] || 0)
                                + parseFloat(li.quantity);
                        });
                    }
                }
            });
        }

        inv.line_items.forEach(item => {
            if (item.sku === DEFERRED_SKU) return;

            const pid = item.product_id;
            const rule = productRules[pid] || {};
            const unifiedName = productsMap[pid]?.name || item.product_name;

            const priceInclTax =
                parseFloat(item.unit_price)
                * (1 + (parseFloat(item.tax_percent || 0) / 100));

            let multiplier = 1;
            if (!(item.unit_type_name || "").includes("ÙƒØ±ØªÙˆÙ†")) {
                multiplier = unitsMap[item.unit_type]
                    || parseFloat(rule.factor)
                    || 1;
            }

            const cartonPrice = priceInclTax * multiplier;
            const netQty =
                Math.max(0,
                    parseFloat(item.quantity)
                    - (invoiceReturns[pid] || 0)
                );

            let pct = 0, tier = "Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø­Ø¯", badge = "badge-r";

            if (rule.premiumPrice > 0 && cartonPrice >= rule.premiumPrice) {
                pct = rule.premiumPct || 2;
                tier = "ØªÙ…ÙŠØ²";
                badge = "badge-p";
            } else if (rule.basePrice > 0 && cartonPrice <= rule.basePrice) {
                pct = rule.basePct || 1;
                tier = "Ø£Ø³Ø§Ø³ÙŠ";
                badge = "badge-b";
            }

            if (pct === 0 || netQty === 0) return;

            const totalSales = priceInclTax * netQty;
            const bonusAmount = totalSales * (pct / 100);

            computed.push({
                ref: inv.reference,
                rep: inv.created_by,
                prod: unifiedName,
                qty: netQty.toFixed(1),
                sellCarton: cartonPrice,
                tier,
                badge,
                pct,
                bonus: bonusAmount,
                totalSales,
                date: inv.issue_date
            });
        });
    });

    renderUI();
}

// Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„: renderUI, exportExcel, applySmartRules, saveProductRules, saveTargetRules, exportBackup, importBackup
// Ù„Ù… ØªØªØºÙŠØ±ØŒ ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
</script>
</body>
</html>