<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>نظام العمولات الموحد V29 (الأسماء العربية)</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root{--p:#2c3e50; --acc:#2980b9; --bg:#f4f6f9; --g:#27ae60; --r:#c0392b;}
        body{font-family:'Cairo', sans-serif; background:var(--bg); padding:20px; color:var(--p);}
        .box{background:#fff; border-radius:15px; max-width:1550px; margin:auto; box-shadow:0 4px 25px rgba(0,0,0,0.1); overflow:hidden;}
        .tabs-header{display:flex; background:var(--p); color:#fff;}
        .tab-btn{padding:15px 25px; cursor:pointer; background:transparent; border:none; color:#ccc; font-weight:bold; font-family:'Cairo'; transition:0.3s;}
        .tab-btn.active{background:#fff; color:var(--p); border-top:4px solid var(--acc);}
        .tab-content{display:none; padding:20px;}
        .tab-content.active{display:block;}
        .stats{display:flex; gap:15px; margin-bottom:20px; flex-wrap:wrap;}
        .card{flex:1; background:var(--p); color:#fff; padding:15px; border-radius:10px; text-align:center; min-width:200px;}
        .card-val{font-size:1.6em; font-weight:bold;}
        table{width:100%; border-collapse:collapse; margin-top:10px;}
        th{background:#f8f9fa; padding:12px; text-align:right; border-bottom:2px solid #ddd; position:sticky; top:0; z-index:10;}
        td{padding:10px; border-bottom:1px solid #eee; vertical-align:middle;}
        .badge{padding:4px 10px; border-radius:12px; font-size:0.85em; font-weight:bold;}
        .badge-p{background:#d4edda; color:#155724; border:1px solid #c3e6cb;}
        .badge-b{background:#fff3cd; color:#856404; border:1px solid #ffeeba;}
        .badge-r{background:#f8d7da; color:#721c24; border:1px solid #f5c6cb;}
        .rep-select{padding:5px; border-radius:4px; border:1px solid #ddd; font-family:'Cairo'; width:100%;}
        .btn{padding:10px 18px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; font-family:'Cairo'; transition:0.3s;}
        .btn-acc{background:var(--acc); color:#fff;}
        .btn-g{background:var(--g); color:#fff;}
        .tbl-input{width:70px; text-align:center; padding:5px; border:1px solid #ccc; border-radius:4px;}
        .auto-tag {font-size: 0.7em; background: #e1f5fe; color: #0277bd; padding: 2px 5px; border-radius: 4px; margin-right: 5px;}
        .debug-info { background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 0.9em; display: none; }
    </style>
</head>
<body>

<div class="box">
    <div class="tabs-header">
        <button class="tab-btn active" onclick="switchTab('main')"><i class="fas fa-money-bill-wave"></i> البونص المستحق</button>
        <button class="tab-btn" onclick="switchTab('suspended')"><i class="fas fa-clock"></i> المعلق</button>
        <button class="tab-btn" onclick="switchTab('products')"><i class="fas fa-magic"></i> الأسعار</button>
        <button class="tab-btn" onclick="switchTab('targets')"><i class="fas fa-bullseye"></i> التارجت</button>
        <button class="tab-btn" onclick="switchTab('backup')"><i class="fas fa-database"></i> النسخ الاحتياطي</button>
    </div>

    <div id="tab-main" class="tab-content active">
        <div style="display:flex; gap:15px; align-items:flex-end; margin-bottom:20px; background:#f8f9fa; padding:15px; border-radius:10px;">
            <div><label>شهر التحصيل</label><br><input type="month" id="targetMonth" style="padding:8px; border-radius:5px; border:1px solid #ccc;"></div>
            <div><label>المندوب</label><br><select id="creatorFilter" onchange="renderUI()" class="rep-select" style="width:200px;"></select></div>
            <button class="btn btn-acc" onclick="fetchData()"><i class="fas fa-sync"></i> جلب وحساب (الأحدث)</button>
            <button class="btn btn-g" onclick="exportExcel()"><i class="fas fa-file-excel"></i> تصدير</button>
        </div>
        
        <div id="debug-box" class="debug-info"></div>

        <div class="stats">
            <div class="card"><h3>المبيعات (المحصلة)</h3><div id="stat-sales" class="card-val">0</div></div>
            <div class="card" style="background:var(--acc)"><h3>البونص المستحق</h3><div id="stat-bonus" class="card-val">0</div></div>
            <div class="card" style="background:#e67e22"><h3>التارجت</h3><div id="stat-target" class="card-val">-</div></div>
        </div>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>المرجع</th><th>المندوب</th><th>المنتج (الموحد)</th><th>الكمية</th><th>سعر الوحدة (شامل)</th><th>التصنيف</th><th>النسبة</th><th>البونص</th><th>تاريخ السداد</th>
                    </tr>
                </thead>
                <tbody id="mainRows"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-suspended" class="tab-content">
        <div class="card" style="max-width:300px; background:#7f8c8d; margin-bottom:20px;">
            <h3>بونص متوقع (غير محصل)</h3><div id="stat-susp-bonus" class="card-val">0</div>
        </div>
        <table><thead><tr><th>المرجع</th><th>المندوب</th><th>المنتج</th><th>تاريخ الفاتورة</th><th>البونص المتوقع</th></tr></thead><tbody id="suspRows"></tbody></table>
    </div>

    <div id="tab-products" class="tab-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <h3><i class="fas fa-robot"></i> إعدادات الأسعار</h3>
            <div><button class="btn btn-acc" onclick="applySmartRules(true)">إعادة ضبط</button> <button class="btn btn-g" onclick="saveProductRules()">حفظ</button></div>
        </div>
        <table><thead><tr><th>المنتج</th><th>معامل الكرتون</th><th>سعر التميز (>=)</th><th>نسبة %</th><th>السعر الأساسي (<=)</th><th>نسبة %</th></tr></thead><tbody id="prodRows"></tbody></table>
    </div>

    <div id="tab-targets" class="tab-content">
        <button class="btn btn-g" onclick="saveTargetRules()">حفظ</button> <h3>أهداف المناديب</h3>
        <table><thead><tr><th>المندوب</th><th>المبيعات</th><th>الهدف</th><th>المكافأة</th><th>حجب؟</th><th>الحالة</th></tr></thead><tbody id="targetRows"></tbody></table>
    </div>

    <div id="tab-backup" class="tab-content">
        <button class="btn btn-acc" onclick="exportBackup()">تصدير JSON</button>
        <input type="file" id="importFile" onchange="importBackup(event)">
    </div>
</div>

<script>
    const DEFERRED_SKU = "754500950512";
    let rawInvoices = [], productsMap = {}, unitsMap = {}, creators = [];
    let creditNotesMap = {}; 
    let computed = [], suspended = [];

    let productRules = JSON.parse(localStorage.getItem('pRules_v29') || "{}");
    let targetRules = JSON.parse(localStorage.getItem('tRules_v29') || "{}");
    let repOverrides = JSON.parse(localStorage.getItem('repOverrides_v29') || "{}");
    let manualDeferred = JSON.parse(localStorage.getItem('manualDef_v29') || "[]");

    const AUTO_RULES = [
        { keys: ["ورق الكاشير", "80*70", "8070"], pp: 69, bp: 68 },
        { keys: ["A4"], pp: 58, bp: 57 },
        { keys: ["ورق الشبكة", "40*57", "57*40"], pp: 57, bp: 56 },
        { keys: ["ورق التاريخ", "رول تاريخ"], pp: 75, bp: 74 },
        { keys: ["رول التسعيرة", "رول تسعير"], pp: 126, bp: 125 },
        { keys: ["40*60", "60*40"], pp: 221, bp: 220 },
        { keys: ["25*50", "50*25"], pp: 241, bp: 240 },
        { keys: ["38*28", "28*38"], pp: 241, bp: 240 },
        { keys: ["40*22", "22*40"], pp: 241, bp: 240 },
        { keys: ["100*150", "150*100"], pp: 331, bp: 330 },
        { keys: ["حبر", "طابعة", "مكينة", "قارئ", "DRUM", "toner", "ink", "ezpos", "zpos"], pp: 1, ppct: 2, bp: 0, bpct: 0 }
    ];

    function switchTab(id) { document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById('tab-' + id).classList.add('active'); }

    async function fetchData() {
        const month = document.getElementById('targetMonth').value;
        const btn = document.querySelector('.btn-acc');
        const dbg = document.getElementById('debug-box');
        
        if(!month) return alert("حدد الشهر!");
        
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جلب...';
        dbg.style.display = 'block';
        dbg.innerHTML = "جاري الاتصال بالسيرفر...";

        try {
            const res = await fetch(`/api/get-data?month=${month}`);
            const data = await res.json();
            
            rawInvoices = data.invoices || [];
            productsMap = data.productsMap || {};
            
            unitsMap = {};
            if(data.product_units) {
                data.product_units.forEach(u => unitsMap[u.id] = parseFloat(u.conversion_factor || u.representation || 1));
            }
            
            creditNotesMap = {};
            if(data.credit_notes) data.credit_notes.forEach(cn => creditNotesMap[cn.id] = cn);
            
            creators = [...new Set(rawInvoices.map(i => i.created_by).filter(Boolean))];
            
            if(rawInvoices.length > 0) {
                const first = rawInvoices[0].issue_date;
                const last = rawInvoices[rawInvoices.length-1].issue_date;
                dbg.innerHTML = `تم جلب <b>${rawInvoices.length}</b> فاتورة.<br>النطاق: من <b>${last}</b> إلى <b>${first}</b>`;
            } else {
                dbg.innerHTML = "لم يتم العثور على فواتير.";
            }

            updateFilterDropdown();
            applySmartRules(); 
            processLogic();
            btn.innerHTML = 'تحديث';
        } catch (e) { console.error(e); dbg.innerHTML = "خطأ: " + e.message; btn.innerHTML = 'فشل'; }
    }

    function processLogic() {
        computed = []; suspended = [];
        const tMonthStr = document.getElementById('targetMonth').value;
        const [tYear, tMonth] = tMonthStr.split('-').map(Number);

        rawInvoices.forEach(inv => {
            const isManualDef = manualDeferred.includes(inv.id);
            const currentRep = repOverrides[inv.id] || inv.created_by;

            // الدفعات
            let isEligible = false;
            let displayDate = inv.issue_date;
            let paidRatio = 1; 
            let amountPaidInMonth = 0;
            let foundPayment = false;
            
            if (inv.payments && inv.payments.length > 0) {
                inv.payments.forEach(pay => {
                    const pDate = new Date(pay.date);
                    if (pDate.getMonth() + 1 === tMonth && pDate.getFullYear() === tYear) {
                        amountPaidInMonth += parseFloat(pay.amount);
                        displayDate = pay.date;
                        foundPayment = true;
                    }
                });
            }

            if (foundPayment) {
                isEligible = true;
                const total = parseFloat(inv.total) || 1;
                paidRatio = amountPaidInMonth / total;
            } else {
                const iDate = new Date(inv.issue_date);
                if (iDate.getMonth() + 1 === tMonth && iDate.getFullYear() === tYear) {
                    if (inv.status === 'Paid') {
                        isEligible = true;
                        displayDate = inv.issue_date + " (إصدار)";
                    }
                }
            }
            
            const isPending = (inv.status === 'Approved' || inv.status === 'Partially Paid') && !isEligible;

            // المرتجعات
            let specificReturns = {};
            if(inv.allocations) {
                inv.allocations.forEach(alloc => {
                    if(alloc.source_type === 'CreditNote') {
                        const cn = creditNotesMap[alloc.source_id];
                        if(cn && cn.line_items) cn.line_items.forEach(cnItem => specificReturns[cnItem.product_id] = (specificReturns[cnItem.product_id] || 0) + parseFloat(cnItem.quantity));
                    }
                });
            }

            inv.line_items.forEach(item => {
                if(item.sku === DEFERRED_SKU) return;
                
                const pid = item.product_id;
                const rule = productRules[pid] || {};

                // --- توحيد الاسم (The Fix for Names) ---
                // نستخدم الاسم من الخريطة الرئيسية (العربي) بدلاً من الفاتورة
                // إذا لم يوجد في الخريطة، نستخدم اسم الفاتورة كاحتياط
                const unifiedName = productsMap[pid] ? productsMap[pid].name : item.product_name;

                const rawPrice = parseFloat(item.unit_price);
                const taxMultiplier = 1 + (parseFloat(item.tax_percent || 0) / 100);
                const priceWithTax = rawPrice * taxMultiplier;

                // إصلاح الوحدات
                let currentUnitFactor = unitsMap[item.unit_type] || 1; 
                let multiplier = 1;
                if (currentUnitFactor > 1) {
                    multiplier = 1; 
                } else {
                    const manualFactor = parseFloat(rule.factor) || 0;
                    if (manualFactor > 1) multiplier = manualFactor;
                }
                const cartonPrice = priceWithTax * multiplier;

                const originalQty = parseFloat(item.quantity);
                const netQty = Math.max(0, originalQty - (specificReturns[pid] || 0));
                const bonusQty = netQty * paidRatio;

                if (bonusQty <= 0.001 && isEligible) return;

                const totalRowSales = priceWithTax * bonusQty;

                let pct = 0; let tier = "أقل من الحد"; let badge = "badge-r";
                const pPrice = parseFloat(rule.premiumPrice || 0);
                const bPrice = parseFloat(rule.basePrice || 0);

                // --- منطق الشروط العكسي V29 ---
                // 1. التميز: أكبر من أو يساوي
                if (pPrice > 0 && cartonPrice >= pPrice) { 
                    pct = rule.premiumPct || 2; tier = "تميز"; badge = "badge-p"; 
                } 
                // 2. الأساسي: أصغر من أو يساوي
                else if (bPrice > 0 && cartonPrice <= bPrice) { 
                    pct = rule.basePct || 1; tier = "أساسي"; badge = "badge-b"; 
                }
                // 3. حالة الأحبار (تلقائي)
                else if (rule.premiumPct > 0 && pPrice <= 1) { 
                    pct = rule.premiumPct; tier = "تلقائي"; badge = "badge-p"; 
                }

                const bonus = totalRowSales * (pct / 100);
                
                const record = { 
                    invId: inv.id, ref: inv.reference, rep: currentRep, 
                    prod: unifiedName, // استخدام الاسم الموحد
                    date: displayDate, 
                    sellCarton: cartonPrice, tier, badge, pct, bonus, total: totalRowSales,
                    qty: bonusQty.toFixed(1)
                };

                if (isEligible && !isManualDef) {
                    computed.push(record);
                } else if (isPending) {
                    record.qty = netQty.toFixed(1);
                    record.bonus = (priceWithTax * netQty * (pct/100)); 
                    record.prod = unifiedName; // تحديث الاسم في المعلق أيضاً
                    suspended.push(record);
                }
            });
        });
        renderUI();
    }

    function updateFilterDropdown() { const s=document.getElementById('creatorFilter'); const v=s.value; s.innerHTML='<option value="all">الكل</option>'; creators.forEach(c=>s.innerHTML+=`<option value="${c}">${c}</option>`); s.value=v; }
    function renderUI() {
        const rows = document.getElementById('mainRows'); rows.innerHTML = '';
        const filter = document.getElementById('creatorFilter').value;
        const filtered = computed.filter(d => filter === 'all' || d.rep === filter);
        let totalS = 0, totalB = 0;
        filtered.forEach(r => {
            totalS += r.total; totalB += r.bonus;
            rows.innerHTML += `<tr><td>${r.ref}</td><td>${r.rep}</td><td style="font-size:0.9em">${r.prod}</td><td>${r.qty}</td><td>${r.sellCarton.toFixed(2)}</td><td><span class="badge ${r.badge}">${r.tier}</span></td><td>${r.pct}%</td><td style="font-weight:bold">${r.bonus.toFixed(2)}</td><td style="font-size:0.8em">${r.date}</td></tr>`;
        });
        document.getElementById('stat-sales').innerText = totalS.toLocaleString();
        document.getElementById('stat-bonus').innerText = totalB.toLocaleString();
        renderSuspended(); renderProductRules(); renderTargetTable();
    }
    function renderSuspended() { const r=document.getElementById('suspRows'); r.innerHTML=''; suspended.filter(d=>document.getElementById('creatorFilter').value==='all'||d.rep===document.getElementById('creatorFilter').value).forEach(x=>{ r.innerHTML+=`<tr><td>${x.ref}</td><td>${x.rep}</td><td>${x.prod}</td><td>${x.date}</td><td>${x.bonus.toFixed(2)}</td></tr>`; }); }
    function renderProductRules() { const r=document.getElementById('prodRows'); r.innerHTML=''; Object.keys(productsMap).forEach(k=>{ const rule=productRules[k]||{}; const isAuto=AUTO_RULES.some(a=>a.keys.some(z=>productsMap[k].name.includes(z))); r.innerHTML+=`<tr><td>${isAuto?'<span class="auto-tag">T</span>':''}${productsMap[k].name}</td><td><input type="number" class="tbl-input" id="f_${k}" value="${rule.factor||0}"></td><td><input type="number" class="tbl-input" id="pp_${k}" value="${rule.premiumPrice||0}"></td><td><input type="number" class="tbl-input" id="ppct_${k}" value="${rule.premiumPct||2}"></td><td><input type="number" class="tbl-input" id="bp_${k}" value="${rule.basePrice||0}"></td><td><input type="number" class="tbl-input" id="bpct_${k}" value="${rule.basePct||1}"></td></tr>`; }); }
    function saveProductRules() { Object.keys(productsMap).forEach(k=>{ productRules[k]={factor:parseFloat(document.getElementById(`f_${k}`).value)||0, premiumPrice:parseFloat(document.getElementById(`pp_${k}`).value)||0, premiumPct:parseFloat(document.getElementById(`ppct_${k}`).value)||0, basePrice:parseFloat(document.getElementById(`bp_${k}`).value)||0, basePct:parseFloat(document.getElementById(`bpct_${k}`).value)||0}; }); localStorage.setItem('pRules_v29', JSON.stringify(productRules)); applySmartRules(); processLogic(); }
    function applySmartRules(force=false) { let cnt=0; Object.keys(productsMap).forEach(k=>{ if(!force&&productRules[k]&&(productRules[k].premiumPrice>0))return; const n=productsMap[k].name.toLowerCase(); for(let r of AUTO_RULES) if(r.keys.some(x=>n.includes(x.toLowerCase()))){ productRules[k]={factor:productRules[k]?.factor||0, premiumPrice:r.pp, premiumPct:r.ppct||2, basePrice:r.bp, basePct:r.bpct||1}; cnt++; break; } }); if(cnt>0) localStorage.setItem('pRules_v29', JSON.stringify(productRules)); }
    function saveTargetRules() { creators.forEach(c=>{ targetRules[c]={amt:parseFloat(document.getElementById(`ta_${c}`)?.value)||0, rwd:parseFloat(document.getElementById(`tr_${c}`)?.value)||0, blk:document.getElementById(`tk_${c}`)?.checked}; }); localStorage.setItem('tRules_v29', JSON.stringify(targetRules)); processLogic(); }
    function renderTargetTable() { const r=document.getElementById('targetRows'); r.innerHTML=''; creators.forEach(c=>{ const tr=targetRules[c]||{}; const sales=computed.filter(d=>d.rep===c).reduce((a,b)=>a+b.total,0); r.innerHTML+=`<tr><td>${c}</td><td>${sales.toLocaleString()}</td><td><input type="number" class="tbl-input" id="ta_${c}" value="${tr.amt||0}"></td><td><input type="number" class="tbl-input" id="tr_${c}" value="${tr.rwd||0}"></td><td><input type="checkbox" id="tk_${c}" ${tr.blk?'checked':''}></td><td>${sales>=tr.amt?'✅':'❌'}</td></tr>`; }); }
    function exportBackup() { const b=new Blob([JSON.stringify({pRules:productRules, tRules:targetRules, rep:repOverrides})],{type:'application/json'}); saveAs(b, "Bonus_Backup_V29.json"); }
    function importBackup(e) { const r=new FileReader(); r.onload=x=>{ const d=JSON.parse(x.target.result); productRules=d.pRules||{}; targetRules=d.tRules||{}; repOverrides=d.rep||{}; localStorage.setItem('pRules_v29',JSON.stringify(productRules)); processLogic(); alert('تم'); }; r.readAsText(e.target.files[0]); }
</script>
</body>
</html>
