<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>نظام حساب البونص - النسخة النهائية</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root{--p:#2c3e50; --acc:#2980b9; --bg:#f4f6f9; --g:#27ae60; --r:#c0392b; --orange:#e67e22;}
        *{margin:0; padding:0; box-sizing:border-box;}
        body{font-family:'Cairo', sans-serif; background:var(--bg); padding:20px; color:var(--p); line-height:1.6;}
        .container{background:#fff; border-radius:15px; max-width:1800px; margin:auto; box-shadow:0 4px 25px rgba(0,0,0,0.1); overflow:hidden;}
        
        .tabs{display:flex; background:var(--p); color:#fff; flex-wrap:wrap;}
        .tab{padding:15px 20px; cursor:pointer; background:transparent; border:none; color:#ccc; font-weight:bold; font-size:0.95em; transition:0.3s; flex:1; text-align:center; min-width:150px;}
        .tab.active{background:#fff; color:var(--p); border-top:4px solid var(--acc);}
        .tab:hover:not(.active){background:rgba(255,255,255,0.1);}
        
        .content{display:none; padding:25px;}
        .content.active{display:block;}
        
        .toolbar{display:flex; gap:12px; margin-bottom:25px; background:#f8f9fa; padding:20px; border-radius:12px; flex-wrap:wrap; align-items:flex-end;}
        .toolbar > div{flex:0 0 auto;}
        .toolbar label{display:block; margin-bottom:5px; font-weight:600; color:#555;}
        .toolbar input, .toolbar select{padding:10px; border-radius:6px; border:1px solid #ccc; font-family:'Cairo';}
        
        .stats{display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:15px; margin-bottom:25px;}
        .stat-card{background:linear-gradient(135deg, var(--p) 0%, #34495e 100%); color:#fff; padding:22px; border-radius:12px; text-align:center; box-shadow:0 3px 10px rgba(0,0,0,0.15);}
        .stat-card h3{font-size:0.95em; opacity:0.9; margin-bottom:8px;}
        .stat-val{font-size:2em; font-weight:bold; margin-top:5px;}
        .stat-card.accent{background:linear-gradient(135deg, var(--acc) 0%, #3498db 100%);}
        .stat-card.success{background:linear-gradient(135deg, var(--g) 0%, #2ecc71 100%);}
        .stat-card.warning{background:linear-gradient(135deg, var(--orange) 0%, #f39c12 100%);}
        
        .btn{padding:11px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; font-family:'Cairo'; transition:0.3s; display:inline-flex; align-items:center; gap:8px; font-size:0.95em;}
        .btn-primary{background:var(--acc); color:#fff;}
        .btn-success{background:var(--g); color:#fff;}
        .btn-warning{background:var(--orange); color:#fff;}
        .btn:hover{transform:translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,0.2);}
        .btn:disabled{opacity:0.6; cursor:not-allowed; transform:none;}
        
        table{width:100%; border-collapse:collapse; margin-top:15px; background:#fff; font-size:0.92em;}
        th{background:#f8f9fa; padding:14px 12px; text-align:right; border-bottom:2px solid #dee2e6; font-weight:700; position:sticky; top:0; z-index:10;}
        td{padding:12px; border-bottom:1px solid #eee; vertical-align:middle;}
        tr:hover{background:#f8f9fa;}
        
        .badge{padding:6px 12px; border-radius:20px; font-size:0.85em; font-weight:600; display:inline-block;}
        .badge-premium{background:#d4edda; color:#155724; border:1px solid #c3e6cb;}
        .badge-base{background:#fff3cd; color:#856404; border:1px solid #ffeeba;}
        .badge-none{background:#f8d7da; color:#721c24; border:1px solid #f5c6cb;}
        
        .input-table{width:90px; text-align:center; padding:7px; border:1px solid #ccc; border-radius:5px; font-family:'Cairo';}
        
        .alert{padding:15px 20px; border-radius:8px; margin:15px 0; display:flex; align-items:center; gap:12px;}
        .alert i{font-size:1.3em;}
        .alert-info{background:#d1ecf1; color:#0c5460; border:1px solid #bee5eb;}
        .alert-success{background:#d4edda; color:#155724; border:1px solid #c3e6cb;}
        .alert-warning{background:#fff3cd; color:#856404; border:1px solid #ffeeba;}
        .alert-error{background:#f8d7da; color:#721c24; border:1px solid #f5c6cb;}
        
        .loading{text-align:center; padding:40px; color:#666;}
        .loading i{font-size:2em; animation:spin 1s linear infinite;}
        @keyframes spin{to{transform:rotate(360deg);}}
        
        .empty-state{text-align:center; padding:60px 20px; color:#999;}
        .empty-state i{font-size:4em; margin-bottom:15px; opacity:0.3;}
        
        @media (max-width: 768px){
            .toolbar{flex-direction:column;}
            .toolbar > div{width:100%;}
            .stats{grid-template-columns:1fr;}
            table{font-size:0.85em;}
            th, td{padding:8px 6px;}
        }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab active" onclick="switchTab(0)"><i class="fas fa-money-bill-wave"></i> البونص المستحق</button>
        <button class="tab" onclick="switchTab(1)"><i class="fas fa-times-circle"></i> الفواتير المستبعدة</button>
        <button class="tab" onclick="switchTab(2)"><i class="fas fa-magic"></i> إعدادات الأسعار</button>
        <button class="tab" onclick="switchTab(3)"><i class="fas fa-cog"></i> الإعدادات</button>
    </div>

    <div class="content active">
        <div class="toolbar">
            <div>
                <label><i class="fas fa-calendar"></i> شهر التحصيل (للحساب)</label>
                <input type="month" id="targetMonth" style="width:180px;">
            </div>
            <div>
                <label><i class="fas fa-user"></i> المندوب</label>
                <select id="repFilter" onchange="filterData()" style="width:160px;">
                    <option value="all">الكل</option>
                </select>
            </div>
            <div>
                <label><i class="fas fa-history"></i> جلب الفواتير السابقة لـ</label>
                <select id="fetchMonths" style="width:130px;">
                    <option value="1">شهر واحد</option>
                    <option value="2">شهران</option>
                    <option value="3">3 أشهر</option>
                    <option value="4" selected>4 أشهر</option>
                    <option value="6">6 أشهر</option>
                </select>
            </div>
            <div>
                <label><i class="fas fa-cogs"></i> طريقة الجلب</label>
                <select id="fetchMethod" style="width:220px;">
                    <option value="chunks">أجزاء متتالية (موصى به - يمنع الانقطاع)</option>
                    <option value="all">دفعة واحدة (للسرعة)</option>
                </select>
            </div>
            <div style="margin-top:22px;">
                <button class="btn btn-primary" onclick="loadData()" id="loadBtn">
                    <i class="fas fa-sync-alt"></i> بدء الجلب
                </button>
            </div>
            <div style="margin-top:22px;">
                <button class="btn btn-success" onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i> تصدير إكسل
                </button>
            </div>
        </div>
        
        <div id="loadingStatus" style="display: none; margin-bottom: 20px; font-weight: bold; color: var(--acc); background: #e8f4f8; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #bee5eb;">
            <i class="fas fa-spinner fa-spin"></i> <span id="statusText">جاري التحضير...</span>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3>عدد الفواتير</h3>
                <div class="stat-val" id="stat-invoices">0</div>
            </div>
            <div class="stat-card accent">
                <h3>إجمالي المبيعات</h3>
                <div class="stat-val" id="stat-sales">0</div>
            </div>
            <div class="stat-card success">
                <h3>إجمالي البونص</h3>
                <div class="stat-val" id="stat-bonus">0</div>
            </div>
        </div>

        <div id="bonusTable"></div>
    </div>

    <div class="content">
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <div>
                <strong>الفواتير المستبعدة:</strong> تشمل الفواتير الآجلة التي لم تُدفع وأي فاتورة لم تُدفع في الشهر المحدد
            </div>
        </div>

        <div class="stats">
            <div class="stat-card warning">
                <h3>عدد الفواتير المستبعدة</h3>
                <div class="stat-val" id="stat-excluded">0</div>
            </div>
            <div class="stat-card warning">
                <h3>بونص محتمل (إذا دُفعت)</h3>
                <div class="stat-val" id="stat-potential">0</div>
            </div>
        </div>

        <div id="excludedTable"></div>
    </div>

    <div class="content">
        <div class="alert alert-info">
            <i class="fas fa-lightbulb"></i>
            <div>
                <strong>كيفية حساب البونص:</strong><br>
                • إذا كان سعر الكرتون ≥ السعر المحدد → بونص 2%<br>
                • إذا كان سعر الكرتون < السعر المحدد → بونص 1%
            </div>
        </div>

        <div style="margin-bottom:20px;">
            <button class="btn btn-success" onclick="saveSettings()">
                <i class="fas fa-save"></i> حفظ الإعدادات
            </button>
        </div>

        <div id="settingsTable"></div>
    </div>

    <div class="content">
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <div>
                <strong>تنبيه:</strong> النظام يسحب الفواتير للفترة المحددة. الفواتير تدخل البونص حسب تاريخ الدفع وليس تاريخ الإنشاء.
            </div>
        </div>

        <div style="background:#f8f9fa; padding:20px; border-radius:8px; margin-top:20px;">
            <h3 style="margin-bottom:15px;"><i class="fas fa-database"></i> النسخ الاحتياطي</h3>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn btn-primary" onclick="exportSettings()">
                    <i class="fas fa-download"></i> تصدير الإعدادات
                </button>
                <label class="btn btn-success" style="margin:0;">
                    <i class="fas fa-upload"></i> استيراد الإعدادات
                    <input type="file" id="importFile" style="display:none;" onchange="importSettings(event)">
                </label>
            </div>
        </div>

        <div style="background:#f8f9fa; padding:20px; border-radius:8px; margin-top:20px;">
            <h3 style="margin-bottom:15px;"><i class="fas fa-info-circle"></i> معلومات النظام</h3>
            <table style="width:auto;">
                <tr><td style="padding:8px; font-weight:600;">الإصدار:</td><td>2.0 الاحترافي (نظام الأجزاء)</td></tr>
                <tr><td style="padding:8px; font-weight:600;">آخر تحديث:</td><td>فبراير 2026</td></tr>
                <tr><td style="padding:8px; font-weight:600;">مسار البيانات:</td><td>/api/data.js</td></tr>
                <tr><td style="padding:8px; font-weight:600;">معيار الدخول:</td><td>تاريخ الدفع</td></tr>
            </table>
        </div>
    </div>
</div>

<script>
let allData = [];
let excludedData = [];
let reps = [];
let products = {};
let settings = JSON.parse(localStorage.getItem('bonusSettings') || '{}');

// تهيئة التاريخ
document.getElementById('targetMonth').value = new Date().toISOString().slice(0, 7);

function switchTab(index) {
    const tabs = document.querySelectorAll('.tab');
    const contents = document.querySelectorAll('.content');
    tabs.forEach((t, i) => {
        t.classList.toggle('active', i === index);
        contents[i].classList.toggle('active', i === index);
    });
}

// ✅ دالة الجلب المحدثة بمسار /api/data.js مع الامتداد
async function loadData() {
    const btn = document.getElementById('loadBtn');
    const targetMonth = document.getElementById('targetMonth').value;
    const fetchMonths = document.getElementById('fetchMonths').value;
    const method = document.getElementById('fetchMethod').value;
    const statusDiv = document.getElementById('loadingStatus');
    const statusText = document.getElementById('statusText');
    
    if (!targetMonth) {
        alert('⚠️ يرجى اختيار شهر التحصيل');
        return;
    }

    btn.disabled = true;
    statusDiv.style.display = 'block';

    try {
        let finalData = {};

        if (method === 'chunks') {
            statusText.innerText = "جاري جلب قائمة المنتجات... (1/4)";
            const prodRes = await fetch(`/api/data.js?type=products`);
            if (!prodRes.ok) throw new Error("الملف /api/data.js غير موجود، تأكد من رفعه على Vercel");
            const productsList = (await prodRes.json()).data;
            
            let productsMap = {};
            productsList.forEach(p => {
                productsMap[p.id] = { name: p.name_ar || p.name_en, sku: p.sku || "", id: p.id };
            });

            statusText.innerText = "جاري جلب وحدات القياس... (2/4)";
            const unitsRes = await fetch(`/api/data.js?type=units`);
            const unitsList = (await unitsRes.json()).data;

            statusText.innerText = `جاري جلب الفواتير لآخر ${fetchMonths} أشهر... (3/4)`;
            const invRes = await fetch(`/api/data.js?type=invoices&months=${fetchMonths}`);
            const invoicesList = (await invRes.json()).data;

            statusText.innerText = `جاري جلب المرتجعات لآخر ${fetchMonths} أشهر... (4/4)`;
            const retRes = await fetch(`/api/data.js?type=returns&months=${fetchMonths}`);
            const returnsList = (await retRes.json()).data;

            finalData = {
                success: true,
                productsMap: productsMap,
                product_units: unitsList,
                invoices: invoicesList,
                credit_notes: returnsList
            };

        } else {
            statusText.innerText = `جاري جلب كافة البيانات لآخر ${fetchMonths} أشهر دفعة واحدة... برجاء الانتظار`;
            const res = await fetch(`/api/data.js?type=all&months=${fetchMonths}`);
            if (!res.ok) throw new Error("الملف /api/data.js غير موجود، تأكد من رفعه على Vercel");
            finalData = await res.json();
            
            if (!finalData.success) {
                throw new Error("فشل الجلب دفعة واحدة، يرجى المحاولة باستخدام خيار الأجزاء المتتالية.");
            }
        }

        statusText.innerText = "✅ اكتمل الجلب بنجاح! جاري معالجة البيانات...";
        
        processData(finalData, targetMonth);
        renderAll();

        setTimeout(() => { statusDiv.style.display = 'none'; }, 3500);

    } catch (error) {
        console.error("خطأ:", error);
        statusText.innerHTML = `<span style="color:red;"><i class="fas fa-exclamation-triangle"></i> حدث خطأ: ${error.message}</span>`;
    } finally {
        btn.disabled = false;
    }
}

// دالة المعالجة 
function processData(data, targetMonth) {
    allData = [];
    excludedData = [];
    reps = new Set();
    products = data.productsMap || {};
    
    const invoices = data.invoices || [];
    const units = {};
    (data.product_units || []).forEach(u => units[u.id] = u.name_ar || u.name_en);
    
    const returns = {};
    (data.credit_notes || []).forEach(cn => {
        const ref = cn.invoice_reference;
        if (!ref) return;
        returns[ref] = returns[ref] || [];
        returns[ref].push(cn);
    });

    const [targetYear, targetMon] = targetMonth.split('-');

    invoices.forEach(inv => {
        const paymentDate = inv.payment_date;
        const status = inv.status;
        const rep = inv.creator || 'غير محدد';
        const invRef = inv.reference || inv.id;
        
        reps.add(rep);

        (inv.inventory_items || []).forEach(item => {
            const productId = item.product_id;
            if (!products[productId]) return;

            const productName = products[productId].name;
            const unitType = item.unit_type;
            const unitName = units[unitType] || '';
            let quantity = parseFloat(item.quantity) || 0;
            const unitPrice = parseFloat(item.unit_price) || 0;

            (returns[invRef] || []).forEach(cn => {
                (cn.inventory_items || []).forEach(ci => {
                    if (ci.product_id === productId && ci.unit_type === unitType) {
                        quantity -= parseFloat(ci.quantity) || 0;
                    }
                });
            });

            if (quantity <= 0) return;

            const isCarton = unitName.toLowerCase().includes('كرتون') || unitName.toLowerCase().includes('carton');
            let cartonQty = quantity;
            let cartonPrice = unitPrice;

            if (!isCarton) {
                const factor = settings[productId]?.factor || 0;
                if (factor > 0) {
                    cartonQty = quantity / factor;
                    cartonPrice = unitPrice * factor;
                } else {
                    cartonQty = quantity;
                    cartonPrice = unitPrice;
                }
            }

            const threshold = settings[productId]?.threshold || 0;
            let bonusRate = 0;
            let tier = 'لا يوجد';

            if (threshold > 0) {
                if (cartonPrice >= threshold) {
                    bonusRate = 2;
                    tier = 'تميز (2%)';
                } else {
                    bonusRate = 1;
                    tier = 'أساسي (1%)';
                }
            }

            const bonus = (cartonPrice * cartonQty * bonusRate) / 100;
            const totalSales = cartonPrice * cartonQty;

            const record = {
                rep,
                invRef,
                productName,
                cartonQty: cartonQty.toFixed(2),
                cartonPrice: cartonPrice.toFixed(2),
                totalSales: totalSales.toFixed(2),
                tier,
                bonusRate,
                bonus: bonus.toFixed(2),
                paymentDate: paymentDate || 'غير مدفوعة',
                issueDate: inv.issue_date || '',
                status
            };

            if (status === 'Paid' && paymentDate) {
                const [payYear, payMon] = paymentDate.split('-');
                if (payYear === targetYear && payMon === targetMon) {
                    allData.push(record);
                } else {
                    excludedData.push({...record, reason: 'مدفوعة في شهر آخر'});
                }
            } else {
                excludedData.push({...record, reason: status === 'Paid' ? 'لا يوجد تاريخ دفع' : 'غير مدفوعة'});
            }
        });
    });

    reps = Array.from(reps).sort();
}

function filterData() {
    renderBonusTable();
    renderExcludedTable();
    updateStats();
}

function renderAll() {
    updateRepFilter();
    renderBonusTable();
    renderExcludedTable();
    renderSettings();
    updateStats();
}

function updateRepFilter() {
    const select = document.getElementById('repFilter');
    const current = select.value;
    select.innerHTML = '<option value="all">الكل</option>';
    reps.forEach(r => {
        select.innerHTML += `<option value="${r}">${r}</option>`;
    });
    select.value = current;
}

function renderBonusTable() {
    const filter = document.getElementById('repFilter').value;
    const filtered = filter === 'all' ? allData : allData.filter(d => d.rep === filter);

    const container = document.getElementById('bonusTable');
    
    if (filtered.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>لا توجد فواتير مدفوعة في الشهر المحدد</p>
            </div>
        `;
        return;
    }

    let html = `
        <table>
            <thead>
                <tr>
                    <th>المندوب</th>
                    <th>رقم الفاتورة</th>
                    <th>المنتج</th>
                    <th>الكمية (كرتون)</th>
                    <th>سعر الكرتون</th>
                    <th>إجمالي المبيعات</th>
                    <th>الفئة</th>
                    <th>البونص</th>
                    <th>تاريخ الدفع</th>
                </tr>
            </thead>
            <tbody>
    `;

    filtered.forEach(row => {
        const badge = row.bonusRate === 2 ? 'badge-premium' : (row.bonusRate === 1 ? 'badge-base' : 'badge-none');
        html += `
            <tr>
                <td><strong>${row.rep}</strong></td>
                <td>${row.invRef}</td>
                <td>${row.productName}</td>
                <td>${row.cartonQty}</td>
                <td>${parseFloat(row.cartonPrice).toLocaleString()} ريال</td>
                <td><strong>${parseFloat(row.totalSales).toLocaleString()} ريال</strong></td>
                <td><span class="badge ${badge}">${row.tier}</span></td>
                <td><strong style="color:var(--g);">${parseFloat(row.bonus).toLocaleString()} ريال</strong></td>
                <td>${row.paymentDate}</td>
            </tr>
        `;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
}

function renderExcludedTable() {
    const filter = document.getElementById('repFilter').value;
    const filtered = filter === 'all' ? excludedData : excludedData.filter(d => d.rep === filter);

    const container = document.getElementById('excludedTable');
    
    if (filtered.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-check-circle"></i>
                <p>لا توجد فواتير مستبعدة</p>
            </div>
        `;
        return;
    }

    let html = `
        <table>
            <thead>
                <tr>
                    <th>المندوب</th>
                    <th>رقم الفاتورة</th>
                    <th>المنتج</th>
                    <th>الكمية</th>
                    <th>سعر الكرتون</th>
                    <th>البونص المحتمل</th>
                    <th>سبب الاستبعاد</th>
                    <th>تاريخ الإنشاء</th>
                </tr>
            </thead>
            <tbody>
    `;

    filtered.forEach(row => {
        html += `
            <tr>
                <td>${row.rep}</td>
                <td>${row.invRef}</td>
                <td>${row.productName}</td>
                <td>${row.cartonQty}</td>
                <td>${parseFloat(row.cartonPrice).toLocaleString()}</td>
                <td style="color:#666;">${parseFloat(row.bonus).toLocaleString()} ريال</td>
                <td><span class="badge badge-none">${row.reason}</span></td>
                <td>${row.issueDate}</td>
            </tr>
        `;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
}

function renderSettings() {
    const container = document.getElementById('settingsTable');
    
    if (Object.keys(products).length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-box-open"></i><p>لا توجد منتجات (قم بجلب البيانات أولاً)</p></div>';
        return;
    }

    let html = `
        <table>
            <thead>
                <tr>
                    <th>المنتج</th>
                    <th>معامل التحويل للكرتون</th>
                    <th>السعر الأدنى للبونص 2%</th>
                </tr>
            </thead>
            <tbody>
    `;

    Object.keys(products).sort((a, b) => 
        products[a].name.localeCompare(products[b].name, 'ar')
    ).forEach(pid => {
        const s = settings[pid] || {};
        html += `
            <tr>
                <td><strong>${products[pid].name}</strong></td>
                <td>
                    <input type="number" class="input-table" id="factor_${pid}" 
                           value="${s.factor || 0}" min="0" step="1">
                    <small style="color:#666; margin-right:5px;">وحدة/كرتون</small>
                </td>
                <td>
                    <input type="number" class="input-table" id="threshold_${pid}" 
                           value="${s.threshold || 0}" min="0" step="0.5">
                    <small style="color:#666; margin-right:5px;">ريال</small>
                </td>
            </tr>
        `;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
}

function updateStats() {
    const filter = document.getElementById('repFilter').value;
    const filtered = filter === 'all' ? allData : allData.filter(d => d.rep === filter);
    const filteredExcluded = filter === 'all' ? excludedData : excludedData.filter(d => d.rep === filter);

    const totalSales = filtered.reduce((sum, d) => sum + parseFloat(d.totalSales), 0);
    const totalBonus = filtered.reduce((sum, d) => sum + parseFloat(d.bonus), 0);
    const potentialBonus = filteredExcluded.reduce((sum, d) => sum + parseFloat(d.bonus), 0);

    document.getElementById('stat-invoices').textContent = filtered.length;
    document.getElementById('stat-sales').textContent = totalSales.toLocaleString() + ' ريال';
    document.getElementById('stat-bonus').textContent = totalBonus.toLocaleString() + ' ريال';
    document.getElementById('stat-excluded').textContent = filteredExcluded.length;
    document.getElementById('stat-potential').textContent = potentialBonus.toLocaleString() + ' ريال';
}

function saveSettings() {
    Object.keys(products).forEach(pid => {
        const factor = document.getElementById(`factor_${pid}`);
        const threshold = document.getElementById(`threshold_${pid}`);
        
        settings[pid] = {
            factor: parseFloat(factor.value) || 0,
            threshold: parseFloat(threshold.value) || 0
        };
    });

    localStorage.setItem('bonusSettings', JSON.stringify(settings));
    
    if (allData.length > 0 || excludedData.length > 0) {
        const targetMonth = document.getElementById('targetMonth').value;
        processData({ productsMap: products, invoices: [], product_units: [], credit_notes: [] }, targetMonth); 
        alert('✅ تم حفظ الإعدادات بنجاح. يرجى الضغط على زر "بدء الجلب" مجدداً لتطبيقها على الحسابات.');
    } else {
        alert('✅ تم حفظ الإعدادات بنجاح');
    }
}

async function exportToExcel() {
    const filter = document.getElementById('repFilter').value;
    const month = document.getElementById('targetMonth').value;
    
    if (!allData.length) {
        alert('⚠️ لا توجد بيانات للتصدير');
        return;
    }

    const workbook = new ExcelJS.Workbook();
    const sheet = workbook.addWorksheet('البونص');

    const dataToExport = filter === 'all' ? allData : allData.filter(d => d.rep === filter);

    sheet.columns = [
        { header: 'المندوب', key: 'rep', width: 20 },
        { header: 'رقم الفاتورة', key: 'invRef', width: 15 },
        { header: 'المنتج', key: 'productName', width: 30 },
        { header: 'الكمية', key: 'cartonQty', width: 12 },
        { header: 'سعر الكرتون', key: 'cartonPrice', width: 15 },
        { header: 'المبيعات', key: 'totalSales', width: 15 },
        { header: 'الفئة', key: 'tier', width: 15 },
        { header: 'البونص', key: 'bonus', width: 12 },
        { header: 'تاريخ الدفع', key: 'paymentDate', width: 15 }
    ];

    const headerRow = sheet.getRow(1);
    headerRow.font = { bold: true, color: { argb: 'FFFFFFFF' } };
    headerRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2C3E50' } };
    headerRow.alignment = { horizontal: 'center', vertical: 'middle' };

    if (filter === 'all') {
        const byRep = {};
        dataToExport.forEach(d => {
            if (!byRep[d.rep]) byRep[d.rep] = [];
            byRep[d.rep].push(d);
        });

        Object.keys(byRep).sort().forEach(rep => {
            const repData = byRep[rep];
            const repTotal = repData.reduce((sum, d) => sum + parseFloat(d.bonus), 0);

            repData.forEach(row => {
                const dataRow = sheet.addRow(row);
                if (row.bonusRate === 2) {
                    dataRow.getCell('tier').fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD4EDDA' } };
                } else if (row.bonusRate === 1) {
                    dataRow.getCell('tier').fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFF3CD' } };
                }
            });

            const totalRow = sheet.addRow({
                productName: `إجمالي ${rep}`,
                bonus: repTotal.toFixed(2)
            });
            totalRow.font = { bold: true };
            totalRow.getCell('productName').fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE8F0F2' } };
            totalRow.getCell('bonus').fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD4EDDA' } };
            
            sheet.addRow([]);
        });
    } else {
        dataToExport.forEach(row => {
            const dataRow = sheet.addRow(row);
            if (row.bonusRate === 2) {
                dataRow.getCell('tier').fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD4EDDA' } };
            } else if (row.bonusRate === 1) {
                dataRow.getCell('tier').fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFF3CD' } };
            }
        });

        const total = dataToExport.reduce((sum, d) => sum + parseFloat(d.bonus), 0);
        const totalRow = sheet.addRow({
            productName: `الإجمالي`,
            bonus: total.toFixed(2)
        });
        totalRow.font = { bold: true };
        totalRow.getCell('productName').fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE8F0F2' } };
        totalRow.getCell('bonus').fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD4EDDA' } };
    }

    const buffer = await workbook.xlsx.writeBuffer();
    const filename = filter === 'all' 
        ? `البونص_الكل_${month}.xlsx`
        : `البونص_${filter}_${month}.xlsx`;
    
    saveAs(new Blob([buffer]), filename);
}

function exportSettings() {
    const data = { settings, products };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    saveAs(blob, 'bonus_settings.json');
}

function importSettings(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = JSON.parse(e.target.result);
            settings = data.settings || {};
            localStorage.setItem('bonusSettings', JSON.stringify(settings));
            renderSettings();
            alert('✅ تم استيراد الإعدادات بنجاح');
        } catch (error) {
            alert('❌ خطأ في قراءة الملف');
        }
    };
    reader.readAsText(file);
}
</script>

</body>
</html>
