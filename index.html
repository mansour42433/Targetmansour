<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨ÙˆÙ†Øµ (Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø£ÙˆÙ„Ø§Ù‹)</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root{--p:#2c3e50; --acc:#2980b9; --bg:#f4f6f9; --g:#27ae60; --r:#c0392b;}
        body{font-family:'Cairo', sans-serif; background:var(--bg); padding:20px; color:var(--p); line-height:1.6;}
        .container{background:#fff; border-radius:15px; max-width:1800px; margin:auto; box-shadow:0 4px 25px rgba(0,0,0,0.1); padding:20px;}
        
        .toolbar{display:flex; gap:15px; margin-bottom:25px; background:#f8f9fa; padding:20px; border-radius:12px; flex-wrap:wrap; align-items:flex-end;}
        .toolbar label{display:block; margin-bottom:5px; font-weight:600;}
        .toolbar input, .toolbar select{padding:10px; border-radius:6px; border:1px solid #ccc; font-family:'Cairo'; width: 200px;}
        
        .btn{padding:10px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; font-family:'Cairo'; color:#fff; display:inline-flex; align-items:center; gap:8px;}
        .btn-primary{background:var(--acc);}
        .btn-success{background:var(--g);}
        
        table{width:100%; border-collapse:collapse; background:#fff; margin-top: 20px;}
        th{background:#2c3e50; color: white; padding:12px; text-align:right; border-bottom:2px solid #ddd;}
        td{padding:12px; border-bottom:1px solid #eee;}
        tr:hover{background:#f1f1f1;}
        
        .stat-box { display: flex; gap: 20px; margin-bottom: 20px; }
        .card { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); flex: 1; text-align: center; border-bottom: 4px solid var(--acc); }
        .card h3 { margin: 0 0 10px; font-size: 1em; color: #777; }
        .card div { font-size: 2em; font-weight: bold; color: var(--p); }

        .badge { padding: 5px 10px; border-radius: 15px; font-size: 0.8em; font-weight: bold; }
        .badge-2 { background: #d4edda; color: #155724; }
        .badge-1 { background: #fff3cd; color: #856404; }
        
        #loading { display: none; text-align: center; padding: 20px; font-weight: bold; color: var(--acc); }
    </style>
</head>
<body>

<div class="container">
    <h2 style="margin-bottom: 20px;"><i class="fas fa-cubes"></i> Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨ÙˆÙ†Øµ (Ø­Ø³Ø¨ ØªØ³Ù„Ø³Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª)</h2>

    <div class="toolbar">
        <div>
            <label>Ø´Ù‡Ø± Ø§Ù„ØªØ­ØµÙŠÙ„ (ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹)</label>
            <input type="month" id="targetMonth">
        </div>
        <div>
            <label>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</label>
            <select id="repFilter" onchange="renderTable()"><option value="all">Ø§Ù„ÙƒÙ„</option></select>
        </div>
        <div>
            <button class="btn btn-primary" onclick="loadData()"><i class="fas fa-sync"></i> Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            <button class="btn btn-success" onclick="exportExcel()"><i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„</button>
        </div>
    </div>

    <div id="loading"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ ÙˆÙ…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</div>

    <div class="stat-box">
        <div class="card"><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©)</h3><div id="totalSales">0</div></div>
        <div class="card" style="border-color: var(--g);"><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙˆÙ†Øµ Ø§Ù„Ù…Ø³ØªØ­Ù‚</h3><div id="totalBonus">0</div></div>
        <div class="card" style="border-color: var(--r);"><h3>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</h3><div id="totalProducts">0</div></div>
    </div>

    <details style="margin-bottom: 20px; background: #f9f9f9; padding: 15px; border-radius: 8px;">
        <summary style="cursor: pointer; font-weight: bold;">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¨ÙˆÙ†Øµ (2% Ùˆ Ø§Ù„ØªØ­ÙˆÙŠÙ„)</summary>
        <div id="settingsContainer" style="margin-top: 15px; max-height: 300px; overflow-y: auto;">
            <p>Ø§Ø¶ØºØ· Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¸Ù‡ÙˆØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù‡Ù†Ø§.</p>
        </div>
        <button class="btn btn-primary" onclick="saveSettings()" style="margin-top: 10px;">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </details>

    <div id="tableContainer"></div>
</div>

<script>
let productsDB = []; // Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
let invoicesDB = []; // Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙˆØ§ØªÙŠØ±
let unitsDB = {};    // Ø§Ù„ÙˆØ­Ø¯Ø§Øª
let returnsDB = {};  // Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª
let processedData = []; // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
let settings = JSON.parse(localStorage.getItem('bonusSettings') || '{}');

document.getElementById('targetMonth').value = new Date().toISOString().slice(0, 7);

async function loadData() {
    const loader = document.getElementById('loading');
    loader.style.display = 'block';
    loader.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± ÙˆØ¬Ù„Ø¨ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…...";

    try {
        // 1. Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)
        const prodRes = await fetch('/api/data.js?type=products');
        const prodData = await prodRes.json();
        productsDB = prodData.data || [];

        // 2. Ø¬Ù„Ø¨ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
        const unitRes = await fetch('/api/data.js?type=units');
        const unitData = await unitRes.json();
        (unitData.data || []).forEach(u => unitsDB[u.id] = u.name_ar || u.name_en);

        // 3. Ø¬Ù„Ø¨ Ø§Ù„ÙÙˆØ§ØªÙŠØ± (Ø³Ù†Ø© ÙƒØ§Ù…Ù„Ø©)
        loader.innerText = "Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„ÙÙˆØ§ØªÙŠØ± (Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ù‚Ù„ÙŠÙ„Ø§Ù‹)...";
        const invRes = await fetch('/api/data.js?type=invoices');
        const invData = await invRes.json();
        invoicesDB = invData.data || [];

        // 4. Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª
        const retRes = await fetch('/api/data.js?type=returns');
        const retData = await retRes.json();
        (retData.data || []).forEach(cn => {
            if(cn.invoice_reference) {
                if(!returnsDB[cn.invoice_reference]) returnsDB[cn.invoice_reference] = [];
                returnsDB[cn.invoice_reference].push(cn);
            }
        });

        loader.innerText = "Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ØªØ³Ù„Ø³Ù„...";
        processByProduct(); // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        
        renderSettings(); // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        loader.style.display = 'none';

    } catch (e) {
        alert("Ø®Ø·Ø£: " + e.message);
        loader.style.display = 'none';
    }
}

// ğŸ’¡ Ø§Ù„Ù„Ø¨: Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬
function processByProduct() {
    processedData = [];
    const targetMonth = document.getElementById('targetMonth').value;
    const [tYear, tMon] = targetMonth.split('-');

    // 1. Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¹Ù„Ù‰ ÙƒÙ„ Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…
    productsDB.forEach(product => {
        const productId = product.id;
        const productName = product.name_ar || product.name_en;

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬
        const productSettings = settings[productId] || { factor: 0, threshold: 0 };
        const factor = productSettings.factor;
        const threshold = productSettings.threshold;

        // 2. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ø¯Ø§Ø®Ù„ ÙƒÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
        invoicesDB.forEach(inv => {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹ Ù„Ù„ÙØ§ØªÙˆØ±Ø©
            if (inv.status !== 'Paid' || !inv.payment_date) return;
            const [pYear, pMon] = inv.payment_date.split('-');
            if (pYear !== tYear || pMon !== tMon) return; // ØªØ®Ø·ÙŠ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† ÙÙŠ Ø´Ù‡Ø± Ø§Ù„ØªØ­ØµÙŠÙ„

            const rep = inv.creator || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ù†ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙƒÙ†ØµÙˆØµ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ·Ø§Ø¨Ù‚)
            const items = inv.line_items || inv.inventory_items || inv.invoice_items || [];
            
            items.forEach(item => {
                // Ù…Ù‚Ø§Ø±Ù†Ø© ID Ø§Ù„Ù…Ù†ØªØ¬ (ØªØ­ÙˆÙŠÙ„ Ù„Ù€ String Ù„Ù„Ø£Ù…Ø§Ù†)
                if (String(item.product_id) === String(productId)) {
                    
                    let qty = parseFloat(item.quantity) || 0;
                    const unitPrice = parseFloat(item.unit_price) || 0;

                    // Ø®ØµÙ… Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ ØªØ­Ø¯ÙŠØ¯Ø§Ù‹
                    if (returnsDB[inv.reference]) {
                        returnsDB[inv.reference].forEach(cn => {
                            const cnItems = cn.line_items || cn.inventory_items || [];
                            cnItems.forEach(ci => {
                                if (String(ci.product_id) === String(productId)) {
                                    qty -= parseFloat(ci.quantity) || 0;
                                }
                            });
                        });
                    }

                    if (qty <= 0) return;

                    // ØªØ­ÙˆÙŠÙ„ ÙˆØ­Ø¯Ø§Øª (ÙƒØ±ØªÙˆÙ†)
                    const unitName = unitsDB[item.unit_type] || "";
                    const isCarton = unitName.includes("ÙƒØ±ØªÙˆÙ†") || unitName.includes("carton");
                    
                    let finalQty = qty;
                    let finalPrice = unitPrice;

                    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† ÙƒØ±ØªÙˆÙ†ØŒ ÙˆÙ‚Ù…Ù†Ø§ Ø¨ÙˆØ¶Ø¹ Ù…Ø¹Ø§Ù…Ù„ ØªØ­ÙˆÙŠÙ„ØŒ Ù†Ø­ÙˆÙ„Ù‡
                    if (!isCarton && factor > 0) {
                        finalQty = qty / factor;
                        finalPrice = unitPrice * factor;
                    }

                    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨ÙˆÙ†Øµ
                    let rate = 1;
                    let tier = "Ø£Ø³Ø§Ø³ÙŠ 1%";
                    if (threshold > 0 && finalPrice >= threshold) {
                        rate = 2;
                        tier = "Ù…Ù…ØªØ§Ø² 2%";
                    }

                    const totalSales = finalQty * finalPrice;
                    const bonus = (totalSales * rate) / 100;

                    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„
                    processedData.push({
                        productName: productName,
                        rep: rep,
                        invRef: inv.reference,
                        paymentDate: inv.payment_date,
                        qty: finalQty.toFixed(2),
                        price: finalPrice.toFixed(2),
                        total: totalSales.toFixed(2),
                        rate: rate,
                        tier: tier,
                        bonus: bonus.toFixed(2)
                    });
                }
            });
        });
    });

    renderTable();
}

function renderTable() {
    const filterRep = document.getElementById('repFilter').value;
    const container = document.getElementById('tableContainer');
    
    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨
    const reps = [...new Set(processedData.map(d => d.rep))].sort();
    const select = document.getElementById('repFilter');
    if (select.options.length === 1) {
        reps.forEach(r => select.innerHTML += `<option value="${r}">${r}</option>`);
    }

    // ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const data = filterRep === 'all' ? processedData : processedData.filter(d => d.rep === filterRep);

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
    const totalSales = data.reduce((sum, d) => sum + parseFloat(d.total), 0);
    const totalBonus = data.reduce((sum, d) => sum + parseFloat(d.bonus), 0);
    
    document.getElementById('totalSales').innerText = totalSales.toLocaleString();
    document.getElementById('totalBonus').innerText = totalBonus.toLocaleString();
    document.getElementById('totalProducts').innerText = data.length;

    if (data.length === 0) {
        container.innerHTML = `<div style="text-align:center; padding:40px; color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</div>`;
        return;
    }

    // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    let html = `
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                    <th>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th>
                    <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                    <th>Ø§Ù„ÙƒÙ…ÙŠØ© (ÙƒØ±ØªÙˆÙ†)</th>
                    <th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    <th>Ø§Ù„ÙØ¦Ø©</th>
                    <th>Ø§Ù„Ø¨ÙˆÙ†Øµ</th>
                </tr>
            </thead>
            <tbody>
    `;

    data.forEach(row => {
        const badgeClass = row.rate === 2 ? 'badge-2' : 'badge-1';
        html += `
            <tr>
                <td style="font-weight:bold;">${row.productName}</td>
                <td>${row.rep}</td>
                <td>${row.invRef}</td>
                <td>${row.qty}</td>
                <td>${row.price}</td>
                <td>${row.total}</td>
                <td><span class="badge ${badgeClass}">${row.tier}</span></td>
                <td style="color: green; font-weight:bold;">${row.bonus}</td>
            </tr>
        `;
    });

    html += `</tbody></table>`;
    container.innerHTML = html;
}

function renderSettings() {
    const container = document.getElementById('settingsContainer');
    if(productsDB.length === 0) return;

    let html = `<table style="font-size:0.9em;"><thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>ØªØ­ÙˆÙŠÙ„ Ù„Ù„ÙƒØ±ØªÙˆÙ†</th><th>Ø³Ø¹Ø± Ù‡Ø¯Ù 2%</th></tr></thead><tbody>`;
    
    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø£Ø¨Ø¬Ø¯ÙŠØ§Ù‹
    productsDB.sort((a,b) => (a.name_ar||"").localeCompare(b.name_ar||"")).forEach(p => {
        const s = settings[p.id] || { factor: 0, threshold: 0 };
        html += `
            <tr>
                <td>${p.name_ar || p.name_en}</td>
                <td><input type="number" id="fac_${p.id}" value="${s.factor}" style="width:60px; text-align:center;"></td>
                <td><input type="number" id="thr_${p.id}" value="${s.threshold}" style="width:60px; text-align:center;"></td>
            </tr>
        `;
    });
    html += `</tbody></table>`;
    container.innerHTML = html;
}

function saveSettings() {
    productsDB.forEach(p => {
        const fac = document.getElementById(`fac_${p.id}`);
        const thr = document.getElementById(`thr_${p.id}`);
        if(fac && thr) {
            settings[p.id] = {
                factor: parseFloat(fac.value) || 0,
                threshold: parseFloat(thr.value) || 0
            };
        }
    });
    localStorage.setItem('bonusSettings', JSON.stringify(settings));
    alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª! Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¢Ù†.");
    processByProduct(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ ÙÙˆØ±Ø§Ù‹
}

async function exportExcel() {
    const filterRep = document.getElementById('repFilter').value;
    const data = filterRep === 'all' ? processedData : processedData.filter(d => d.rep === filterRep);
    
    if(data.length === 0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª");

    const wb = new ExcelJS.Workbook();
    const ws = wb.addWorksheet('ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨ÙˆÙ†Øµ');
    
    ws.columns = [
        { header: 'Ø§Ù„Ù…Ù†ØªØ¬', key: 'productName', width: 30 },
        { header: 'Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨', key: 'rep', width: 20 },
        { header: 'Ø§Ù„ÙØ§ØªÙˆØ±Ø©', key: 'invRef', width: 15 },
        { header: 'Ø§Ù„ÙƒÙ…ÙŠØ©', key: 'qty', width: 10 },
        { header: 'Ø§Ù„Ø³Ø¹Ø±', key: 'price', width: 10 },
        { header: 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', key: 'total', width: 15 },
        { header: 'Ø§Ù„Ø¨ÙˆÙ†Øµ', key: 'bonus', width: 15 },
    ];
    
    // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø±Ø£Ø³
    ws.getRow(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };
    ws.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2980B9' } };

    data.forEach(d => {
        ws.addRow(d);
    });

    const buf = await wb.xlsx.writeBuffer();
    saveAs(new Blob([buf]), 'Bonus_Report.xlsx');
}
</script>

</body>
</html>
