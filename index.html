<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>نظام البونص الشامل (مع الفواتير المعلقة)</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
    :root{--p:#2c3e50; --acc:#2980b9; --bg:#f4f6f9; --g:#27ae60; --r:#c0392b; --w:#f39c12;}
    body{font-family:'Cairo', sans-serif; background:var(--bg); padding:20px; color: var(--p);}
    .box{background:#fff;padding:0;border-radius:15px;max-width:1400px;margin:auto;box-shadow: 0 4px 20px rgba(0,0,0,0.05); overflow: hidden;}
    
    .tabs-header {display: flex; background: var(--p); color: #fff;}
    .tab-btn {padding: 15px 25px; cursor: pointer; background: transparent; border: none; color: #ccc; font-family: 'Cairo'; font-weight: bold; font-size: 1.1em; transition: 0.3s;}
    .tab-btn:hover {color: #fff; background: rgba(255,255,255,0.1);}
    .tab-btn.active {background: #fff; color: var(--p); border-top: 4px solid var(--acc);}
    .tab-content {display: none; padding: 20px;}
    .tab-content.active {display: block;}

    .input-grp {margin-bottom: 10px;}
    .input-grp label {display: block; font-weight: bold; font-size: 0.85em; margin-bottom: 5px;}
    .input-grp input, .input-grp select {padding: 8px; border: 1px solid #ccc; border-radius: 5px; width: 200px;}
    
    .calc-btn {background: var(--acc); color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;}
    .save-btn {background: var(--g); color: #fff; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;}
    .exclude-btn {background: #fff; color: var(--r); border: 1px solid var(--r); padding: 4px 8px; font-size: 0.8em; cursor: pointer; border-radius: 4px;}
    .exclude-btn.active {background: var(--r); color: #fff;}
    .restore-btn {background: var(--g); color: #fff; border: none; padding: 4px 8px; font-size: 0.8em; cursor: pointer; border-radius: 4px;}

    table {width: 100%; border-collapse: collapse; min-width: 1000px;}
    th {background: #f8f9fa; padding: 12px; text-align: right; border-bottom: 2px solid #ddd; position: sticky; top: 0;}
    td {padding: 10px 12px; border-bottom: 1px solid #eee; vertical-align: middle;}
    .table-responsive {overflow-x: auto; max-height: 600px;}

    .tbl-input {width: 80px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; text-align: center;}
    
    .badge {padding: 4px 10px; border-radius: 12px; font-size: 0.8em; font-weight: bold;}
    .badge-premium {background: #d4edda; color: #155724; border: 1px solid #c3e6cb;} 
    .badge-base {background: #fff3cd; color: #856404; border: 1px solid #ffeeba;} 
    .badge-pending {background: #fdeaea; color: #c0392b; border: 1px solid #f5c6cb;}
    
    .stats {display: flex; gap: 20px; margin-bottom: 20px;}
    .card {background: var(--p); color: #fff; padding: 15px; border-radius: 10px; flex: 1; text-align: center;}
    .card-val {font-size: 1.5em; font-weight: bold;}
</style>
</head>
<body>

<div class="box">
    <div class="tabs-header">
        <button class="tab-btn active" onclick="switchTab('main')"><i class="fas fa-check-circle"></i> البونص المستحق</button>
        <button class="tab-btn" onclick="switchTab('suspended')"><i class="fas fa-clock"></i> الفواتير المعلقة (آجل)</button>
        <button class="tab-btn" onclick="switchTab('products')"><i class="fas fa-tags"></i> إعدادات الأسعار</button>
        <button class="tab-btn" onclick="switchTab('targets')"><i class="fas fa-bullseye"></i> التارجت</button>
    </div>

    <div id="tab-main" class="tab-content active">
        <div style="display:flex; gap:15px; align-items:flex-end; margin-bottom:20px; flex-wrap:wrap;">
            <div class="input-grp">
                <label>المندوب</label>
                <select id="creatorFilter" onchange="renderMainTable()"><option value="all">الكل</option></select>
            </div>
            <div class="input-grp">
                <label>الشهر</label>
                <input type="month" id="targetMonth">
            </div>
            <button onclick="fetchAndCalculate()" class="calc-btn"><i class="fas fa-sync-alt"></i> تحديث وحساب</button>
            <button onclick="exportToExcel()" class="save-btn" style="background:#27ae60"><i class="fas fa-file-excel"></i> تصدير</button>
        </div>

        <div class="stats">
            <div class="card"><h3>مبيعات (مدفوعة/كاش)</h3><div id="stat-sales" class="card-val">0</div></div>
            <div class="card" style="background:var(--acc)"><h3>البونص النهائي</h3><div id="stat-bonus" class="card-val">0</div></div>
            <div class="card" style="background:#e67e22"><h3>حالة التارجت</h3><div id="stat-target" class="card-val">-</div></div>
        </div>

        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>تحكم</th>
                        <th>المرجع</th>
                        <th>المندوب</th>
                        <th>المنتج</th>
                        <th>الكمية</th>
                        <th>سعر البيع</th>
                        <th>تصنيف السعر</th>
                        <th>النسبة</th>
                        <th>البونص</th>
                    </tr>
                </thead>
                <tbody id="mainRows"><tr><td colspan="9" style="text-align:center">اضغط تحديث</td></tr></tbody>
            </table>
        </div>
    </div>

    <div id="tab-suspended" class="tab-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; background:#fff3cd; padding:15px; border-radius:8px; border:1px solid #ffeeba; color:#856404;">
            <div>
                <i class="fas fa-info-circle"></i> <strong>الفواتير المعلقة:</strong>
                هذه الفواتير إما "آجلة لم تسدد بعد" أو قمت باستثنائها يدوياً.
                <br> لن يتم صرف البونص الخاص بها حتى تتحول حالتها إلى <b>Paid</b>.
            </div>
            <div style="text-align:center">
                <small>بونص "متوقع" معلق</small>
                <div id="stat-suspended-bonus" style="font-size:1.5em; font-weight:bold;">0.00</div>
            </div>
        </div>

        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>إجراء</th>
                        <th>المرجع</th>
                        <th>المندوب</th>
                        <th>المنتج</th>
                        <th>الحالة</th>
                        <th>النوع</th>
                        <th>البونص المتوقع</th>
                    </tr>
                </thead>
                <tbody id="suspendedRows"><tr><td colspan="7" style="text-align:center">لا توجد فواتير معلقة</td></tr></tbody>
            </table>
        </div>
    </div>

    <div id="tab-products" class="tab-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <h3><i class="fas fa-sliders-h"></i> إعدادات شرائح الأسعار</h3>
            <button onclick="saveProductSettings()" class="save-btn"><i class="fas fa-save"></i> حفظ الإعدادات</button>
        </div>
        <div class="table-responsive">
            <table id="productsTable">
                <thead>
                    <tr>
                        <th style="width:20%">المنتج</th>
                        <th style="background:#fff3cd">عدد (بالكرتون)</th>
                        <th style="background:#d4edda; border:2px solid #27ae60">سعر التميز</th>
                        <th>نسبة التميز %</th>
                        <th style="background:#eee">السعر الأساسي</th>
                        <th>النسبة الأساسية %</th>
                    </tr>
                </thead>
                <tbody id="productRows"><tr><td colspan="6">انتظار البيانات...</td></tr></tbody>
            </table>
        </div>
    </div>

    <div id="tab-targets" class="tab-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <h3><i class="fas fa-users-cog"></i> التارجت والمكافآت</h3>
            <button onclick="saveTargetSettings()" class="save-btn"><i class="fas fa-save"></i> حفظ التارجت</button>
        </div>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>المندوب</th>
                        <th>المبيعات الحالية (المعتمدة)</th>
                        <th style="background:#eafaf1">مبلغ التارجت</th>
                        <th style="background:#eafaf1">مكافأة التحقيق</th>
                        <th style="background:#fdeaea; color:#c0392b">تفعيل الحجب؟</th>
                        <th>الحالة</th>
                    </tr>
                </thead>
                <tbody id="targetRows"><tr><td colspan="6">انتظار البيانات...</td></tr></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const DELAYED_SKU = "754500950512";
    const DELAYED_KEYWORD = "آجلة"; 
    
    // البيانات
    let rawInvoices = [], productsMap = {}, computedData = [], suspendedData = [], creatorsList = [];
    let unitsMap = {};
    
    // الإعدادات
    let productRules = JSON.parse(localStorage.getItem('productRules_v7') || "{}");
    let targetRules = JSON.parse(localStorage.getItem('targetRules_v7') || "{}");
    let manualExclusions = JSON.parse(localStorage.getItem('manualExclusions_v7') || "[]");

    window.onload = () => {
        document.getElementById('targetMonth').value = new Date().toISOString().slice(0, 7);
        if(Object.keys(productRules).length > 0) renderProductSettings();
    }

    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + id).classList.add('active');
        document.querySelector(`button[onclick="switchTab('${id}')"]`).classList.add('active');
    }

    async function fetchAndCalculate() {
        const btn = document.querySelector('.calc-btn');
        btn.innerHTML = '...'; btn.disabled = true;
        try {
            const res = await fetch('/api/get-data');
            if(!res.ok) throw new Error("API Error");
            const data = await res.json();
            
            rawInvoices = data.invoices || [];
            productsMap = data.productsMap || {};
            
            if(data.product_units) {
                 data.product_units.forEach(u => {
                     unitsMap[u.id] = parseFloat(u.conversion_factor || u.representation || 1);
                 });
            }

            creatorsList = [...new Set(rawInvoices.map(i => i.created_by).filter(Boolean))];
            updateCreatorsDropdown();
            
            calculateAll();
            renderProductSettings();
            renderTargetSettings();
            
            btn.innerHTML = '<i class="fas fa-sync-alt"></i> تحديث وحساب';
        } catch(e) { alert(e.message); btn.innerHTML = 'تحديث'; } finally { btn.disabled = false; }
    }

    function calculateAll() {
        computedData = [];
        suspendedData = [];
        const tDate = document.getElementById('targetMonth').value;
        const [tYear, tMonth] = tDate.split('-').map(Number);

        rawInvoices.forEach(inv => {
            if(!inv.line_items) return;

            // تحديد هل الفاتورة آجلة/معلقة؟
            let isSystemDelayed = inv.line_items.some(i => i.sku === DELAYED_SKU || (i.product_name && i.product_name.includes(DELAYED_KEYWORD)));
            let isManualExcluded = manualExclusions.includes(inv.id);
            let isDelayed = isSystemDelayed || isManualExcluded;

            // تحديد حالة الاستحقاق
            // تكون مستحقة الآن إذا كانت (كاش) أو (آجلة وتم سدادها في هذا الشهر)
            // وتكون معلقة إذا كانت (آجلة ولم تسدد) أو (تم استثناؤها يدوياً)
            
            let isEligible = false;
            let dateToCheck = new Date(inv.issue_date);

            if (!isDelayed) {
                // فاتورة عادية (كاش) -> مستحقة بتاريخ إصدارها
                isEligible = true;
                dateToCheck = new Date(inv.issue_date);
            } else {
                // فاتورة آجلة أو مستثناة
                if (inv.status === 'Paid') {
                    // مدفوعة -> مستحقة بتاريخ السداد
                    isEligible = true; 
                    dateToCheck = new Date(inv.updated_at || inv.issue_date);
                    // ملاحظة: إذا كانت مستثناة يدوياً، ستبقى غير مستحقة حتى لو دفعت، إلا إذا ألغيت الاستثناء
                    if(isManualExcluded) isEligible = false; 
                } else {
                    // غير مدفوعة -> معلقة
                    isEligible = false;
                    dateToCheck = new Date(inv.issue_date); // للعرض في المعلق نستخدم تاريخ الإصدار
                }
            }

            // فلترة الشهر (للمستحقة والمعلقة لعرض شهر محدد)
            if(dateToCheck.getMonth()+1 !== tMonth || dateToCheck.getFullYear() !== tYear) return;

            inv.line_items.forEach(item => {
                if(item.sku === DELAYED_SKU || (item.product_name && item.product_name.includes(DELAYED_KEYWORD))) return;
                
                const pid = item.product_id;
                const pInfo = productsMap[pid] || { purchase_price: 0, name: item.product_name };
                const rule = productRules[pid] || {};

                // --- الحسابات ---
                let factor = 1;
                if(item.unit_type && unitsMap[item.unit_type]) factor = unitsMap[item.unit_type];
                else if(rule.factor && parseFloat(rule.factor) !== 1) factor = parseFloat(rule.factor);

                const premiumPrice = rule.premiumPrice ? parseFloat(rule.premiumPrice) : 0;
                const basePrice = rule.basePrice ? parseFloat(rule.basePrice) : 0;
                const premiumPct = rule.premiumPct !== undefined ? rule.premiumPct : 2;
                const basePct = rule.basePct !== undefined ? rule.basePct : 1;

                const sell = parseFloat(item.unit_price);
                const total = sell * parseFloat(item.quantity);
                const unitCost = parseFloat(pInfo.purchase_price) * factor;

                let appliedPct = 0;
                let typeClass = "أقل من الأساسي";
                let badgeClass = "badge-low";

                let isCartonContext = (factor > 1 && sell > (unitCost * 0.5));

                if (isCartonContext || factor === 1) {
                    if (premiumPrice > 0 && sell >= premiumPrice) {
                        appliedPct = premiumPct;
                        typeClass = "تميز (Premium)";
                        badgeClass = "badge-premium";
                    } else if (basePrice > 0 && sell >= basePrice) {
                        appliedPct = basePct;
                        typeClass = "أساسي (Base)";
                        badgeClass = "badge-base";
                    } else if (premiumPrice === 0 && basePrice === 0 && sell > unitCost) {
                        appliedPct = basePct; typeClass = "عادي (تلقائي)"; badgeClass = "badge-base";
                    }
                } else {
                    typeClass = "وحدة صغيرة";
                    appliedPct = basePct;
                }
                
                const bonusVal = total * (appliedPct/100);

                const record = {
                    invId: inv.id, ref: inv.reference, creator: inv.created_by, status: inv.status,
                    prod: item.product_name, qty: item.quantity, sell: sell, class: typeClass, badge: badgeClass,
                    pct: appliedPct, bonus: bonusVal, total: total, isManual: isManualExcluded
                };

                if (isEligible) {
                    computedData.push(record);
                } else {
                    suspendedData.push(record);
                }
            });
        });
        
        renderMainTable();
        renderSuspendedTable();
        renderTargetSettings();
    }

    function renderMainTable() {
        const tbody = document.getElementById('mainRows');
        tbody.innerHTML = '';
        const filter = document.getElementById('creatorFilter').value;
        const filtered = computedData.filter(d => filter === 'all' || d.creator === filter);

        let totalSales = filtered.reduce((a,b)=>a+b.total,0);
        let totalBonus = filtered.reduce((a,b)=>a+b.bonus,0);
        let targetMsg = "بدون تارجت";
        let isBlocked = false;

        if(filter !== 'all') {
            const tr = targetRules[filter] || {amount:0, reward:0, block:false};
            if(tr.amount > 0) {
                if(totalSales >= tr.amount) {
                    totalBonus += tr.reward;
                    targetMsg = "✅ تم التحقيق (+" + tr.reward + ")";
                } else {
                    targetMsg = "❌ فشل";
                    if(tr.block) {
                        isBlocked = true;
                        totalBonus = 0;
                        targetMsg += " (محجوب)";
                    }
                }
            }
        }

        document.getElementById('stat-sales').innerText = totalSales.toLocaleString();
        document.getElementById('stat-bonus').innerText = totalBonus.toLocaleString();
        document.getElementById('stat-target').innerText = targetMsg;

        if(filtered.length === 0) { tbody.innerHTML='<tr><td colspan="9" style="text-align:center">لا بيانات مستحقة</td></tr>'; return; }

        filtered.forEach(r => {
            let exBtn = `<button class="exclude-btn" onclick="toggleExclusion(${r.invId})">استثناء</button>`;
            let bonusTxt = isBlocked ? `<span style="text-decoration:line-through; color:red">${r.bonus.toFixed(2)}</span>` : r.bonus.toFixed(2);
            
            tbody.innerHTML += `<tr>
                <td>${exBtn}</td>
                <td>${r.ref}</td><td>${r.creator}</td>
                <td style="font-size:0.9em">${r.prod}</td>
                <td>${r.qty}</td>
                <td><b>${r.sell}</b></td>
                <td><span class="badge ${r.badge}">${r.class}</span></td>
                <td>${r.pct}%</td>
                <td style="font-weight:bold; color:var(--acc)">${bonusTxt}</td>
            </tr>`;
        });
    }

    function renderSuspendedTable() {
        const tbody = document.getElementById('suspendedRows');
        tbody.innerHTML = '';
        const filter = document.getElementById('creatorFilter').value;
        const filtered = suspendedData.filter(d => filter === 'all' || d.creator === filter);
        
        let totalSuspended = filtered.reduce((a,b)=>a+b.bonus,0);
        document.getElementById('stat-suspended-bonus').innerText = totalSuspended.toLocaleString();

        if(filtered.length === 0) { tbody.innerHTML='<tr><td colspan="7" style="text-align:center">لا توجد فواتير معلقة</td></tr>'; return; }

        filtered.forEach(r => {
            // زر لإعادة الفاتورة إذا كانت مستثناة يدوياً
            let actionBtn = "";
            if (r.isManual) {
                actionBtn = `<button class="restore-btn" onclick="toggleExclusion(${r.invId})"><i class="fas fa-undo"></i> إعادة</button>`;
            } else {
                actionBtn = `<span style="font-size:0.8em; color:#777">آجل نظام</span>`;
            }

            let reason = r.isManual ? "مستثنى يدوياً" : (r.status === 'Paid' ? "مدفوعة (آجل)" : "غير مدفوعة");

            tbody.innerHTML += `<tr>
                <td>${actionBtn}</td>
                <td>${r.ref}</td><td>${r.creator}</td>
                <td style="font-size:0.9em">${r.prod}</td>
                <td><span class="badge badge-pending">${reason}</span></td>
                <td><span class="badge ${r.badge}">${r.class}</span></td>
                <td style="font-weight:bold; color:#c0392b">${r.bonus.toFixed(2)}</td>
            </tr>`;
        });
    }

    function toggleExclusion(id) {
        if(manualExclusions.includes(id)) manualExclusions = manualExclusions.filter(x=>x!==id);
        else manualExclusions.push(id);
        localStorage.setItem('manualExclusions_v7', JSON.stringify(manualExclusions));
        calculateAll();
    }

    // دوال المنتجات والتارجت والإكسل (نفس السابق)
    function renderProductSettings() {
        const tbody = document.getElementById('productRows');
        tbody.innerHTML = '';
        Object.keys(productsMap).forEach(pid => {
            const p = productsMap[pid];
            const r = productRules[pid] || {};
            const factor = r.factor || 1;
            const pp = r.premiumPrice || 0;
            const bp = r.basePrice || 0;
            const ppct = r.premiumPct !== undefined ? r.premiumPct : 2;
            const bpct = r.basePct !== undefined ? r.basePct : 1;
            
            tbody.innerHTML += `<tr>
                <td style="text-align:right">${p.name}</td>
                <td><input type="number" class="tbl-input" id="f_${pid}" value="${factor}" step="1" style="background:#fffcf5"></td>
                <td><input type="number" class="tbl-input" id="pp_${pid}" value="${pp}" style="border:2px solid #27ae60"></td>
                <td><input type="number" class="tbl-input" id="pct1_${pid}" value="${ppct}"></td>
                <td><input type="number" class="tbl-input" id="bp_${pid}" value="${bp}" style="background:#eee"></td>
                <td><input type="number" class="tbl-input" id="pct2_${pid}" value="${bpct}"></td>
            </tr>`;
        });
    }

    function saveProductSettings() {
        Object.keys(productsMap).forEach(pid => {
            productRules[pid] = {
                factor: parseFloat(document.getElementById(`f_${pid}`).value)||1,
                premiumPrice: parseFloat(document.getElementById(`pp_${pid}`).value)||0,
                basePrice: parseFloat(document.getElementById(`bp_${pid}`).value)||0,
                premiumPct: parseFloat(document.getElementById(`pct1_${pid}`).value)||0,
                basePct: parseFloat(document.getElementById(`pct2_${pid}`).value)||0
            };
        });
        localStorage.setItem('productRules_v7', JSON.stringify(productRules));
        alert('تم الحفظ');
        calculateAll();
    }

    function renderTargetSettings() {
        const tbody = document.getElementById('targetRows');
        tbody.innerHTML = '';
        creatorsList.forEach(c => {
            const r = targetRules[c] || {amount:0, reward:0, block:false};
            const sales = computedData.filter(d => d.creator === c).reduce((a,b)=>a+b.total,0);
            let status = (r.amount>0 && sales>=r.amount) ? '✅' : '❌';
            tbody.innerHTML += `<tr>
                <td><b>${c}</b></td>
                <td>${sales.toLocaleString()}</td>
                <td><input type="number" class="tbl-input" id="ta_${c}" value="${r.amount}"></td>
                <td><input type="number" class="tbl-input" id="tr_${c}" value="${r.reward}"></td>
                <td style="text-align:center"><input type="checkbox" id="tb_${c}" ${r.block?'checked':''}></td>
                <td>${status}</td>
            </tr>`;
        });
    }

    function saveTargetSettings() {
        creatorsList.forEach(c => {
            targetRules[c] = {
                amount: parseFloat(document.getElementById(`ta_${c}`).value)||0,
                reward: parseFloat(document.getElementById(`tr_${c}`).value)||0,
                block: document.getElementById(`tb_${c}`).checked
            };
        });
        localStorage.setItem('targetRules_v7', JSON.stringify(targetRules));
        alert('تم الحفظ');
        calculateAll();
    }

    function updateCreatorsDropdown() {
        const s = document.getElementById('creatorFilter');
        const v = s.value;
        s.innerHTML = '<option value="all">الكل</option>';
        creatorsList.forEach(c => s.innerHTML += `<option value="${c}">${c}</option>`);
        s.value = v;
    }

    async function exportToExcel() {
        const wb = new ExcelJS.Workbook();
        const ws = wb.addWorksheet('Earned_Bonus');
        ws.addRow(['المرجع','المندوب','المنتج','الكمية','سعر البيع','التصنيف','النسبة','البونص']);
        computedData.forEach(d => ws.addRow([d.ref, d.creator, d.prod, d.qty, d.sell, d.class, d.pct+'%', d.bonus]));
        
        const ws2 = wb.addWorksheet('Suspended_Invoices');
        ws2.addRow(['المرجع','المندوب','المنتج','الحالة','البونص المتوقع']);
        suspendedData.forEach(d => ws2.addRow([d.ref, d.creator, d.prod, d.status, d.bonus]));

        const buf = await wb.xlsx.writeBuffer();
        saveAs(new Blob([buf]), 'Bonus_Report_Complete.xlsx');
    }
</script>
</body>
</html>
