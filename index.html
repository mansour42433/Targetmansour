<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>نظام التقرير الشامل - نسخة الاحترافية</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root{--p:#2980b9;--d:#2c3e50;--r:#c0392b;--g:#27ae60;--o:#f39c12;--bg:#f4f6f9; --pending:#8e44ad; --adj:#16a085;}
        body{font-family:'Cairo', sans-serif; background:var(--bg); padding:20px; color: var(--d); padding-bottom: 120px;}
        .container { max-width: 1600px; margin: auto; }
        
        /* شريط الأدوات */
        .toolbar { background: #fff; padding: 20px; border-radius: 12px; display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.9rem; }
        .form-control { padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: 'Cairo'; width: 220px; }
        
        .btn { padding: 10px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-family: 'Cairo'; color: #fff; transition: 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--p); }
        .btn-success { background: var(--g); }

        /* شريط التقدم */
        .progress-box { display: none; margin-bottom: 25px; background: #fff; padding: 25px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .steps { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .step { flex: 1; color: #ccc; font-size: 0.85rem; }
        .step.active { color: var(--p); font-weight: bold; }
        .step i { display: block; font-size: 1.4rem; margin-bottom: 5px; }

        /* البطاقات الإحصائية */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-right: 5px solid var(--p); }
        .stat-card h3 { font-size: 0.9rem; color: #7f8c8d; margin: 0; }
        .stat-card p { font-size: 1.8rem; font-weight: bold; margin: 5px 0 0 0; }

        /* التبويبات والجداول */
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav-btn { background: #e0e0e0; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-family: 'Cairo'; font-weight: bold; }
        .nav-btn.active { background: var(--p); color: #fff; }
        .box { background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .box-header { background: var(--d); color: #fff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 15px; text-align: right; border-bottom: 2px solid #eee; }
        td { padding: 12px 15px; border-bottom: 1px solid #eee; }
        
        .product-row { cursor: pointer; }
        .details-row { display: none; background: #fcfcfc; }
        .sub-table th { background: #eee; font-size: 0.85rem; color: #555; }
        
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; color: #fff; }
        .bg-gold { background: var(--o); }
        .bg-silver { background: #95a5a6; }
    </style>
</head>
<body>

<div class="container">
    <div class="stats-grid">
        <div class="stat-card" style="border-color: var(--p);"><h3>إجمالي البونص</h3><p id="totalBonus">0.00</p></div>
        <div class="stat-card" style="border-color: var(--g);"><h3>المبيعات الصافية</h3><p id="totalSales">0.00</p></div>
        <div class="stat-card" style="border-color: var(--r);"><h3>الفواتير المعالجة</h3><p id="invCount">0</p></div>
    </div>

    <div class="toolbar">
        <div class="form-group">
            <label>شهر التحصيل (تاريخ الدفع)</label>
            <input type="month" id="targetMonth" class="form-control">
        </div>
        <div class="form-group">
            <label>المندوب</label>
            <select id="repFilter" class="form-control" onchange="renderReport()"><option value="all">الكل</option></select>
        </div>
        <button class="btn btn-primary" onclick="startFetching()"><i class="fas fa-sync-alt"></i> جلب البيانات ومزامنتها</button>
        <button class="btn btn-success" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> تصدير إكسل</button>
    </div>

    <div class="progress-box" id="progressBox">
        <div class="steps">
            <div class="step" id="step1"><i class="fas fa-box"></i>المنتجات</div>
            <div class="step" id="step2"><i class="fas fa-ruler"></i>الوحدات</div>
            <div class="step" id="step3"><i class="fas fa-file-invoice"></i>الفواتير (آخر 4 أشهر)</div>
            <div class="step" id="step4"><i class="fas fa-calculator"></i>المعالجة النهائية</div>
        </div>
        <div id="loadingText" style="font-weight: bold; color: var(--p);">جاري التحضير...</div>
    </div>

    <div class="nav-tabs">
        <button class="nav-btn active" id="tabReport" onclick="switchTab('report')">تقرير البونص</button>
        <button class="nav-btn" id="tabSettings" onclick="switchTab('settings')">إعدادات التحويل والأهداف</button>
    </div>

    <div id="report" class="tab-content">
        <div class="box">
            <div class="box-header"><h3><i class="fas fa-list"></i> مبيعات المنتجات (اضغط للمزيد)</h3></div>
            <div id="reportContainer" style="padding: 20px; text-align: center; color: #999;">يرجى جلب البيانات للبدء...</div>
        </div>
    </div>

    <div id="settings" class="tab-content" style="display:none;">
        <div class="box">
            <div class="box-header"><h3><i class="fas fa-cogs"></i> تخصيص القواعد</h3><button class="btn btn-success" onclick="saveSettings()">حفظ الإعدادات</button></div>
            <div style="padding: 20px;"><table id="settingsTable"><thead><tr><th>المنتج</th><th>هدف 2% (سعر)</th><th>المعامل</th><th>التحويل</th></tr></thead><tbody id="settingsBody"></tbody></table></div>
        </div>
    </div>
</div>

<script>
let DB = { products: [], invoices: [], units: {}, returns: {} };
let ReportData = [];
let Settings = JSON.parse(localStorage.getItem('Bonus_Config_V3') || '{}');

function switchTab(id) {
    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(id).style.display = 'block';
    document.getElementById('tab' + id.charAt(0).toUpperCase() + id.slice(1)).classList.add('active');
}

async function startFetching() {
    const pBox = document.getElementById('progressBox');
    const lText = document.getElementById('loadingText');
    pBox.style.display = 'block';

    try {
        updateStep(1, "جاري جلب قائمة المنتجات...");
        const pRes = await fetch('/api/data.js?type=products');
        const pData = await pRes.json(); DB.products = pData.data || [];

        updateStep(2, "جاري جلب وحدات القياس...");
        const uRes = await fetch('/api/data.js?type=units');
        const uData = await uRes.json(); (uData.data || []).forEach(u => DB.units[u.id] = u.name_ar || u.name_en);

        updateStep(3, "جاري جلب الفواتير (بناءً على تاريخ الإنشاء)...");
        const iRes = await fetch('/api/data.js?type=invoices');
        const iData = await iRes.json(); DB.invoices = iData.data || [];

        const rRes = await fetch('/api/data.js?type=returns');
        const rData = await rRes.json(); (rData.data || []).forEach(cn => {
            if(cn.invoice_reference) {
                if(!DB.returns[cn.invoice_reference]) DB.returns[cn.invoice_reference] = [];
                DB.returns[cn.invoice_reference].push(cn);
            }
        });

        updateStep(4, "جاري مطابقة تاريخ الدفع والحساب...");
        renderSettingsTable();
        processLogic();
        pBox.style.display = 'none';
    } catch (e) { lText.innerHTML = `<span style="color:red">خطأ: ${e.message}</span>`; }
}

function updateStep(n, t) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById(`step${n}`).classList.add('active');
    document.getElementById('loadingText').innerText = t;
}

function processLogic() {
    ReportData = [];
    const tMonth = document.getElementById('targetMonth').value;
    const [tY, tM] = tMonth.split('-');

    DB.products.forEach(p => {
        const conf = Settings[p.id] || { threshold: 0, factor: 1, mode: 'none' };
        let pSales = 0, pBonus = 0, pInvs = [];

        DB.invoices.forEach(inv => {
            // ✅ الفلترة حسب تاريخ الدفع (آخر تحديث)
            if (!inv.payment_date) return;
            const [pY, pM] = inv.payment_date.split('-');
            if (pY !== tY || pM !== tM) return;

            const items = inv.line_items || inv.inventory_items || inv.invoice_items || [];
            items.forEach(item => {
                if (String(item.product_id) === String(p.id)) {
                    let qty = parseFloat(item.quantity) || 0;
                    if (DB.returns[inv.reference]) {
                        DB.returns[inv.reference].forEach(cn => {
                            (cn.line_items || cn.inventory_items || []).forEach(ci => {
                                if (String(ci.product_id) === String(p.id)) qty -= parseFloat(ci.quantity) || 0;
                            });
                        });
                    }
                    if (qty <= 0) return;

                    let fQty = qty;
                    if (conf.mode === 'div' && conf.factor > 0) fQty = qty / conf.factor;
                    else if (conf.mode === 'mul') fQty = qty * conf.factor;

                    let price = parseFloat(item.unit_price) || 0;
                    if (conf.mode === 'div' && conf.factor > 0) price *= conf.factor;

                    let total = fQty * price;
                    let rate = (conf.threshold > 0 && price >= conf.threshold) ? 2 : 1;
                    let bonus = (total * rate) / 100;

                    pInvs.push({ ref: inv.reference, rep: inv.creator, date: inv.payment_date, qty: fQty, price, total, rate, bonus });
                    pSales += total; pBonus += bonus;
                }
            });
        });

        if (pInvs.length > 0) ReportData.push({ id: p.id, name: p.name_ar || p.name_en, sales: pSales, bonus: pBonus, invs: pInvs });
    });
    renderReport();
}

function renderReport() {
    const cont = document.getElementById('reportContainer');
    const repF = document.getElementById('repFilter').value;
    
    let allReps = new Set();
    ReportData.forEach(p => p.invs.forEach(i => allReps.add(i.rep)));
    const sel = document.getElementById('repFilter');
    if(sel.options.length === 1) [...allReps].sort().forEach(r => sel.innerHTML += `<option value="${r}">${r}</option>`);

    let html = `<table><thead><tr><th>المنتج</th><th>العمليات</th><th>إجمالي المبيعات</th><th>إجمالي البونص</th></tr></thead><tbody>`;
    let gSales = 0, gBonus = 0, gInv = 0;

    ReportData.forEach(p => {
        let vInvs = repF === 'all' ? p.invs : p.invs.filter(i => i.rep === repF);
        if (vInvs.length === 0) return;

        let s = vInvs.reduce((a,b) => a + b.total, 0), b = vInvs.reduce((a,b) => a + b.bonus, 0);
        gSales += s; gBonus += b; gInv += vInvs.length;

        html += `<tr class="product-row" onclick="toggleDetails(${p.id})"><td><i class="fas fa-chevron-left" id="icon_${p.id}"></i> ${p.name}</td><td>${vInvs.length}</td><td>${s.toLocaleString()}</td><td style="color:var(--g);font-weight:bold;">${b.toLocaleString()}</td></tr>
        <tr id="details_${p.id}" class="details-row"><td colspan="4"><table class="sub-table"><thead><tr><th>المرجع</th><th>المندوب</th><th>التاريخ</th><th>الكمية</th><th>السعر</th><th>الإجمالي</th><th>بونص</th></tr></thead><tbody>
        ${vInvs.map(i => `<tr><td>${i.ref}</td><td>${i.rep}</td><td>${i.date}</td><td>${i.qty.toFixed(2)}</td><td>${i.price.toFixed(2)}</td><td>${i.total.toFixed(2)}</td><td><span class="badge ${i.rate===2?'bg-gold':'bg-silver'}">${i.bonus.toFixed(2)}</span></td></tr>`).join('')}
        </tbody></table></td></tr>`;
    });

    cont.innerHTML = html + `</tbody></table>`;
    document.getElementById('totalSales').innerText = gSales.toLocaleString();
    document.getElementById('totalBonus').innerText = gBonus.toLocaleString();
    document.getElementById('invCount').innerText = gInv;
}

function toggleDetails(id) {
    const row = document.getElementById(`details_${id}`);
    const icon = document.getElementById(`icon_${id}`);
    row.style.display = row.style.display === 'table-row' ? 'none' : 'table-row';
    icon.style.transform = row.style.display === 'table-row' ? 'rotate(-90deg)' : 'rotate(0deg)';
}

function renderSettingsTable() {
    const body = document.getElementById('settingsBody'); body.innerHTML = '';
    DB.products.sort((a,b) => (a.name_ar||"").localeCompare(b.name_ar||"")).forEach(p => {
        const c = Settings[p.id] || { threshold: 0, factor: 0, mode: 'none' };
        body.innerHTML += `<tr><td>${p.name_ar || p.name_en}</td><td><input type="number" id="thr_${p.id}" value="${c.threshold}" class="form-control" style="width:80px"></td><td><input type="number" id="fac_${p.id}" value="${c.factor}" class="form-control" style="width:80px"></td><td><select id="mod_${p.id}" class="form-control" style="width:110px"><option value="none" ${c.mode==='none'?'selected':''}>بدون</option><option value="div" ${c.mode==='div'?'selected':''}>قسمة (حبة->ك)</option><option value="mul" ${c.mode==='mul'?'selected':''}>ضرب (ك->حبة)</option></select></td></tr>`;
    });
}

function saveSettings() {
    DB.products.forEach(p => {
        const t = document.getElementById(`thr_${p.id}`);
        if(t) Settings[p.id] = { threshold: parseFloat(t.value) || 0, factor: parseFloat(document.getElementById(`fac_${p.id}`).value) || 0, mode: document.getElementById(`mod_${p.id}`).value };
    });
    localStorage.setItem('Bonus_Config_V3', JSON.stringify(Settings)); alert("تم الحفظ."); processLogic();
}

async function exportToExcel() {
    const wb = new ExcelJS.Workbook(); const ws = wb.addWorksheet('البونص');
    ws.columns = [{header:'المنتج',key:'p'},{header:'المرجع',key:'r'},{header:'المندوب',key:'m'},{header:'التاريخ',key:'d'},{header:'الكمية',key:'q'},{header:'الإجمالي',key:'t'},{header:'البونص',key:'b'}];
    ws.getRow(1).font = {bold:true};
    ReportData.forEach(p => p.invs.forEach(i => ws.addRow({p:p.name, r:i.ref, m:i.rep, d:i.date, q:i.qty, t:i.total, b:i.bonus})));
    const buf = await wb.xlsx.writeBuffer(); saveAs(new Blob([buf]), 'Bonus_Report.xlsx');
}
</script>
</body>
</html>
