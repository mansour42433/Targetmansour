<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>نظام البونص – الإصدار المنضبط</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<style>
body{font-family:Cairo;background:#f4f6f9;padding:20px}
.box{background:#fff;border-radius:12px;max-width:1500px;margin:auto;padding:20px}
.tabs{display:flex;gap:10px;margin-bottom:20px}
.tabs button{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:bold}
.tabs button.active{background:#2c3e50;color:#fff}
table{width:100%;border-collapse:collapse;margin-top:15px}
th,td{padding:10px;border-bottom:1px solid #ddd;text-align:right}
th{background:#f1f1f1}
.badge{padding:4px 10px;border-radius:20px;font-size:12px}
.ok{background:#d4edda;color:#155724}
.no{background:#f8d7da;color:#721c24}
</style>
</head>
<body>

<div class="box">

<div class="tabs">
<button onclick="tab('main')" class="active" id="btn-main">البونص المستحق</button>
<button onclick="tab('excluded')" id="btn-excluded">الفواتير المستبعدة</button>
</div>

<div>
شهر الحساب:
<input type="month" id="targetMonth">
<button onclick="fetchData()">جلب البيانات</button>
</div>

<!-- البونص -->
<div id="main">
<table>
<thead>
<tr>
<th>المرجع</th><th>المندوب</th><th>المنتج</th>
<th>الكمية</th><th>سعر الكرتون</th>
<th>النسبة</th><th>البونص</th><th>تاريخ السداد</th>
</tr>
</thead>
<tbody id="mainRows"></tbody>
</table>
</div>

<!-- المستبعد -->
<div id="excluded" style="display:none">
<table>
<thead>
<tr>
<th>المرجع</th><th>الحالة</th><th>السبب</th>
</tr>
</thead>
<tbody id="excludedRows"></tbody>
</table>
</div>

</div>

<script>
let rawInvoices = [];
let computed = [];
let excluded = [];

function tab(id){
document.getElementById('main').style.display = id==='main'?'block':'none';
document.getElementById('excluded').style.display = id==='excluded'?'block':'none';
document.getElementById('btn-main').classList.toggle('active',id==='main');
document.getElementById('btn-excluded').classList.toggle('active',id==='excluded');
}

async function fetchData(){
const m = document.getElementById('targetMonth').value;
if(!m) return alert("اختر الشهر");

const res = await fetch(`/api/get-data?month=${m}`);
const data = await res.json();
rawInvoices = data.invoices || [];
processLogic();
}

function processLogic(){
computed = [];
excluded = [];

const [Y,M] = document.getElementById('targetMonth').value.split('-').map(Number);

rawInvoices.forEach(inv=>{
/* ❌ استبعاد الدفع الجزئي */
if(inv.status === 'Partially Paid'){
excluded.push({ref:inv.reference,st:inv.status,rs:'دفع جزئي'});
return;
}

let paidDate = null;

/* الآجل → حسب تاريخ السداد */
if(inv.payments && inv.payments.length){
paidDate = new Date(inv.payments[inv.payments.length-1].date);
}

/* نقدي */
if(!paidDate){
paidDate = new Date(inv.issue_date);
}

if(paidDate.getMonth()+1 !== M || paidDate.getFullYear() !== Y){
excluded.push({ref:inv.reference,st:inv.status,rs:'خارج شهر الحساب'});
return;
}

/* حساب البنود */
inv.line_items.forEach(it=>{
const priceWithTax = it.unit_price * (1 + (it.tax_percent||0)/100);
const cartonPrice = priceWithTax;
const pct = cartonPrice >= 70 ? 2 : 1;
const bonus = priceWithTax * it.quantity * pct / 100;

computed.push({
ref:inv.reference,
rep:inv.created_by,
prod:it.product_name,
qty:it.quantity,
price:cartonPrice,
pct,
bonus,
date:paidDate.toISOString().slice(0,10)
});
});
});

render();
}

function render(){
const m = document.getElementById('mainRows');
const e = document.getElementById('excludedRows');
m.innerHTML = '';
e.innerHTML = '';

computed.forEach(r=>{
m.innerHTML += `
<tr>
<td>${r.ref}</td><td>${r.rep}</td><td>${r.prod}</td>
<td>${r.qty}</td><td>${r.price.toFixed(2)}</td>
<td><span class="badge ok">${r.pct}%</span></td>
<td>${r.bonus.toFixed(2)}</td><td>${r.date}</td>
</tr>`;
});

excluded.forEach(r=>{
e.innerHTML += `
<tr>
<td>${r.ref}</td><td>${r.st}</td>
<td><span class="badge no">${r.rs}</span></td>
</tr>`;
});
}
</script>

</body>
</html>